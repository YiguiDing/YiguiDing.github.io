<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.0" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.12" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://dingdingdang.online/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><meta property="og:site_name" content="Yigui-Ding的Blog小站"><meta property="og:title" content="《游戏设计模式》学习笔记"><meta property="og:description" content="《游戏设计模式(game-programming-patterns)》学习笔记"><meta property="og:type" content="article"><meta property="og:image" content="https://dingdingdang.online/cover/gameprogrammingpatterns.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-01-25T15:48:59.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="《游戏设计模式》学习笔记"><meta property="article:author" content="丁毅桂"><meta property="article:tag" content="笔记"><meta property="article:tag" content="游戏"><meta property="article:tag" content="设计模式"><meta property="article:published_time" content="2023-12-13T13:21:00.000Z"><meta property="article:modified_time" content="2024-01-25T15:48:59.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"《游戏设计模式》学习笔记","image":["https://dingdingdang.online/cover/gameprogrammingpatterns.png"],"datePublished":"2023-12-13T13:21:00.000Z","dateModified":"2024-01-25T15:48:59.000Z","author":[{"@type":"Person","name":"丁毅桂","email":"2449695354@qq.com"}]}</script><meta name="baidu-site-verification" content="codeva-PwE9Ts6nMl"><link rel="icon" href="/images/favicon_icon.jpg"><link rel="icon" href="/images/favicon_icon.jpg" type="image/png" sizes="192x192"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/images/favicon_icon.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/images/favicon_icon.jpg"><meta name="msapplication-TileColor" content="#46bd87"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><link rel="alternate" type="application/rss+xml" href="https://dingdingdang.online/rss.xml" title="Yigui-Ding的Blog小站 RSS Feed"><title>《游戏设计模式》学习笔记 | Yigui-Ding的Blog小站</title><meta name="description" content="《游戏设计模式(game-programming-patterns)》学习笔记">
    <link rel="preload" href="/assets/style-3l_B90uk.css" as="style"><link rel="stylesheet" href="/assets/style-3l_B90uk.css">
    <link rel="modulepreload" href="/assets/app-yNXCeZQw.js"><link rel="modulepreload" href="/assets/index.html-sMCWnuyR.js"><link rel="modulepreload" href="/assets/index.html-pzH5hV9F.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><!----><!----><span class="vp-site-name">Yigui-Ding的Blog小站</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="主页" class="vp-link nav-link nav-link" href="/"><span class="font-icon icon fa-fw fa-sm fas fa-house-chimney" style=""></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="笔记"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>笔记</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="前端" class="vp-link nav-link nav-link" href="/%E5%89%8D%E7%AB%AF/"><span class="font-icon icon fa-fw fa-sm fas fa-code" style=""></span>前端<!----></a></li><li class="dropdown-item"><a aria-label="后端" class="vp-link nav-link nav-link" href="/%E5%90%8E%E7%AB%AF/"><span class="font-icon icon fa-fw fa-sm fas fa-server" style=""></span>后端<!----></a></li><li class="dropdown-item"><a aria-label="算法" class="vp-link nav-link nav-link" href="/%E7%AE%97%E6%B3%95/"><span class="font-icon icon fa-fw fa-sm fas fa-diagram-project" style=""></span>算法<!----></a></li><li class="dropdown-item"><a aria-label="电子" class="vp-link nav-link nav-link" href="/%E7%94%B5%E5%AD%90/"><span class="font-icon icon fa-fw fa-sm fas fa-bolt" style=""></span>电子<!----></a></li><li class="dropdown-item"><a aria-label="理论" class="vp-link nav-link active nav-link active" href="/%E7%90%86%E8%AE%BA/"><span class="font-icon icon fa-fw fa-sm fas fa-book-bookmark" style=""></span>理论<!----></a></li><li class="dropdown-item"><a aria-label="工具" class="vp-link nav-link nav-link" href="/%E5%B7%A5%E5%85%B7/"><span class="font-icon icon fa-fw fa-sm fas fa-screwdriver-wrench" style=""></span>工具<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a aria-label="随笔" class="vp-link nav-link nav-link" href="/%E9%9A%8F%E7%AC%94/"><span class="font-icon icon fa-fw fa-sm fas fa-note-sticky" style=""></span>随笔<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="计划" class="vp-link nav-link nav-link" href="/%E8%AE%A1%E5%88%92/"><span class="font-icon icon fa-fw fa-sm fas fa-list-check" style=""></span>计划<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="项目" class="vp-link nav-link nav-link" href="/%E9%A1%B9%E7%9B%AE/"><span class="font-icon icon fa-fw fa-sm fas fa-box" style=""></span>项目<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="友链" class="vp-link nav-link nav-link" href="/%E7%BD%91%E7%AB%99/%E5%8F%8B%E9%93%BE.html"><span class="font-icon icon fa-fw fa-sm fas fa-user-group" style=""></span>友链<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="关于" class="vp-link nav-link nav-link" href="/%E7%BD%91%E7%AB%99/%E5%85%B3%E4%BA%8E.html"><span class="font-icon icon fa-fw fa-sm fas fa-address-card" style=""></span>关于<!----></a></div></nav><!----><!----><div class="nav-item hide-in-mobile"><button type="button" class="outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">23种设计模式学习笔记</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">2023 12 13 游戏设计模式学习笔记</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a aria-label="《游戏设计模式》学习笔记" class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active nav-link active vp-sidebar-link vp-sidebar-page active" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><!---->《游戏设计模式》学习笔记<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="目录" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#目录"><!---->目录<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="前言：架构，性能和游戏" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#前言-架构-性能和游戏"><!---->前言：架构，性能和游戏<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="重访设计模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#重访设计模式"><!---->重访设计模式<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="命令模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#命令模式"><!---->命令模式<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="享元模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#享元模式"><!---->享元模式<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="观察者模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#观察者模式"><!---->观察者模式<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="原型模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#原型模式"><!---->原型模式<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="单例模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#单例模式"><!---->单例模式<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="状态模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#状态模式"><!---->状态模式<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="序列模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#序列模式"><!---->序列模式<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="双缓冲模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#双缓冲模式"><!---->双缓冲模式<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="行为模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#行为模式"><!---->行为模式<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="类型对象（Type Object）" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#类型对象-type-object"><!---->类型对象（Type Object）<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="解耦模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#解耦模式"><!---->解耦模式<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="组件模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#组件模式"><!---->组件模式<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="事件队列" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#事件队列"><!---->事件队列<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="服务定位器" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#服务定位器"><!---->服务定位器<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="优化模式" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#优化模式"><!---->优化模式<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="数据局部性" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/%E7%90%86%E8%AE%BA/2023-12-13-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#数据局部性"><!---->数据局部性<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">2023 12 15 实现简易编译器和解释器</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">2023 12 20 使用递归下降算法实现简易解释器</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">2023 12 23 【编译原理】重写笔记</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">设计模式学习笔记( Java版)</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">设计模式学习笔记( Type Script版)</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><div class="page-cover"><img src="/cover/gameprogrammingpatterns.png" alt no-view></div><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->《游戏设计模式》学习笔记</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">丁毅桂</span></span><span property="author" content="丁毅桂"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-12-13T13:21:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 58 分钟</span><meta property="timeRequired" content="PT58M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category8 clickable" role="navigation">笔记</span><!--]--><meta property="articleSection" content="笔记"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag8 clickable" role="navigation">笔记</span><span class="page-tag-item tag8 clickable" role="navigation">游戏</span><span class="page-tag-item tag2 clickable" role="navigation">设计模式</span><!--]--><meta property="keywords" content="笔记,游戏,设计模式"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#目录">目录</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#前言-架构-性能和游戏">前言：架构，性能和游戏</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#重访设计模式">重访设计模式</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#命令模式">命令模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#享元模式">享元模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#观察者模式">观察者模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#原型模式">原型模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#单例模式">单例模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#状态模式">状态模式</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#序列模式">序列模式</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#双缓冲模式">双缓冲模式</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#行为模式">行为模式</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#类型对象-type-object">类型对象（Type Object）</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#解耦模式">解耦模式</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#组件模式">组件模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#事件队列">事件队列</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#服务定位器">服务定位器</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#优化模式">优化模式</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#数据局部性">数据局部性</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="《游戏设计模式-game-programming-patterns-》学习笔记" tabindex="-1"><a class="header-anchor" href="#《游戏设计模式-game-programming-patterns-》学习笔记" aria-hidden="true">#</a> 《游戏设计模式（game-programming-patterns）》学习笔记</h1><p><img src="/assets/gameprogrammingpatterns-TsZlqRgJ.png" alt=""></p><h2 id="目录" tabindex="-1"><a class="header-anchor" href="#目录" aria-hidden="true">#</a> 目录</h2><ul><li><a href="#%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8Fgame-programming-patterns%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">《游戏设计模式（game-programming-patterns）》学习笔记</a><ul><li><a href="#%E7%9B%AE%E5%BD%95">目录</a></li><li><a href="#%E5%89%8D%E8%A8%80%E6%9E%B6%E6%9E%84%E6%80%A7%E8%83%BD%E5%92%8C%E6%B8%B8%E6%88%8F">前言：架构，性能和游戏</a></li><li><a href="#%E9%87%8D%E8%AE%BF%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">重访设计模式</a><ul><li><a href="#%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F">命令模式</a><ul><li><a href="#%E9%85%8D%E7%BD%AE%E8%BE%93%E5%85%A5">配置输入</a></li><li><a href="#%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F%E6%94%B9%E5%86%99%E4%BC%98%E5%8C%96">使用命令模式改写优化</a></li><li><a href="#%E5%92%8C%E7%8E%A9%E5%AE%B6%E8%A7%A3%E8%80%A6">和玩家解耦</a></li><li><a href="#%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F%E5%AE%8C%E6%88%90%E6%92%A4%E9%94%80%E6%93%8D%E4%BD%9C">通过命令模式完成撤销操作</a></li><li><a href="#%E5%AF%B9%E5%A4%9A%E9%87%8D%E6%92%A4%E9%94%80%E6%93%8D%E4%BD%9C%E7%9A%84%E6%94%AF%E6%8C%81">对多重撤销操作的支持</a></li><li><a href="#%E9%97%AD%E5%8C%85%E5%87%BD%E6%95%B0%E4%B8%8E%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F">闭包函数与命令模式</a></li></ul></li><li><a href="#%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F">享元模式</a><ul><li><a href="#%E4%BD%BF%E7%94%A8%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F%E6%9D%A5%E8%8A%82%E7%9C%81%E5%86%85%E5%AD%98">使用享元模式来节省内存</a></li><li><a href="#%E5%9C%B0%E5%BD%A2%E7%94%9F%E6%88%90">地形生成</a></li></ul></li><li><a href="#%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F">观察者模式</a><ul><li><a href="#%E6%88%90%E5%B0%B1%E8%A7%A3%E9%94%81">成就解锁</a></li></ul></li><li><a href="#%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F">原型模式</a><ul><li><a href="#%E6%80%AA%E7%89%A9%E7%94%9F%E4%BA%A7%E8%80%85">怪物生产者</a></li><li><a href="#%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F%E9%87%8D%E6%9E%84">使用原型模式重构</a></li></ul></li><li><a href="#%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F">单例模式</a></li><li><a href="#%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F">状态模式</a><ul><li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F">为什么要用状态模式？</a></li><li><a href="#%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BAfsms">有限状态机FSMs</a></li><li><a href="#%E5%B9%B6%E5%8F%91%E7%8A%B6%E6%80%81%E6%9C%BA">并发状态机</a></li><li><a href="#%E5%88%86%E5%B1%82%E7%8A%B6%E6%80%81%E6%9C%BA">分层状态机</a></li></ul></li></ul></li><li><a href="#%E5%BA%8F%E5%88%97%E6%A8%A1%E5%BC%8F">序列模式</a><ul><li><a href="#%E5%8F%8C%E7%BC%93%E5%86%B2%E6%A8%A1%E5%BC%8F">双缓冲模式</a></li></ul></li><li><a href="#%E8%A1%8C%E4%B8%BA%E6%A8%A1%E5%BC%8F">行为模式</a><ul><li><a href="#%E7%B1%BB%E5%9E%8B%E5%AF%B9%E8%B1%A1type-object">类型对象（Type Object）</a><ul><li><a href="#%E4%BB%8Ejson%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%8A%A0%E8%BD%BD%E5%B9%B6%E6%9E%84%E5%BB%BA%E7%89%A9%E7%A7%8D">从JSON配置中加载并构建物种</a></li></ul></li></ul></li><li><a href="#%E8%A7%A3%E8%80%A6%E6%A8%A1%E5%BC%8F">解耦模式</a><ul><li><a href="#%E7%BB%84%E4%BB%B6%E6%A8%A1%E5%BC%8F">组件模式</a></li><li><a href="#%E4%BA%8B%E4%BB%B6%E9%98%9F%E5%88%97">事件队列</a></li><li><a href="#%E6%9C%8D%E5%8A%A1%E5%AE%9A%E4%BD%8D%E5%99%A8">服务定位器</a></li></ul></li><li><a href="#%E4%BC%98%E5%8C%96%E6%A8%A1%E5%BC%8F">优化模式</a><ul><li><a href="#%E6%95%B0%E6%8D%AE%E5%B1%80%E9%83%A8%E6%80%A7">数据局部性</a><ul><li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B0%E6%8D%AE%E5%B1%80%E9%83%A8%E6%80%A7">什么是数据局部性？</a></li><li><a href="#%E4%B8%8D%E8%80%83%E8%99%91%E6%95%B0%E6%8D%AE%E5%B1%80%E9%83%A8%E6%80%A7%E5%AF%BC%E8%87%B4%E5%BD%B1%E5%93%8D%E6%80%A7%E8%83%BD%E7%9A%84%E6%A1%88%E4%BE%8B">不考虑数据局部性导致影响性能的案例</a></li><li><a href="#%E8%80%83%E8%99%91%E6%95%B0%E6%8D%AE%E5%B1%80%E9%83%A8%E6%80%A7%E7%9A%84%E4%BC%98%E5%8C%96%E6%96%B9%E6%B3%95%E4%BD%BF%E7%94%A8%E6%95%B0%E7%BB%84">考虑数据局部性的优化方法：使用数组</a></li><li><a href="#%E8%80%83%E8%99%91%E6%95%B0%E6%8D%AE%E5%B1%80%E9%83%A8%E6%80%A7%E7%9A%84%E4%BC%98%E5%8C%96%E6%96%B9%E6%B3%95%E6%89%93%E5%8C%85%E6%95%B0%E6%8D%AE">考虑数据局部性的优化方法：打包数据</a></li></ul></li></ul></li></ul></li></ul><h2 id="前言-架构-性能和游戏" tabindex="-1"><a class="header-anchor" href="#前言-架构-性能和游戏" aria-hidden="true">#</a> 前言：架构，性能和游戏</h2><p><strong>关于架构</strong></p><ul><li>本书是讨论的是如何组织代码的，或者说是关于架构的</li><li><mark>“程序都有一定架构”</mark> ， <mark>“将所有东西都塞到main()中”</mark> 也是一种架构</li><li>架构好坏的评判： <mark>“评价架构设计的好坏就是评价它应对改动有多么轻松。”</mark></li></ul><p><strong>关于解耦</strong></p><ul><li>两块代码是耦合的， 意味着需要阅读理解两块代码</li><li>如果解耦了它们俩，就可以单独地只阅读理解其中一个部分</li><li><mark>“软件架构的关键目标： 最小化在编写代码前需要了解的信息。”</mark></li><li>解耦的目标： <ul><li><mark>“当一块代码有改动时，不需要修改另一块代码。”</mark> (或者说需要修改的代码很少)</li><li><mark>“耦合程度越小，改动会波及的范围就越小。”</mark></li></ul></li></ul><p><strong>追求完美架构的代价</strong></p><ul><li>维持好的游戏架构，使其可扩展、可维护、低耦合，需要花费大量精力。</li><li>无限制的在代码中引入接口、抽象、虚函数，可能最后不仅毫无用处，甚至可能会污染代码，不要提前优化，提前假设某处未来可能会有功能扩展。</li></ul><p><strong>开发的灵活性与运行的高效性</strong></p><ul><li><mark>“ 让代码更灵活的许多模式依靠虚拟调度、 接口、 指针、 消息和其他机制， 它们都会加大运行时开销。”</mark></li><li>为了让程序高效的执行，可以 <mark>“保持代码灵活直到确定设计，再去除抽象层来提高性能。”</mark></li></ul><p><strong>糟糕代码的优势</strong></p><ul><li><mark>“编写架构良好的代码需要仔细地思考，这会消耗时间。”</mark></li><li><mark>“原型——一坨勉强拼凑在一起，只能完成某个点子的简单代码。”</mark> 可以节约时间。</li><li>原型代码看上去能工作，但不能被维护，必须重写</li></ul><p><strong>关于平衡</strong></p><ul><li>保持代码可读性，需要好的架构。</li><li>保证代码执行效率,需要好的优化。</li><li>需要快速将需求实现</li><li>这些目标至少是部分对立的: <ul><li>好的架构长期来看提高了生产力， 也意味着每个改动都需要消耗更多努力保持代码整洁。</li><li>高度优化的代码不灵活，很难改动。</li><li>如果尽可能快地实现特性， 代码库就会充满黑魔法，漏洞和混乱，阻碍未来的产出。</li></ul></li><li>没有简单的答案，只有权衡。</li></ul><h2 id="重访设计模式" tabindex="-1"><a class="header-anchor" href="#重访设计模式" aria-hidden="true">#</a> 重访设计模式</h2><blockquote><p>这里部分主要讨论《设计模式：可复用面向对象软件的基础》中某些设计模式在游戏中的具体应用</p></blockquote><h3 id="命令模式" tabindex="-1"><a class="header-anchor" href="#命令模式" aria-hidden="true">#</a> 命令模式</h3><h4 id="配置输入" tabindex="-1"><a class="header-anchor" href="#配置输入" aria-hidden="true">#</a> 配置输入</h4><p>一个用命令模式优化的案例</p><p><img src="/assets/command-buttons-one-ISQA56lH.png" alt=""></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 这个函数通常在游戏循环中每帧调用一次</span>
<span class="token keyword">function</span> <span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_X</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">jump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_Y</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">fireGun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_A</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">swapWeapon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_B</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">lurchIneffectively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">缺点</p><ul><li>用户的输入和程序行为硬编码在一起了,</li><li>这导致无法让玩家自定义按键的功能。</li></ul></div><h4 id="使用命令模式改写优化" tabindex="-1"><a class="header-anchor" href="#使用命令模式改写优化" aria-hidden="true">#</a> 使用命令模式改写优化</h4><blockquote><p><strong>为了支持玩家配置按键的功能</strong>，可以使用命令模式，<br> 将这些对jump()和fireGun()的直接调用转化为<mark>可替换</mark>的东西。</p></blockquote><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-437-0" aria-selected="false">定义Command</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-437-1" aria-selected="false">定义Command子类</button><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-437-2" aria-selected="true">重写输入处理</button></div><!--[--><div class="vp-tab" id="tab-437-0" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">定义Command</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 定义基类代表可触发的游戏行为</span>
<span class="token keyword">interface</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-437-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">定义Command子类</div><!--[--><p>然后我们为不同的游戏行为定义相应的子类：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">JumpCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">jump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">FireCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fireGun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab active" id="tab-437-2" role="tabpanel" aria-expanded="true"><div class="vp-tab-title">重写输入处理</div><!--[--><p>在代码的输入处理部分，为每个按键存储一个命令。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">InputHandler</span> <span class="token punctuation">{</span>
  <span class="token comment">// 绑定命令的方法……</span>
   buttonX_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JumpCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   buttonY_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FireCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   buttonA_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">swapWeaponCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   buttonB_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">lurchIneffectivelyCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 现在输入处理部分这样处理：</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_X</span><span class="token punctuation">)</span><span class="token punctuation">)</span> buttonX_<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_Y</span><span class="token punctuation">)</span><span class="token punctuation">)</span> buttonY_<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_A</span><span class="token punctuation">)</span><span class="token punctuation">)</span> buttonA_<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_B</span><span class="token punctuation">)</span><span class="token punctuation">)</span> buttonB_<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样，相比于之前的硬编码导致每个输入直接调用函数，现在可以修改按键实际所执行的操作：</p><p><img src="/assets/command-buttons-two-qb4-rdxn.png" alt></p><!--]--></div><!--]--></div><h4 id="和玩家解耦" tabindex="-1"><a class="header-anchor" href="#和玩家解耦" aria-hidden="true">#</a> 和玩家解耦</h4><blockquote><p>之前的写法其实是假设在execute()函数能够直接操作玩家<br> 现在要进一步解耦，使得命令可以操作除玩家自己之外的角色</p></blockquote><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Player player<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在，可以使用这个类让游戏中的任何角色跳来跳去了。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">JumpCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Player player<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        player<span class="token punctuation">.</span><span class="token function">jump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改handleInput()，让它可以返回命令：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">InputHandler</span> <span class="token punctuation">{</span>
  <span class="token comment">// 绑定命令的方法……</span>
  buttonX_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JumpCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buttonY_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FireCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buttonA_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">swapWeaponCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buttonB_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">lurchIneffectivelyCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Command <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_X</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> buttonX_<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_Y</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> buttonY_<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_A</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> buttonA_<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_B</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> buttonB_<span class="token punctuation">;</span>
    <span class="token comment">// 没有按下任何按键，就什么也不做</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以让玩家控制游戏中的任何角色，只需向命令传入不同的角色。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>Command cmd <span class="token operator">=</span> inputHandler<span class="token punctuation">.</span><span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cmd <span class="token operator">&amp;&amp;</span> cmd<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>现在玩家和AI可以使用相同的命令；AI代码只需生成Command对象。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Player</span><span class="token punctuation">{</span>
    <span class="token function">update</span><span class="token punctuation">(</span>dt<span class="token operator">:</span><span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Command cmd <span class="token operator">=</span> inputHandler<span class="token punctuation">.</span><span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cmd <span class="token operator">&amp;&amp;</span> cmd<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name"><span class="token constant">AI</span></span><span class="token punctuation">{</span>
    <span class="token function">update</span><span class="token punctuation">(</span>dt<span class="token operator">:</span><span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Command cmd <span class="token operator">=</span> <span class="token function">getNextCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cmd <span class="token operator">&amp;&amp;</span> cmd<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过命令流，解耦消费者和生产者。</p><ul><li>控制器或者AI，产生一系列命令放入流中</li><li>调度器或者角色自身，调用并消耗命令</li></ul><p><img src="/assets/command-stream-c-hUqarA.png" alt=""></p><h4 id="通过命令模式完成撤销操作" tabindex="-1"><a class="header-anchor" href="#通过命令模式完成撤销操作" aria-hidden="true">#</a> 通过命令模式完成撤销操作</h4><p>一个可以实现撤销操作的案例代码</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">MoveUnitCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span>
<span class="token punctuation">{</span>
  Unit unit_<span class="token punctuation">;</span>
  int x_<span class="token punctuation">,</span> y_<span class="token punctuation">,</span>xBefore_<span class="token punctuation">,</span>yBefore_<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>Unit unit<span class="token punctuation">,</span> int x<span class="token punctuation">,</span> int y<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 记录被操作的对象</span>
    unit_ <span class="token operator">=</span> unit<span class="token punctuation">;</span>
    <span class="token comment">// 记录目标位置</span>
    x_ <span class="token operator">=</span> x<span class="token punctuation">;</span>
    y_ <span class="token operator">=</span> y<span class="token punctuation">;</span>
    <span class="token comment">// 记录当前位置</span>
    xBefore_ <span class="token operator">=</span> unit_<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    yBefore_ <span class="token operator">=</span> unit_<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    unit_<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>x_<span class="token punctuation">,</span> y_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 撤销操作</span>
    unit_<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>xBefore_<span class="token punctuation">,</span> yBefore_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>Command <span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  Unit unit <span class="token operator">=</span> <span class="token function">getSelectedUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_UP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 向上移动单位</span>
    int destY <span class="token operator">=</span> unit<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MoveUnitCommand</span><span class="token punctuation">(</span>unit<span class="token punctuation">,</span> unit<span class="token punctuation">.</span>x<span class="token punctuation">,</span> destY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_DOWN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 向下移动单位</span>
    int destY <span class="token operator">=</span> unit<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MoveUnitCommand</span><span class="token punctuation">(</span>unit<span class="token punctuation">,</span> unit<span class="token punctuation">.</span>x<span class="token punctuation">,</span> destY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 其他的移动……</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Command cmd <span class="token operator">=</span> <span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
cmd<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
cmd<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="对多重撤销操作的支持" tabindex="-1"><a class="header-anchor" href="#对多重撤销操作的支持" aria-hidden="true">#</a> 对多重撤销操作的支持</h4><blockquote><p>可以用于游戏地图、关卡编辑器</p></blockquote><p>支持多重的撤销也不太难。 我们不单单记录最后一条指令，还要记录指令列表，然后用一个引用指向 “当前” 的那个。 当玩家执行一条命令，我们将其添加到列表，然后将代表 “当前” 的指针指向它。</p><p><img src="/assets/command-undo-AXEpcUPw.png" alt=""></p><h4 id="闭包函数与命令模式" tabindex="-1"><a class="header-anchor" href="#闭包函数与命令模式" aria-hidden="true">#</a> 闭包函数与命令模式</h4><blockquote><p>在某种程度上说，命令模式是为一些没有闭包的语言模拟闭包。</p></blockquote><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">makeMoveUnitCommand</span><span class="token punctuation">(</span>unit<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> xBefore<span class="token punctuation">,</span> yBefore<span class="token punctuation">;</span>
  <span class="token comment">// 这里返回的就是一个命令对象</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      xBefore <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      yBefore <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      unit<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">undo</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      unit<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>xBefore<span class="token punctuation">,</span> yBefore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>Command <span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  Unit unit <span class="token operator">=</span> <span class="token function">getSelectedUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token constant">BUTTON_UP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 向上移动单位</span>
    int destY <span class="token operator">=</span> unit<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">makeMoveUnitCommand</span><span class="token punctuation">(</span>unit<span class="token punctuation">,</span> unit<span class="token punctuation">.</span>x<span class="token punctuation">,</span> destY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Command cmd <span class="token operator">=</span> <span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
cmd<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
cmd<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="享元模式" tabindex="-1"><a class="header-anchor" href="#享元模式" aria-hidden="true">#</a> 享元模式</h3><blockquote><p>这个部分的内容，个人感觉，总结成一句话，就是要把游戏中的某些相同的对象的共有的不变的属性抽取出来，在内存中共用一份，节省内存。</p></blockquote><h4 id="使用享元模式来节省内存" tabindex="-1"><a class="header-anchor" href="#使用享元模式来节省内存" aria-hidden="true">#</a> 使用享元模式来节省内存</h4><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-546-0" aria-selected="true"><strong>一种表示树的方式</strong></button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-546-1" aria-selected="false"><strong>另一种表示方式</strong></button></div><!--[--><div class="vp-tab active" id="tab-546-0" role="tabpanel" aria-expanded="true"><div class="vp-tab-title"><strong>一种表示树的方式</strong></div><!--[--><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">Tree</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span><span class="token operator">:</span>
    Mesh mesh_<span class="token punctuation">;</span>
    Texture bark_<span class="token punctuation">;</span>
    Texture leaves_<span class="token punctuation">;</span>

    Vector position_<span class="token punctuation">;</span>
    <span class="token keyword">double</span> height_<span class="token punctuation">;</span>
    <span class="token keyword">double</span> thickness_<span class="token punctuation">;</span>
    Color barkTint_<span class="token punctuation">;</span>
    Color leafTint_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/assets/flyweight-trees-f2oMb3IZ.png" alt></p><!--]--></div><div class="vp-tab" id="tab-546-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title"><strong>另一种表示方式</strong></div><!--[--><blockquote><p>把共有的部分抽取出来，只在内存中保留一份</p></blockquote><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">TreeModel</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span><span class="token operator">:</span>
    Mesh mesh_<span class="token punctuation">;</span>
    Texture bark_<span class="token punctuation">;</span>
    Texture leaves_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Tree</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span><span class="token operator">:</span>
    TreeModel<span class="token operator">*</span> model_<span class="token punctuation">;</span>

    Vector position_<span class="token punctuation">;</span>
    <span class="token keyword">double</span> height_<span class="token punctuation">;</span>
    <span class="token keyword">double</span> thickness_<span class="token punctuation">;</span>
    Color barkTint_<span class="token punctuation">;</span>
    Color leafTint_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/assets/flyweight-tree-model-PHn6UuFB.png" alt></p><!--]--></div><!--]--></div><h4 id="地形生成" tabindex="-1"><a class="header-anchor" href="#地形生成" aria-hidden="true">#</a> 地形生成</h4><p><strong>定义地形</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">enum</span> Terrain <span class="token punctuation">{</span>
  <span class="token constant">TERRAIN_GRASS</span><span class="token punctuation">,</span>
  <span class="token constant">TERRAIN_HILL</span><span class="token punctuation">,</span>
  <span class="token constant">TERRAIN_RIVER</span><span class="token punctuation">,</span>
  <span class="token comment">// ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>定义地图</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">World</span> <span class="token punctuation">{</span>
  Terrain tiles_<span class="token punctuation">[</span><span class="token constant">WIDTH</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token constant">HEIGHT</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>一种获取移动成本和判断是否是水地的算法</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">World</span> <span class="token punctuation">{</span>
  int <span class="token function">getMovementCost</span><span class="token punctuation">(</span>int x<span class="token punctuation">,</span> int y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>tiles_<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">TERRAIN_GRASS</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">TERRAIN_HILL</span><span class="token operator">:</span>  <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">TERRAIN_RIVER</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他地形……</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  bool <span class="token function">isWater</span><span class="token punctuation">(</span>int x<span class="token punctuation">,</span> int y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>tiles_<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">TERRAIN_GRASS</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">TERRAIN_HILL</span><span class="token operator">:</span>  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">TERRAIN_RIVER</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他地形……</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>优化：定义实际的地形类，使得可以方便的获取移动成本</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Terrain</span>
<span class="token punctuation">{</span>
  int movementCost_<span class="token punctuation">;</span>
  bool isWater_<span class="token punctuation">;</span>
  Texture texture_<span class="token punctuation">;</span>
  <span class="token function">Terrain</span><span class="token punctuation">(</span>int movementCost<span class="token punctuation">,</span>bool isWater<span class="token punctuation">,</span>Texture texture<span class="token punctuation">)</span><span class="token punctuation">{</span>
    movementCost_<span class="token operator">=</span>movementCost<span class="token punctuation">;</span>
    isWater_<span class="token operator">=</span>isWater<span class="token punctuation">;</span>
    texture_<span class="token operator">=</span>texture<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  int <span class="token function">getMovementCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> movementCost_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  bool <span class="token function">isWater</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> isWater_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  Texture <span class="token function">getTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> texture_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一种简单的地形生成算法</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 也可以把这个枚举定义成World的属性,使其生命周期和world保持一致</span>
<span class="token keyword">enum</span> Terrain
<span class="token punctuation">{</span>
  <span class="token constant">TERRAIN_GRASS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">GRASS</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token constant">GRASS_TEXTURE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">TERRAIN_HILL</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">HILL</span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token constant">HILL_TEXTURE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">TERRAIN_RIVER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">RIVER</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token constant">RIVER_TEXTURE</span><span class="token punctuation">)</span>
  <span class="token comment">// ......</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">World</span> <span class="token punctuation">{</span>
  Terrain tiles_<span class="token punctuation">[</span><span class="token constant">WIDTH</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token constant">HEIGHT</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 生成地形</span>
  <span class="token keyword">void</span> <span class="token function">generateTerrain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>int x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token constant">WIDTH</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>int y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> <span class="token constant">HEIGHT</span><span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 加入一些丘陵</span>
          tiles_<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> Terrain<span class="token punctuation">.</span><span class="token constant">TERRAIN_HILL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 将地面填满草皮.</span>
          tiles_<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> Terrain<span class="token punctuation">.</span><span class="token constant">TERRAIN_GRASS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 放置河流</span>
    int x <span class="token operator">=</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token constant">WIDTH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>int y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> <span class="token constant">HEIGHT</span><span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tiles_<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> Terrain<span class="token punctuation">.</span><span class="token constant">TERRAIN_RIVER</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用这种方式，World不再与各种地形的细节耦合。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">World</span> <span class="token punctuation">{</span>
  Terrain tiles_<span class="token punctuation">[</span><span class="token constant">WIDTH</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token constant">HEIGHT</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取某个位置的地形</span>
  <span class="token keyword">void</span> <span class="token function">getTile</span><span class="token punctuation">(</span>int x<span class="token punctuation">,</span> int y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> tiles_<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>获取经过某地的成本</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 获取经过某地的成本</span>
int cost <span class="token operator">=</span> world<span class="token punctuation">.</span><span class="token function">getTile</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMovementCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="观察者模式" tabindex="-1"><a class="header-anchor" href="#观察者模式" aria-hidden="true">#</a> 观察者模式</h3><h4 id="成就解锁" tabindex="-1"><a class="header-anchor" href="#成就解锁" aria-hidden="true">#</a> 成就解锁</h4><p>实现一个成就系统，可能需要在触发一些事件后去判断是否可以解锁某些成就，比如在物理引擎的地方判断玩家是否落水，但把解锁某些成就的代码直接夹杂在这些地方可能会导致代码的高耦合不可维护，解决办法就是使用观察者模式来解耦，以下是作者提供的一个案例。</p><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-605-0" aria-selected="true">Physics.ts</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-605-1" aria-selected="false">Subject.ts</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-605-2" aria-selected="false">Achievements.ts</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-605-3" aria-selected="false">Observer.ts</button></div><!--[--><div class="vp-tab active" id="tab-605-0" role="tabpanel" aria-expanded="true"><div class="vp-tab-title">Physics.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Physics</span> <span class="token keyword">extends</span> <span class="token class-name">Subject</span><span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">updateEntity</span><span class="token punctuation">(</span>Entity<span class="token operator">&amp;</span> entity<span class="token punctuation">)</span><span class="token punctuation">{</span>
    bool wasOnSurface <span class="token operator">=</span> entity<span class="token punctuation">.</span><span class="token function">isOnSurface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    entity<span class="token punctuation">.</span><span class="token function">accelerate</span><span class="token punctuation">(</span><span class="token constant">GRAVITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    entity<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bool isOnSurface <span class="token operator">=</span> entity<span class="token punctuation">.</span><span class="token function">isOnSurface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 说明有物体从地表坠入深渊</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wasOnSurface <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isOnSurface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">notify</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> <span class="token constant">EVENT_START_FALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-605-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">Subject.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Subject</span><span class="token punctuation">{</span>
  observers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">void</span> <span class="token function">addObserver</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">{</span> observers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">delObserver</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">{</span> observers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span>Entity entity<span class="token punctuation">,</span> Event event<span class="token punctuation">)</span><span class="token punctuation">{</span>
    observers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
      item <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span><span class="token function">onNotify</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span>event<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-605-2" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">Achievements.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Achievements</span> <span class="token keyword">implements</span> <span class="token class-name">Observer</span><span class="token punctuation">{</span>
  bool heroIsOnBridge_<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">onNotify</span><span class="token punctuation">(</span>Entity entity<span class="token punctuation">,</span> Event event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">EVENT_ENTITY_FELL</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">isHero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> heroIsOnBridge_<span class="token punctuation">)</span>
          <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token constant">ACHIEVEMENT_FELL_OFF_BRIDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">XXX</span><span class="token operator">:</span>
        <span class="token comment">// 处理其他事件，更新heroIsOnBridge_变量……</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span>Achievement achievement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果还没有解锁，那就解锁成就……</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-605-3" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">Observer.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Observer</span><span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">onNotify</span><span class="token punctuation">(</span>Entity entity<span class="token punctuation">,</span> Event event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><!--]--></div><p><strong>总的来说</strong>，就是在物理引擎检测到发生了什么事件之后，调用notify()函数，遍历所有观察者，通知所有观察者这个事件发生了。</p><p><img src="/assets/observer-list-Ho2Wl5Yu.png" alt="images/observer-list.png"></p><p><strong>优点</strong></p><ul><li>不存在比如“事件”，“消息”的概念，没有使用队列，或者为每个通知动态分配内存。</li><li>发送通知只需简单地遍历列表，调用方法。</li></ul><p><strong>缺点</strong></p><ul><li>观察者模式是同步的。 被观察者直接调用了观察者上的方法，这意味着直到所有观察者的通知方法返回后， 被观察者才会继续自己的工作。<mark>观察者会阻塞被观察者的运行</mark>。</li><li>当你有耗时的操作要执行时，应当将这些操作推到另一个线程或工作队列中去。</li><li>需要小心地在观察者中混合线程和锁。 <ul><li>如果观察者试图获得被观察者拥有的锁，游戏就进入死锁了。</li><li>在多线程引擎中，你最好使用事件队列来做异步通信。</li></ul></li></ul><p><strong>“它做了太多动态分配”</strong></p><blockquote><p>观察者列表随着观察者的添加和删除而动态地增长和缩短。 这种内存的分配吓坏了一些人，觉得：“它做了太多动态分配”。<br> 实际上，需要注意的事情是只在观察者加入时分配内存。 发送通知无需内存分配——只需一个方法调用。 如果你在游戏一开始就加入观察者而不乱动它们，分配的总量是很小的。<br> 下面是一种无需任何动态分配的方式来增加和删除观察者的方法。</p></blockquote><p><strong>链式观察者</strong></p><p>单链表结构的链式观察者<br><img src="/assets/observer-linked-ml0DUaQp.png" alt="images/observer-linked.png"></p><p>单链表结构的链式观察者</p><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-689-0" aria-selected="true">Subject.ts</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-689-1" aria-selected="false">Observer.ts</button></div><!--[--><div class="vp-tab active" id="tab-689-0" role="tabpanel" aria-expanded="true"><div class="vp-tab-title">Subject.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Subject</span> <span class="token punctuation">{</span>
  head <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 附加观察者</span>
  <span class="token function">addObserver</span><span class="token punctuation">(</span>Observer observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    observer<span class="token punctuation">.</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>
    head <span class="token operator">=</span> observer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 删除观察者</span>
  <span class="token function">delObserver</span><span class="token punctuation">(</span>Observer observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 删头节点</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>observer<span class="token operator">==</span>head<span class="token punctuation">)</span><span class="token punctuation">{</span>
      head <span class="token operator">=</span> observer<span class="token punctuation">.</span>next
      observer<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 删非头节点</span>
    Observer cur <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>next <span class="token operator">==</span> observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cur<span class="token punctuation">.</span>next <span class="token operator">=</span> observer<span class="token punctuation">.</span>next
        observer<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      cur <span class="token operator">=</span> cur<span class="token punctuation">.</span>next
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 通知</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Observer cur <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cur<span class="token punctuation">.</span><span class="token function">onNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cur <span class="token operator">=</span> cur<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-689-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">Observer.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token function">onNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><!--]--></div><p>双链表结构的链式观察者</p><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-700-0" aria-selected="true">Subject.ts</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-700-1" aria-selected="false">Observer.ts</button></div><!--[--><div class="vp-tab active" id="tab-700-0" role="tabpanel" aria-expanded="true"><div class="vp-tab-title">Subject.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Subject</span><span class="token punctuation">{</span>
  head <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 附加观察者</span>
  <span class="token function">addObserver</span><span class="token punctuation">(</span>Observer observer<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>head<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> head<span class="token punctuation">.</span>prev <span class="token operator">=</span> observer
    observer<span class="token punctuation">.</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>
    head <span class="token operator">=</span> observer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 删除观察者</span>
  <span class="token function">delObserver</span><span class="token punctuation">(</span>Observer observer<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 调整前后两节点的指针</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>observer<span class="token punctuation">.</span>prev<span class="token punctuation">)</span> observer<span class="token punctuation">.</span>prev<span class="token punctuation">.</span>next <span class="token operator">=</span> observer<span class="token punctuation">.</span>next
    <span class="token keyword">if</span><span class="token punctuation">(</span>observer<span class="token punctuation">.</span>next<span class="token punctuation">)</span> observer<span class="token punctuation">.</span>next<span class="token punctuation">.</span>prev <span class="token operator">=</span> observer<span class="token punctuation">.</span>prev
    <span class="token comment">// 处理删除头节点的特殊情况</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>observer<span class="token operator">==</span>head<span class="token punctuation">)</span> head <span class="token operator">=</span> observer<span class="token punctuation">.</span>next
  <span class="token punctuation">}</span>
  <span class="token comment">// 通知</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    Observer cur <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">{</span>
      cur<span class="token punctuation">.</span><span class="token function">onNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cur <span class="token operator">=</span> cur<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-700-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">Observer.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 双链表结构</span>
<span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  prev <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token function">onNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><!--]--></div><div class="hint-container tip"><p class="hint-container-title">链式观察者的缺点</p><p>由于观察者的后继指针是观察者的一个属性，这意味着一个观察者同时只能存在于一条链中，也就是说一个观察者只能观察一个被观察者。</p></div><p><strong>链表节点池</strong></p><blockquote><p>为了解决上述问题，链式观察者的实现方式会使得一个观察者只能观察一个对象，这里的解决方案就是，定义一个链表节点对象，让其指针域指向真正的观察者，这样一个观察者可以被多个节点对象所指，那他就可以在多条链上，就可以观察多个对象。<br> 这样,避免频繁动态分配就变得简单了，现在每个链表节点的大小就是固定的了，可以预先在对象池中分配它们。以便重用、随用随取</p></blockquote><p><img src="/assets/observer-nodes-gCapQIn1.png" alt="images/observer-nodes.png"></p><p><strong>销毁被观察者或观察者对另一半的影响</strong></p><ul><li>使用delete删除观察者后， <ul><li>被观察者想通知观察者时，观察者的地址已经悬空了。</li></ul></li><li>使用delete删除被观察者， <ul><li>观察者可能不保存被观察者的引用，所以影响不大。</li><li>观察者如果仍然保存被观察者的引用，则该地址也悬空了。</li><li>观察者可能不知情，仍然期待收到通知</li></ul></li></ul><p>对于第一种情况，解决的办法就是，观察者在被销毁时，需要把自己从观察者列表中删除。</p><p>对于第二种情况，解决的办法就是，在被观察者销毁时，向所有观察者发送“死亡通知”。</p><ul><li>更安全的方案是在每个被观察者销毁时，让观察者自动取消注册。可以在观察者基类中实现了这个逻辑。这需要在观察者中维护一个被观察者的列表。</li></ul><p>这样就做到了：</p><ul><li>观察者在被销毁时，被观察者要在其所维护的观察者列表中删除它。</li><li>被观察者在被销毁时，观察者要在其所维护的被观察者列表中删除它。</li></ul><p><strong>失效监听者问题</strong></p><p>开发者可能认为自己所使用的语言有垃圾回收机制就不用关心上述问题，实际上，这里原书作者给了一个案例，场景类中有一个UI类，UI类是一个观察者，玩家类是一个被观察者，玩家进入场景，UI类被注册成为玩家类的观察者，玩家受到攻击后，通知UI类更新血量。这看起来没什么问题。<br> 但是如果玩家离开场景，进入新的场景的话，UI类没有取消注册为观察者，那么玩家类就始终保留着上一个场景UI类的引用，那么这些失效的UI类将始终不会被垃圾回收机制清理，玩家的任何状态变化将会发送给这些UI类上。</p><h3 id="原型模式" tabindex="-1"><a class="header-anchor" href="#原型模式" aria-hidden="true">#</a> 原型模式</h3><h4 id="怪物生产者" tabindex="-1"><a class="header-anchor" href="#怪物生产者" aria-hidden="true">#</a> 怪物生产者</h4><p>假设我们游戏中每种怪物都有不同的类——Ghost，Demon，Sorcerer，每种敌人有不同的生产者。</p><p>以下是一种暴力实现方式</p><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-809-0" aria-selected="true">怪物</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-809-1" aria-selected="false">怪物产卵者</button></div><!--[--><div class="vp-tab active" id="tab-809-0" role="tabpanel" aria-expanded="true"><div class="vp-tab-title">怪物</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Ghost</span> <span class="token keyword">extends</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Demon</span> <span class="token keyword">extends</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Sorcerer</span> <span class="token keyword">extends</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-809-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">怪物产卵者</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Spawner</span> <span class="token punctuation">{</span>
  <span class="token function">spawnMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Spawner<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Ghost_Spawner</span> <span class="token keyword">extends</span> <span class="token class-name">Spawner</span> <span class="token punctuation">{</span>
  <span class="token function">spawnMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ghost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Demon_Spawner</span> <span class="token keyword">extends</span> <span class="token class-name">Spawner</span> <span class="token punctuation">{</span>
  <span class="token function">spawnMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Demon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Sorcerer_Spawner</span> <span class="token keyword">extends</span> <span class="token class-name">Spawner</span> <span class="token punctuation">{</span>
  <span class="token function">spawnMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Sorcerer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><!--]--></div><div class="hint-container info"><p class="hint-container-title">这种写法所存在的问题</p><p>众多类，众多引用，众多冗余，众多副本，众多重复自我……</p></div><h4 id="使用原型模式重构" tabindex="-1"><a class="header-anchor" href="#使用原型模式重构" aria-hidden="true">#</a> 使用原型模式重构</h4><p><img src="/assets/prototype-spawner-kA0dhKfc.png" alt=""></p><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-828-0" aria-selected="false">怪物</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-828-1" aria-selected="false">Ghost.ts</button><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-828-2" aria-selected="true">怪物产卵者</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-828-3" aria-selected="false">创建各种生产者</button></div><!--[--><div class="vp-tab" id="tab-828-0" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">怪物</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span>
  <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Monster<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-828-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">Ghost.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Ghost</span> <span class="token keyword">implements</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span>
  health<span class="token punctuation">;</span>
  speed<span class="token punctuation">;</span>
  Ghost <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ghost</span><span class="token punctuation">(</span>health<span class="token punctuation">,</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab active" id="tab-828-2" role="tabpanel" aria-expanded="true"><div class="vp-tab-title">怪物产卵者</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Spawner</span> <span class="token punctuation">{</span>
  self<span class="token operator">:</span> Monster<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>self<span class="token operator">:</span> Monster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>self <span class="token operator">=</span> self<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">spawnMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>self<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-828-3" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">创建各种生产者</div><!--[--><blockquote><p>这种模式就意味着可以创建一个生产者，生产快速鬼魂，虚弱鬼魂，慢速鬼魂，而只需创建一个合适的原型鬼魂。</p></blockquote><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>Spawner ghostSpawner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spawner</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Ghost</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><!--]--></div><!--]--></div><p><strong>编写clone()的痛苦</strong></p><p>这种优化方式虽然不需要为每个怪物创建单独的生产者类了。<br> 但确需要在每个怪物类中实现clone()。 这和使用生产者方法比起来也没节约多少代码量。</p><p>原书作者对这种模式提到了三个问题：</p><ul><li>深拷贝和浅拷贝的问题</li><li>使用这个模式需要以每个怪物拥有独立的类作为前提</li><li>使用庞杂的类层次来组织游戏非常痛苦</li></ul><p>原书内容：</p><blockquote><p>当你坐下来试着写一个正确的clone()，会遇见令人不快的语义漏洞。 做深层拷贝还是浅层拷贝呢？换言之，如果恶魔拿着叉子，克隆恶魔也要克隆叉子吗？</p><p>同时，这看上去没减少已存问题上的代码， 事实上还增添了些人为的问题。 我们需要将每个怪物有独立的类作为前提条件。 这绝对不是当今大多数游戏引擎运作的方法。</p><p>我们中大部分痛苦地学到，这样庞杂的类层次管理起来很痛苦， 那就是我们为什么用组件模式和类型对象为不同的实体建模，这样无需一一建构自己的类。</p></blockquote><p><strong>生产函数的写法</strong></p><blockquote><p>这种写法实际上和上面的差不多</p></blockquote><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-895-0" aria-selected="true">spawnGhost</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-895-1" aria-selected="false">Spawner</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-895-2" aria-selected="false">构建生产者</button></div><!--[--><div class="vp-tab active" id="tab-895-0" role="tabpanel" aria-expanded="true"><div class="vp-tab-title">spawnGhost</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">spawnGhost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ghost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-895-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">Spawner</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Spawner</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> func<span class="token operator">:</span><span class="token builtin">Function</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  Monster <span class="token function">spawnMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-895-2" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">构建生产者</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>Spawner ghostSpawner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spawner</span><span class="token punctuation">(</span>spawnGhost<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><!--]--></div><!--]--></div><p><strong>原型语言范式</strong></p><ul><li>“面向对象编程”和“类”不是同义词</li><li>面向对象的特性是它将状态和行为紧紧地绑在一起。</li><li>但基于类的语言实际将状态和行为割裂开来。</li></ul><p><strong>基于类的面向对象</strong></p><p>基于类的面向对象实际上是把实例对象的状态和方法分来存储的</p><p><img src="/assets/prototype-class-rFOEwFat.png" alt=""></p><p><strong>Self语言</strong></p><blockquote><p>从定义上来说，这是一种比基于类的语言更加面向对象的语言。</p></blockquote><p>Self语言将一个对象的状态和方法绑定在了一起</p><p><img src="/assets/prototype-object-Pqm3UeQ8.png" alt=""></p><p>Self中通过委托来实现继承，一个对象获取一个属性或方法，先在对象内部找，找不到就去父级找，直到没有父对象为止。</p><p><img src="/assets/prototype-delegate-z--S2Pii.png" alt=""></p><p><strong>Self语言的优点</strong></p><ul><li>创建新的实例的方式是使用克隆。</li><li>每个对象都自动支持原型设计模式。</li><li>无需自己实现clone()；就实现了原型模式，原型被内建在系统中。</li></ul><p><strong>在Self语言中创建对象</strong></p><blockquote><p>在Self语言中，就好像每个对象都自动支持原型设计模式。 任何对象都能被克隆。为了获得一堆相似的对象，你：</p><ul><li>将对象塑造成你想要的状态。你可以直接克隆系统内建的基本Object，然后向其中添加字段和方法。</li><li>克隆它来产出……额……随你想要多少就克隆多少个对象。</li></ul></blockquote><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 根据上述论述，我猜写法大概是这样的。</span>
<span class="token keyword">function</span> <span class="token function">creatMyObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  obj<span class="token punctuation">.</span>xxx <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
  obj<span class="token punctuation">.</span><span class="token function-variable function">say</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;say....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> obj1 <span class="token operator">=</span> <span class="token function">creatMyObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> obj2 <span class="token operator">=</span> obj1<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> obj3 <span class="token operator">=</span> obj1<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> obj4 <span class="token operator">=</span> obj1<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>JavaScript</strong></p><blockquote><p>Brendan Eich，JavaScript的缔造者， 从Self语言中直接汲取灵感，很多JavaScript的语义都是基于原型的。</p></blockquote><ul><li>js是有原型的函数，但是没有clone()方法</li><li>每个对象都有属性的集合,这些属性可以是字段也可以是方法</li><li>但实践中，JavaScript更像是基于类的而不是基于原型的语言。</li><li>因为它除去了基于原型语言的核心操作“克隆”。</li></ul><p>在JavaScript中定义类和创建对象的经典方法：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 构造器函数</span>
<span class="token keyword">function</span> <span class="token function">Weapon</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> damage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>range <span class="token operator">=</span> range<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>damage <span class="token operator">=</span> damage<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 在其原型对象上定义方法</span>
Weapon<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">attack</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">distanceTo</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>range<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Out of range!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span>health <span class="token operator">-=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>damage<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> sword <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Weapon</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/assets/prototype-weapon-H3WNunXB.png" alt="images/prototype-weapon.png"></p><p><strong>new 操作所作的事</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// new 操作所作的事</span>
<span class="token keyword">function</span> <span class="token function">myNew</span><span class="token punctuation">(</span>constructor<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建一个空对象</span>
  <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 链接原型链</span>
  obj<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
  <span class="token comment">// 绑定this</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">constructor</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>为数据模型构建原型</strong></p><ul><li>早期的游戏在程序中生成几乎所有东西</li><li>今日的游戏中代码只是驱动游戏的“引擎”，游戏是完全由数据定义的。</li><li>游戏数据达到一定规模时，可以使用原型和委托来重用数据。 <ul><li>可以使用JSON定义数据模型</li><li>可以为对象添加&quot;prototype&quot;字段，记录委托对象的名字。 如果在此对象内没找到一个字段，那就去委托对象中查找。</li></ul></li></ul><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;goblin grunt&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;minHealth&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
  <span class="token property">&quot;maxHealth&quot;</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
  <span class="token property">&quot;resists&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;cold&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;poison&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;weaknesses&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;fire&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;light&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;goblin wizard&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;prototype&quot;</span><span class="token operator">:</span> <span class="token string">&quot;goblin grunt&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 原型</span>
  <span class="token property">&quot;spells&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;fire ball&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lightning bolt&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;goblin archer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;prototype&quot;</span><span class="token operator">:</span> <span class="token string">&quot;goblin grunt&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 原型</span>
  <span class="token property">&quot;attacks&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;short bow&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="单例模式" tabindex="-1"><a class="header-anchor" href="#单例模式" aria-hidden="true">#</a> 单例模式</h3><blockquote><p>这一章作者主要介绍了为什么要避免使用单例模式。</p></blockquote><p><strong>缺点</strong></p><ul><li>单例模式实际上是全局变量， <ul><li>全局变量使得理解代码更加困难</li><li>促进了耦合的发生，比如要完成需求：“岩石撞击地面时播放声音”，新入行的游戏开发者可能会直接在物理引擎中引入Audio单例播放声音，这使得两个不相关的部分耦合了。</li><li>单例全局变量在多线程的环境下可能导致死锁的发生。</li></ul></li><li>惰性加载的单例剥夺了你对游戏性能的控制权：如果初始化一个音频需要几百毫秒，那么这在游戏中造成的延迟会降低玩家的游戏体验。</li></ul><p><strong>有时候你可能不需要名为管理类的各种单例</strong></p><blockquote><p>管理器类有时是有用的，但通常它们只是反映出作者对OOP的不熟悉。</p></blockquote><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-1118-0" aria-selected="true">常见的管理类写法</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-1118-1" aria-selected="false">管理类完全可以被优化掉</button></div><!--[--><div class="vp-tab active" id="tab-1118-0" role="tabpanel" aria-expanded="true"><div class="vp-tab-title">常见的管理类写法</div><!--[--><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">Bullet</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">int</span> <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> y_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">setX</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span> x_ <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">setY</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span> y_ <span class="token operator">=</span> y<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> x_<span class="token punctuation">,</span> y_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">BulletManager</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span><span class="token operator">:</span>
    Bullet<span class="token operator">*</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      Bullet<span class="token operator">*</span> bullet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Bullet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bullet<span class="token operator">-&gt;</span><span class="token function">setX</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      bullet<span class="token operator">-&gt;</span><span class="token function">setY</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> bullet<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> <span class="token function">isOnScreen</span><span class="token punctuation">(</span>Bullet<span class="token operator">&amp;</span> bullet<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">return</span> bullet<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
             bullet<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> SCREEN_WIDTH <span class="token operator">&amp;&amp;</span>
             bullet<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
             bullet<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> SCREEN_HEIGHT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">move</span><span class="token punctuation">(</span>Bullet<span class="token operator">&amp;</span> bullet<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      bullet<span class="token punctuation">.</span><span class="token function">setX</span><span class="token punctuation">(</span>bullet<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-1118-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">管理类完全可以被优化掉</div><!--[--><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">Bullet</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Bullet</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">x_</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y_</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">bool</span> <span class="token function">isOnScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">return</span> x_ <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> x_ <span class="token operator">&lt;</span> SCREEN_WIDTH <span class="token operator">&amp;&amp;</span>
             y_ <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> y_ <span class="token operator">&lt;</span> SCREEN_HEIGHT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> x_ <span class="token operator">+=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> x_<span class="token punctuation">,</span> y_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><!--]--></div><p><strong>将类限制为单一的实例</strong></p><ul><li>上面讨论了单例模式的特性全局访问的缺点。</li><li>下面这种方式通过保证类只被初始化一次来创建单例避免了全局访问，甚至可以是私有的。</li><li>缺点是只在运行时检测</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">FileSystem</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> bool instantiated_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>instantiated_<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;该类只能被初始化一次&quot;</span><span class="token punctuation">)</span>
    instantiated_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    instantiated_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>单例模式其他替代选项</strong></p><blockquote><p>便利的访问是使用单例的一个主要原因。但便利的代价是，在不想要的地方也能轻易使用。</p></blockquote><ol><li><p><strong>作为参数传进来</strong>，大概意思就是 <code>something.update(game,player,ctx);</code></p></li><li><p><strong>把单例放在基类中</strong></p><ul><li>这可以保证其是单例</li><li>还可以实现所有派生类都可以方便的访问到</li><li>还可以保证类之外无法访问</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code> <span class="token keyword">class</span> <span class="token class-name">GameObject</span> <span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token keyword">static</span> Log log_<span class="token punctuation">;</span>
   <span class="token keyword">protected</span> Log <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> log_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">class</span> <span class="token class-name">Enemy</span> <span class="token keyword">extends</span> <span class="token class-name">GameObject</span> <span class="token punctuation">{</span>
   <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;I can log!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>直接从全局获取</strong></p><ul><li>完全移除所有全局变量并不显示</li><li>游戏中总有一些东西是全局可见的。</li><li>可以让现有的全局对象捎带需要的东西，来减少全局变量类的数目。</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Game</span> <span class="token punctuation">{</span>
 <span class="token keyword">static</span> Game instance_<span class="token punctuation">;</span>
 Log         <span class="token operator">*</span>log_<span class="token punctuation">;</span>
 FileSystem  <span class="token operator">*</span>fileSystem_<span class="token punctuation">;</span>
 AudioPlayer <span class="token operator">*</span>audioPlayer_<span class="token punctuation">;</span>
 <span class="token comment">// game是全局可见的单例</span>
 <span class="token keyword">static</span> Game<span class="token operator">&amp;</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> instance_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
 <span class="token comment">// log是非全局可见的单例</span>
 Log<span class="token operator">&amp;</span>         <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">*</span>log_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
 FileSystem<span class="token operator">&amp;</span>  <span class="token function">getFileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">*</span>fileSystem_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
 AudioPlayer<span class="token operator">&amp;</span> <span class="token function">getAudioPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">*</span>audioPlayer_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 只有Game是全局可见的。 函数可以通过它访问其他系统。</span>
Game<span class="token operator">:</span><span class="token operator">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAudioPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token constant">VERY_LOUD_BANG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>从服务定位器中获得。</strong></p><ul><li>另一种选项是定义一个类，存在的唯一目标就是为对象提供全局访问。 这种常见的模式被称为服务定位器模式</li></ul></li></ol><h3 id="状态模式" tabindex="-1"><a class="header-anchor" href="#状态模式" aria-hidden="true">#</a> 状态模式</h3><h4 id="为什么要用状态模式" tabindex="-1"><a class="header-anchor" href="#为什么要用状态模式" aria-hidden="true">#</a> 为什么要用状态模式？</h4><blockquote><p>先看一段冗长的代码</p><ul><li>这种代码比较难维护，需要判断各种特殊情况.</li><li>添加新功能非常困难，修改代码需要理清所有分支的关系来防止bug发生。</li></ul></blockquote><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Heroine</span><span class="token punctuation">{</span>
   <span class="token keyword">void</span> <span class="token function">handleInput</span><span class="token punctuation">(</span>Input input<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 按下B</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">PRESS_B</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 不处于跳跃和卧倒状态（特殊情况判断）</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isJumping_ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isDucking_<span class="token punctuation">)</span><span class="token punctuation">{</span>
          isJumping_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">// 标记为跳跃状态</span>
         <span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_JUMP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">jump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
    <span class="token comment">//  按下卧倒键</span>
     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">PRESS_DOWN</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 判断保证不处于跳跃状态（特殊情况判断）</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isJumping_<span class="token punctuation">)</span><span class="token punctuation">{</span>
         isDucking_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">// 标记为卧倒状态</span>
         <span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_DUCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果处于跳跃状态则切换到下落状态</span>
         isJumping_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
         <span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_DIVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">falling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
    <span class="token comment">//  如果松开卧倒键</span>
     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">RELEASE_DOWN</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 则从卧倒切换到站立状态（特殊情况判断）</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>isDucking_<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 站立……</span>
        <span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_STAND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">stand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="有限状态机fsms" tabindex="-1"><a class="header-anchor" href="#有限状态机fsms" aria-hidden="true">#</a> 有限状态机FSMs</h4><p>如何画流程图</p><p>给英雄每件能做的事情都画了一个盒子：站立，跳跃，俯卧，跳斩。 当角色在能响应按键的状态时，你从那个盒子画出一个箭头，标记上按键，然后连接到她变到的状态。</p><p><img src="/assets/state-flowchart-01OEhS0m.png" alt=""></p><p><strong>状态机的要点</strong></p><ul><li>定义状态机所有可能状态。</li><li>状态机同时只能在一个状态。</li><li>状态机将处理输入。</li><li>根据不同的输入和当前的状态，状态将发生转移。</li></ul><p><strong>枚举和分支</strong></p><p>上面一个案例的错误之处在于把if和各种标识符混在一起了，实际上,结合枚举状态和Switch分支就能改成状态模式,</p><p>这是实现状态机最简单的方法:</p><p><strong>简易状态模式</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">enum</span> State <span class="token punctuation">{</span>
  <span class="token constant">STATE_STANDING</span><span class="token punctuation">,</span>
  <span class="token constant">STATE_JUMPING</span><span class="token punctuation">,</span>
  <span class="token constant">STATE_DUCKING</span><span class="token punctuation">,</span>
  <span class="token constant">STATE_DIVING</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Heroine</span><span class="token punctuation">{</span>

  <span class="token comment">// 当前状态</span>
  state_ <span class="token operator">=</span> State<span class="token punctuation">.</span><span class="token constant">STATE_STANDING</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">handleInput</span><span class="token punctuation">(</span>Input input<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当前处于站立状态</span>
      <span class="token keyword">case</span> <span class="token constant">STATE_STANDING</span><span class="token operator">:</span>
        <span class="token comment">// 处理输入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">PRESS_B</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 切换状态</span>
          state_ <span class="token operator">=</span> <span class="token constant">STATE_JUMPING</span><span class="token punctuation">;</span>
          <span class="token comment">// 进入状态</span>
          yVelocity_ <span class="token operator">=</span> <span class="token constant">JUMP_VELOCITY</span><span class="token punctuation">;</span>
          <span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_JUMP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 处理输入</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">PRESS_DOWN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 切换状态</span>
          state_ <span class="token operator">=</span> <span class="token constant">STATE_DUCKING</span><span class="token punctuation">;</span>
          <span class="token comment">// 进入状态</span>
          <span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_DUCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token constant">STATE_JUMPING</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">PRESS_DOWN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          state_ <span class="token operator">=</span> <span class="token constant">STATE_DIVING</span><span class="token punctuation">;</span>
          <span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_DIVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token constant">STATE_DUCKING</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">RELEASE_DOWN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          state_ <span class="token operator">=</span> <span class="token constant">STATE_STANDING</span><span class="token punctuation">;</span>
          <span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_STAND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>上述写法的不完美之处</strong></p><blockquote><p>考虑一个新的需求，玩家可以在俯卧时充能。</p></blockquote><p><strong>这需要：</strong></p><ol><li>添加一个字段记录充能的时长</li><li>在进入俯卧状态时将字段清空</li><li>在俯卧状态时将字段自增</li><li>在充能完毕后释放技能</li></ol><p>总之，为了增加这个充能攻击的新特性，需要修改添加一个字段，需要修改两个状态的相关代码。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Heroine</span><span class="token punctuation">{</span>

  <span class="token comment">// 当前状态</span>
  state_ <span class="token operator">=</span> State<span class="token punctuation">.</span><span class="token constant">STATE_STANDING</span><span class="token punctuation">;</span>
  <span class="token comment">// 1.添加一个字段记录充能的时长</span>
  chargeTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">handleInput</span><span class="token punctuation">(</span>Input input<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 处于站立状态</span>
      <span class="token keyword">case</span> <span class="token constant">STATE_STANDING</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">PRESS_DOWN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 切换到俯卧状态</span>
          state_ <span class="token operator">=</span> <span class="token constant">STATE_DUCKING</span><span class="token punctuation">;</span>
          <span class="token comment">// 进入俯卧状态</span>
          <span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_DUCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 2. 在进入俯卧状态时将字段清空</span>
          chargeTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// 处于俯卧状态</span>
      <span class="token keyword">case</span> <span class="token constant">STATE_DUCKING</span><span class="token operator">:</span>
        <span class="token comment">// 3. 在俯卧状态时将字段自增</span>
        chargeTime<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chargeTime_ <span class="token operator">&gt;</span> <span class="token constant">MAX_CHARGE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 4. 在充能完毕后释放技能</span>
          <span class="token function">superBomb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">RELEASE_DOWN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          state_ <span class="token operator">=</span> <span class="token constant">STATE_STANDING</span><span class="token punctuation">;</span>
          <span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_STAND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>面向对象的状态设计模式</strong></p><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-1335-0" aria-selected="true">定义状态接口</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-1335-1" aria-selected="false">为每个状态编写类</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-1335-2" aria-selected="false">状态委托</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-1335-3" aria-selected="false">切换状态</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-1335-4" aria-selected="false">进入和离开状态</button></div><!--[--><div class="vp-tab active" id="tab-1335-0" role="tabpanel" aria-expanded="true"><div class="vp-tab-title">定义状态接口</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">PlayerState</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">handleInput</span><span class="token punctuation">(</span>Player player<span class="token punctuation">,</span> Input input<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span>Player player<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-1335-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">为每个状态编写类</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">DuckingState</span> <span class="token keyword">extends</span> <span class="token class-name">PlayerState</span><span class="token punctuation">{</span>
  <span class="token comment">// 将chargeTime放到了DuckingState类中</span>
  chargeTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">handleInput</span><span class="token punctuation">(</span>Player player<span class="token punctuation">,</span> Input input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span>Player player<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chargeTime_<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>chargeTime_ <span class="token operator">&gt;</span> <span class="token constant">MAX_CHARGE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      player<span class="token punctuation">.</span><span class="token function">superBomb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-1335-2" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">状态委托</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 由于只有一个玩家，所以可以写成玩家的全局静态，</span>
<span class="token comment">// 如果有多个玩家，且状态中保存着玩家独有的状态信息，则应当写成玩家类的实例属性,</span>
<span class="token comment">// 否则两个玩家会共享同一个状态信息</span>
<span class="token keyword">enum</span> PlayerState<span class="token punctuation">{</span>
  <span class="token constant">STATE_STANDING</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">standingState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">STATE_JUMPING</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">jumping_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">STATE_DUCKING</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ducking_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">STATE_DIVING</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">diving_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Player</span><span class="token punctuation">{</span>
  PlayerState state_ <span class="token operator">=</span> PlayerState<span class="token punctuation">.</span><span class="token constant">STATE_STANDING</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">handleInput</span><span class="token punctuation">(</span>Input input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 状态委托：把输入交个状态处理</span>
    state_<span class="token punctuation">.</span><span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 状态委托：把更新交个状态来处理</span>
    state_<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-1335-3" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">切换状态</div><!--[--><blockquote><p>如果状态是静态的，可以直接由状态自己切换</p></blockquote><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">DuckingState</span> <span class="token keyword">extends</span> <span class="token class-name">PlayerState</span><span class="token punctuation">{</span>
  <span class="token comment">// 将chargeTime放到了DuckingState类中</span>
  chargeTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">handleInput</span><span class="token punctuation">(</span>Player player<span class="token punctuation">,</span> Input input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">PRESS_B</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 切换贴图</span>
      player<span class="token punctuation">.</span><span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_STAND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 直接切换状态</span>
     player<span class="token punctuation">.</span>state_ <span class="token operator">=</span> PlayerState<span class="token punctuation">.</span><span class="token constant">STATE_JUMPING</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span>Player player<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>如果状态是实例对象的，则需要由Player删除状态，因为状态不能删除自己</p></blockquote><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">DuckingState</span> <span class="token keyword">extends</span> <span class="token class-name">PlayerState</span><span class="token punctuation">{</span>
  <span class="token comment">// 将chargeTime放到了DuckingState类中</span>
  chargeTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  PlayerState <span class="token function">handleInput</span><span class="token punctuation">(</span>Player player<span class="token punctuation">,</span> Input input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">PRESS_B</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 切换贴图</span>
      player<span class="token punctuation">.</span><span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_STAND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 返回要切换到的状态</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">standingState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span>Player player<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Player</span><span class="token punctuation">{</span>
  PlayerState state_ <span class="token operator">=</span> PlayerState<span class="token punctuation">.</span><span class="token constant">STATE_STANDING</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">handleInput</span><span class="token punctuation">(</span>Input input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 状态委托：把输入交个状态处理</span>
    <span class="token keyword">let</span> newState <span class="token operator">=</span> state_<span class="token punctuation">.</span><span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>newState<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> state_<span class="token punctuation">;</span> <span class="token comment">// 删除之前的状态</span>
      state_ <span class="token operator">=</span> newState<span class="token punctuation">;</span> <span class="token comment">// 切换到新的状态</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-1335-4" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">进入和离开状态</div><!--[--><p>状态模式的目标是将状态的行为和数据封装到单一类中。</p><p>现在，当玩家改变状态时，其实也改变他的贴图。但贴图的切换是由前一个状态来完成的，这可以认为是进入该状态所需要完成的一些初始化工作，应当由状态本身来完成，否则如果有多个状态可以切换到同一个状态，那么进入这个状态就所要完成的初始化操作就将散落在别处。</p><p><strong>原先的写法</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">DuckingState</span> <span class="token keyword">extends</span> <span class="token class-name">PlayerState</span><span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">handleInput</span><span class="token punctuation">(</span>Player player<span class="token punctuation">,</span> Input input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">PRESS_B</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 切换贴图</span>
      player<span class="token punctuation">.</span><span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_STAND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 返回要切换到的状态</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">standingState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span>Player player<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>改进</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">StandingState</span> <span class="token keyword">extends</span> <span class="token class-name">PLayerState</span>
<span class="token punctuation">{</span>
  <span class="token comment">// 初始化由状态类来完成</span>
  <span class="token keyword">void</span> <span class="token function">enter</span><span class="token punctuation">(</span>Player player<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    player<span class="token punctuation">.</span><span class="token function">setGraphics</span><span class="token punctuation">(</span><span class="token constant">IMAGE_STAND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">leave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Player</span><span class="token punctuation">{</span>
  PlayerState state_ <span class="token operator">=</span> PlayerState<span class="token punctuation">.</span><span class="token constant">STATE_STANDING</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">handleInput</span><span class="token punctuation">(</span>Input input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> newState <span class="token operator">=</span> state_<span class="token punctuation">.</span><span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>newState<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state_<span class="token punctuation">.</span><span class="token function">leave</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 离开状态 (也许有用吧)</span>
      <span class="token keyword">delete</span> state_<span class="token punctuation">;</span>
      state_ <span class="token operator">=</span> newState<span class="token punctuation">;</span>
      state_<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入状态</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><!--]--></div><h4 id="并发状态机" tabindex="-1"><a class="header-anchor" href="#并发状态机" aria-hidden="true">#</a> 并发状态机</h4><blockquote><p>没有什么是一个状态机解决不了的问题，如果有，那就用两个。</p></blockquote><p>对于每个现有状态，我们需要另一个她持枪状态：站立，持枪站立，跳跃，持枪跳跃，多加几种武器，状态就会指数爆炸。不但增加了大量的状态，也增加了大量的冗余： 持枪和不持枪的状态是完全一样的，只是多了一点负责射击的代码。解决的办法非常简单，再加一个状态。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Player</span> <span class="token punctuation">{</span>
  state_<span class="token operator">:</span> PlayerState<span class="token punctuation">;</span>
  equipment_<span class="token operator">:</span> PlayerState<span class="token punctuation">;</span>
  <span class="token function">handleInput</span><span class="token punctuation">(</span>input<span class="token operator">:</span> Input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state_<span class="token punctuation">.</span><span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    equipment_<span class="token punctuation">.</span><span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">多个状态机之间的交互</p><p>状态有时需要交互。 举个例子，也许她在跳跃时不能开火，或者她在持枪时不能跳斩攻击。 为了完成这个，你可以在状态的代码中做一些粗糙的if测试其他状态来协同，虽然不够优雅，但一定有效。</p></div><h4 id="分层状态机" tabindex="-1"><a class="header-anchor" href="#分层状态机" aria-hidden="true">#</a> 分层状态机</h4><p>分层状态机简单来说就是有父类的状态机，比如说，在地上跑，在地上跳，他们都有一个共同的状态就是在地上，而在地上需要做的更新操作可能包括:玩家受到重力的影响，受到摩擦力的影响而减速。另外可能在地上可以根据输入转换到跳起的状态。这里提到的更新操作和对输入的响应相关的代码应该只有一份而不是多份。而通过继承就可以实现这种代码的复用。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">OnGroundState</span> <span class="token punctuation">{</span>
  <span class="token function">handleInput</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">PRESS_A</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JumpState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">PRESS_B</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SpeedUpState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">gravity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重力影响</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">RunningOnGround</span> <span class="token keyword">extends</span> <span class="token class-name">OnGroundState</span> <span class="token punctuation">{</span>
  <span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token constant">XXX</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SomeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 子类无法响应的输入事件派发给父类完成</span>
      <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleInput</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 交给父类做其所需的更新</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><div class="highlight-line"> </div><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>不一定要使用继承，使用栈也可以实现这种效果，大概来说就是，栈顶元素是当前状态，栈的下层元素就是其直接父类，子类无法处理的输入事件需要派发给父类处理，可能和上面一样，父类也需要做状态更新。</p><p>根据我的理解，暂时可以想到这几种情况状态切换的情况：</p><ul><li>下一个状态和当前状态没有血缘关系，则弹出栈顶元素，将新状态入栈；</li><li>下一个状态是当前状态子状态，则当前状态保持不变，新状态入栈；</li><li>下一个状态是当前状态兄弟状态，则弹出当前元素，将兄弟状态入栈；</li><li>接收到了一个输入，该输入子类不能处理，派发给父级处理，父级状态根据该输入将转换到另一个状态，则将该栈中当前状态和其上所有状态全部弹出，压入新状态。</li></ul></div><p><strong>下推自动机</strong></p><blockquote><p>这是另一种使用的栈的状态机，这和上面要解决的问题完全不同。下推自动机是为了记住之前的状态，比如玩家原本的状态是站立、奔跑、跳跃、跳斩，然后切换切换到开火状态，然后松开按键，然后玩家应当回到最初的状态。</p></blockquote><p><strong>解决办法</strong></p><ul><li>笨的办法就是创建大量在状态：站立开火，奔跑开火，跳跃开火，松开按键后回到原先状态</li><li>更高效的办法是，将新状态压入栈，栈顶为当前状态，弹出栈顶为销毁状态，然后就回到了原先的状态。</li></ul><p><img src="/assets/state-pushdown-zMJzCviw.png" alt="images/state-pushdown.png"></p><div class="hint-container tip"><p class="hint-container-title">状态机的局限性和使用场景</p><p>状态机的作用仍然是有限的，今日游戏AI可能会使用行为树和规划系统等更加高级的技术。</p><p>有限状态机在以下情况有用：</p><ul><li>你有个实体，它的行为基于一些内在状态。</li><li>状态可以被严格地分割为相对较少的不相干项目。</li><li>实体响应一系列输入或事件。</li></ul></div><div class="hint-container tip"><p class="hint-container-title">状态机其他用处</p><p>在游戏中，状态机因在AI中使用而闻名。</p><p>但状态机也常用于其他领域， 比如<strong>处理玩家输入</strong>，<strong>导航菜单界面</strong>，<strong>分析文字</strong>，网络协议以及其他异步行为。</p></div><h2 id="序列模式" tabindex="-1"><a class="header-anchor" href="#序列模式" aria-hidden="true">#</a> 序列模式</h2><h3 id="双缓冲模式" tabindex="-1"><a class="header-anchor" href="#双缓冲模式" aria-hidden="true">#</a> 双缓冲模式</h3><p>这一部分作者用了两个例子来说明双缓冲的作用，其中一个例子是关于计算机渲染和显示图像的，另一个例子是说在一个游戏一帧的更新之内，对象的更新可能会导致相互影响。</p><p><strong>计算机渲染和显示图像</strong></p><p>计算机显示图像的过程实际上是往显存中按字节填入RGB数据，但是显卡不会等你填完数据才把数据显示出来，显卡会按自己的节奏周期性的将显存中的数据显示到显示器上。这就导致可能你才往显存中写了一半的数据，显卡就已经把图像显示出来了。解决的办法就是使用两片显存区域。就像舞台一样，一块是前台，一块是后台。场景在后台被布置，布置好了之后把幕布拉开就成了前台，然后工作人员继续在后台工作，场景布置完毕，再次拉开幕布。这样观众就永远不会看到后台的布置过程。</p><p><strong>游戏中的角色在一帧之内相互影响</strong></p><p>其实关于这一点，在之前写的《元胞自动机----生命游戏》中遇到过同样的问题。游戏场景是在一个二维数组中，数组中的一个位置代表一个细胞，他有两个状态，生或死，此外它还有一些更新策略，如果一个细胞周围的细胞过多，那么该细胞为因资源枯竭而死，如果过少，会因无法繁殖而死，如果一个空位周围恰好有指定数量的活细胞，则该空位会诞生一个活细胞。这些规则中所描述的状态的变化其实实际上都是基于上一帧的状态而发生的。如果采用原地更新策略更新了一个细胞的状态，那么去更新下一个细胞的状态时，就会受到上一层更新所造成的影响。举例来说，第二个细胞周围细胞很多，它在下一帧中应当因资源枯竭而死去，但是在更新第一个细胞时发现，第一个细胞周围的活细胞太少了，第一个细胞因孤单而死去，更新完第一个，接着更新第二个时，发现由于因第一个细胞的死去，第二个细胞周围的活细胞个数恰到好处，第二个细胞活下来了。</p><h2 id="行为模式" tabindex="-1"><a class="header-anchor" href="#行为模式" aria-hidden="true">#</a> 行为模式</h2><h3 id="类型对象-type-object" tabindex="-1"><a class="header-anchor" href="#类型对象-type-object" aria-hidden="true">#</a> 类型对象（Type Object）</h3><p><strong>存粹通过继承来实现游戏中物种多样性存在的问题</strong></p><ul><li>每定义一个新物种就要编写一个新类，如果需要成百上千个物种就要编写成百上千个类。</li><li>即使你可以通过继承一个功能完备的基类来省去大量代码的编写，你仍然要编写这个类。</li><li>修改成本很高，某物种的某属性值需要改变，你不得不重新编译整个游戏。</li></ul><p><strong>通过继承来实现物种多样性的具体案例：</strong></p><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-1539-0" aria-selected="true">继承关系图</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-1539-1" aria-selected="false">Monster.cpp</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-1539-2" aria-selected="false">物种s.cpp</button></div><!--[--><div class="vp-tab active" id="tab-1539-0" role="tabpanel" aria-expanded="true"><div class="vp-tab-title">继承关系图</div><!--[--><div class="hint-container warning"><p class="hint-container-title">注意</p><ul><li>当你需要的物种越多，需要定义的类就越多。</li><li>当你需要修改某参数，须重新编译整个游戏。</li></ul></div><div class="hint-container tip"><p class="hint-container-title">虽然不完美，但足够简单</p><p>其实我感觉，如果你的游戏足够简单，完全不用担心这些，这种写法足够了。</p></div><p><img src="/assets/type-object-subclasses-UVMVH8ja.png" alt></p><!--]--></div><div class="vp-tab" id="tab-1539-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">Monster.cpp</div><!--[--><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">Monster</span>
<span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Monster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">virtual</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">getAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">protected</span><span class="token operator">:</span>
  <span class="token function">Monster</span><span class="token punctuation">(</span><span class="token keyword">int</span> startingHealth<span class="token punctuation">)</span>
  <span class="token operator">:</span> <span class="token function">health_</span><span class="token punctuation">(</span>startingHealth<span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">int</span> health_<span class="token punctuation">;</span> <span class="token comment">// 当前血值</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-1539-2" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">物种s.cpp</div><!--[--><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">Dragon</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Monster</span></span>
<span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">Dragon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Monster</span><span class="token punctuation">(</span><span class="token number">230</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">virtual</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">getAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;The dragon breathes fire!&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Troll</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Monster</span></span>
<span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">Troll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Monster</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">virtual</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">getAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;The troll clubs you!&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><!--]--></div><p><strong>为类型建类（A class for a class）</strong></p><blockquote><p>为了解决上述提到的问题，这里作者给了一种方案，我简单总结为：</p><ul><li>创建一个怪物类，让其拥有大量属性和方法；</li><li>创建一个物种类，用于加载配置文件；配置的参数不同，代表的物种就不同。</li><li>怪物类需要通过物种类来初始化其参数，使用不同的物种类，就能得到不同物种的怪物。</li><li>这样就仅通过两个类实现了不同物种的怪物。</li></ul></blockquote><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-1601-0" aria-selected="true">类图</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-1601-1" aria-selected="false">简易实现</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-1601-2" aria-selected="false">使用</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-1601-3" aria-selected="false">私有构造器</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-1601-4" aria-selected="false">使用</button></div><!--[--><div class="vp-tab active" id="tab-1601-0" role="tabpanel" aria-expanded="true"><div class="vp-tab-title">类图</div><!--[--><p><img src="/assets/type-object-breed-jtMhDEG_.png" alt="images/type-object-breed.png"></p><!--]--></div><div class="vp-tab" id="tab-1601-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">简易实现</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 物种（类型对象）</span>
<span class="token keyword">class</span> <span class="token class-name">Species</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>health<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> attack<span class="token operator">:</span> AttackType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">=</span> health<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>attack <span class="token operator">=</span> attack<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>health<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>attack<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 怪物</span>
<span class="token keyword">class</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span>
  species<span class="token operator">:</span> Species<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>species<span class="token operator">:</span> Species<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">=</span> species<span class="token punctuation">.</span><span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>species <span class="token operator">=</span> species<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>species<span class="token punctuation">.</span><span class="token function">getAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-1601-2" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">使用</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 现在这样使用</span>
Monster monster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Monster</span><span class="token punctuation">(</span>someBreed<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-1601-3" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">私有构造器</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Breed</span> <span class="token punctuation">{</span>
  <span class="token comment">// 作者称：`That’s our “constructor” factory method.`</span>
  <span class="token function">newMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Monster</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 其实我感觉物种类不需要实例对象，他应该只负责加载物种配置文件，</span>
  <span class="token comment">// 把参数存到静态变量上，所以方法也应该写成静态的：</span>
  <span class="token keyword">static</span> <span class="token function">newMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Monster</span><span class="token punctuation">(</span>Breed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 不对，这样加载第二个配置文件不就把第一个给覆盖了吗？</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// 这里其实是用了c++的概念，难以翻译成ts,作者其实就是想让Monster只能被Breed类实例化。</span>
<span class="token keyword">class</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span>
  <span class="token comment">// 表示Breed是Monster的友元。</span>
  <span class="token keyword">friend</span><span class="token operator">:</span> <span class="token keyword">class</span> <span class="token class-name">Breed</span><span class="token punctuation">;</span>
  <span class="token comment">// 私有化构造器，使得只有友元能调用构造器。</span>
  <span class="token keyword">private</span><span class="token operator">:</span> <span class="token function">Monster</span><span class="token punctuation">(</span>Breed breed<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span><span class="token operator">:</span> Breed breed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其实没太理解这部分，似乎Monster可以直接舍弃掉？直接由Breed加载配置，然后实例化？</p><p>不对，这样每实例化一个Breed就都要加载一次配置文件啊！</p><!--]--></div><div class="vp-tab" id="tab-1601-4" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">使用</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 现在只有某个物种的实例对象能创建Monster</span>
Monster monster <span class="token operator">=</span> someBreed<span class="token punctuation">.</span><span class="token function">newMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><!--]--></div><div class="hint-container tip"><p class="hint-container-title">优点</p><p>如果你的游戏需要支持资料包，而资料包有新的怪物品种，这种模式可以很好的支持</p><ul><li>可能有未知的类型将在后续添加</li><li>不必改变代码并重新编译</li></ul></div><div class="hint-container tip"><p class="hint-container-title">缺点</p><ul><li>现在游戏中只有Monster的实例对象，在开发中若想则必须手动追踪一个物种。</li><li>更难为每个物种定义行为， <ul><li>因为你写到配置文件中的只能字符串，只能预定义一些行为，然后填写行为的id。</li><li>如果需要让不同的物种行为是不同的AI,也只能预定义一些AI,然后填写其编号。</li><li>否则考虑行为模式中的解释器和字节码模式。</li></ul></li></ul></div><p><strong>两种实现继承的方法</strong></p><div class="vp-tabs"><div class="vp-tabs-nav" role="tablist"><button type="button" class="vp-tab-nav active" role="tab" aria-controls="tab-1678-0" aria-selected="true">方法一：动态地从父类上获取</button><button type="button" class="vp-tab-nav" role="tab" aria-controls="tab-1678-1" aria-selected="false">方法二：在初始化时从父类获取</button></div><!--[--><div class="vp-tab active" id="tab-1678-0" role="tabpanel" aria-expanded="true"><div class="vp-tab-title">方法一：动态地从父类上获取</div><!--[--><blockquote><p>这种方式使得运行过程中，父类物种发生了改变，子类中也会同步的改变。缺点显然就是效率会低一些。</p></blockquote><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Species</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> Species<span class="token punctuation">,</span> health<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> attack<span class="token operator">:</span> AttackType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">=</span> health<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>attack <span class="token operator">=</span> attack<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 下面的两种写法其实是一个意思。</span>
  <span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 自己没有该属性，但有父类，就问父类要</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>health<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 没有父类，或者拥有该属性，就用自己的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>attack<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>attack<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">getAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-tab" id="tab-1678-1" role="tabpanel" aria-expanded="false"><div class="vp-tab-title">方法二：在初始化时从父类获取</div><!--[--><blockquote><p>这种方式使得配置文件中没有为子类定义的属性，子类会在初始化时就自动的去从父类中寻找值来初始化，且只会寻找一次。</p></blockquote><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Species</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> Species<span class="token punctuation">,</span> health<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> attack<span class="token operator">:</span> AttackType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 优先用传给自己的值，否则到父级上去获取。</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">=</span> health <span class="token operator">||</span> parent<span class="token operator">?.</span><span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>attack <span class="token operator">=</span> attack <span class="token operator">||</span> parent<span class="token operator">?.</span><span class="token function">getAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 现在不再需要给父品种字段了,因为已经拷贝了它的所有属性。</span>
    <span class="token comment">// this.parent = parent;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>health<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>attack<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><!--]--></div><h4 id="从json配置中加载并构建物种" tabindex="-1"><a class="header-anchor" href="#从json配置中加载并构建物种" aria-hidden="true">#</a> 从JSON配置中加载并构建物种</h4><p>假设游戏引擎从品种的JSON文件加载设置然后创建类型。它看上去是这样的：</p><p>这描述三个物种之间的继承关系，由于派生类的血量为0，所以其血量会从父类继承，这也意味这改变父类的血量将影响到所有子类的血量，这就非常完美。</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;Troll&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;health&quot;</span><span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span>
    <span class="token property">&quot;attack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The troll hits you!&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Troll Archer&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;parent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Troll&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;health&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;attack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The troll archer fires an arrow!&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Troll Wizard&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;parent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Troll&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 这表示父类是谁</span>
    <span class="token property">&quot;health&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 这表示该字段的值将从父类继承</span>
    <span class="token property">&quot;attack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The troll wizard casts a spell on you!&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>尝试实现</strong></p><blockquote><p>以下是我尝试在ts中实现的根据JSON字符串自动构建物种实例的案例，实现了:</p><ul><li>通过SpeciesFactory来加载配置文件</li><li>通过SpeciesFactory来构建物种</li><li>构建物种时如果需要继承某个父类，则需要预先构建其父类。</li></ul></blockquote><div class="vp-code-tabs"><div class="vp-code-tabs-nav" role="tablist"><button type="button" class="vp-code-tab-nav active" role="tab" aria-controls="codetab-1731-0" aria-selected="true">config.ts</button><button type="button" class="vp-code-tab-nav" role="tab" aria-controls="codetab-1731-1" aria-selected="false">Species.ts</button><button type="button" class="vp-code-tab-nav" role="tab" aria-controls="codetab-1731-2" aria-selected="false">SpeciesFactory.ts</button><button type="button" class="vp-code-tab-nav" role="tab" aria-controls="codetab-1731-3" aria-selected="false">Monster.ts</button><button type="button" class="vp-code-tab-nav" role="tab" aria-controls="codetab-1731-4" aria-selected="false">index.ts</button><button type="button" class="vp-code-tab-nav" role="tab" aria-controls="codetab-1731-5" aria-selected="false">output.txt</button></div><!--[--><div class="vp-code-tab active" id="codetab-1731-0" role="tabpanel" aria-expanded="true"><div class="vp-code-tab-title">config.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 模拟的JSON字符串</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;Troll&quot;</span><span class="token punctuation">,</span>
    health<span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span>
    attack_type<span class="token operator">:</span> <span class="token string">&quot;攻击方式1&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;Troll_Archer&quot;</span><span class="token punctuation">,</span>
    parent_name<span class="token operator">:</span> <span class="token string">&quot;Troll&quot;</span><span class="token punctuation">,</span>
    health<span class="token operator">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
    <span class="token comment">// attack_type: &quot;攻击方式2&quot;,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;Troll_Wizard&quot;</span><span class="token punctuation">,</span>
    parent_name<span class="token operator">:</span> <span class="token string">&quot;Troll&quot;</span><span class="token punctuation">,</span>
    health<span class="token operator">:</span> <span class="token number">111</span><span class="token punctuation">,</span>
    attack_type<span class="token operator">:</span> <span class="token string">&quot;攻击方式3&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-code-tab" id="codetab-1731-1" role="tabpanel" aria-expanded="false"><div class="vp-code-tab-title">Species.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Monster <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./Monster&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 第一种实现：在初始化时从父类中获取将子类未初始化的属性</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Species</span> <span class="token punctuation">{</span>
  name<span class="token operator">!</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  parent_name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  parent<span class="token operator">:</span> Species <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  health<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  attack_type<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> Species <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> config<span class="token operator">:</span> Species<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把配置中属性加载到当前对象上</span>
    <span class="token comment">// 如果可以继承</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 寻找未被初始化的字段并通过父类继承</span>
        <span class="token comment">// @ts-ignore</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token builtin">Function</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// @ts-ignore</span>
          <span class="token keyword">this</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> parent<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">newMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Monster</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>health<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">attack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;attack:&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>attack_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 第二种实现：在初始化时直接将子类未初始化的属性从父类中获取</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Species2</span> <span class="token punctuation">{</span>
  name<span class="token operator">!</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  parent_name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  parent<span class="token operator">:</span> Species <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  health<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  attack_type<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> Species <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> config<span class="token operator">:</span> Species<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把配置中属性加载到当前对象上</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span> <span class="token comment">// 记录父级</span>
  <span class="token punctuation">}</span>
  <span class="token function">newMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Monster</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当子类没有改属性则从父类寻找，如果父类没有则至少返回一个数值</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token operator">?.</span><span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">attack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>attack_type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;attack:&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>attack_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token operator">?.</span><span class="token function">attack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-code-tab" id="codetab-1731-2" role="tabpanel" aria-expanded="false"><div class="vp-code-tab-title">SpeciesFactory.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Species <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./Species&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SpeciesFactory</span> <span class="token punctuation">{</span>
  ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> Species<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> Species<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>config<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 解析配置文件，缓存配置</span>
    <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token keyword">as</span> Species<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cfg<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">build</span><span class="token punctuation">(</span>species<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> Species <span class="token punctuation">{</span>
    <span class="token comment">// 先判断该物种是否已经构建，有则直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>species<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>species<span class="token punctuation">)</span> <span class="token keyword">as</span> Species<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 否则根据物种名获得其配置，如果需要继承自其父级则需要先构建其父级。</span>
      <span class="token keyword">let</span> cfg <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cfg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>species<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cfg<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SyntaxError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">unknow species&#39;s name:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>species<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> parent<span class="token operator">:</span> Species <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>parent_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>parent_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Species</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-code-tab" id="codetab-1731-3" role="tabpanel" aria-expanded="false"><div class="vp-code-tab-title">Monster.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Species <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./Species&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span>
  species<span class="token operator">:</span> Species<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>species<span class="token operator">:</span> Species<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>species <span class="token operator">=</span> species<span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> species<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>species<span class="token punctuation">.</span><span class="token function">getHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">attack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>species<span class="token punctuation">.</span><span class="token function">attack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Monster</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>species<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-code-tab" id="codetab-1731-4" role="tabpanel" aria-expanded="false"><div class="vp-code-tab-title">index.ts</div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> json <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./config&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SpeciesFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./SpeciesFactory&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">enum</span> SpeciesType <span class="token punctuation">{</span>
  Troll <span class="token operator">=</span> <span class="token string">&quot;Troll&quot;</span><span class="token punctuation">,</span>
  Troll_Archer <span class="token operator">=</span> <span class="token string">&quot;Troll_Archer&quot;</span><span class="token punctuation">,</span>
  Troll_Wizard <span class="token operator">=</span> <span class="token string">&quot;Troll_Wizard&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 加载配置文件，初始化物种构建器</span>
  <span class="token keyword">let</span> speciesFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpeciesFactory</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 构建物种（会自动处理物种间的继承）</span>
  <span class="token keyword">let</span> Species1 <span class="token operator">=</span> speciesFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>SpeciesType<span class="token punctuation">.</span>Troll<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> Species2 <span class="token operator">=</span> speciesFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>SpeciesType<span class="token punctuation">.</span>Troll_Archer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> Species3 <span class="token operator">=</span> speciesFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>SpeciesType<span class="token punctuation">.</span>Troll_Wizard<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 通过物种创建怪物</span>
  <span class="token keyword">let</span> monster1 <span class="token operator">=</span> Species1<span class="token punctuation">.</span><span class="token function">newMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> monster2 <span class="token operator">=</span> Species2<span class="token punctuation">.</span><span class="token function">newMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> monster3 <span class="token operator">=</span> Species3<span class="token punctuation">.</span><span class="token function">newMonster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 打印输出</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>monster1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  monster1<span class="token punctuation">.</span><span class="token function">attack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>monster2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  monster2<span class="token punctuation">.</span><span class="token function">attack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>monster3<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  monster3<span class="token punctuation">.</span><span class="token function">attack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-code-tab" id="codetab-1731-5" role="tabpanel" aria-expanded="false"><div class="vp-code-tab-title">output.txt</div><!--[--><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Monster<span class="token punctuation">{</span>
  <span class="token string">&quot;parent&quot;</span><span class="token builtin class-name">:</span> null,
  <span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span> <span class="token number">25</span>,
  <span class="token string">&quot;attack_type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;攻击方式1&quot;</span>,
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Troll&quot;</span>
<span class="token punctuation">}</span>
attack:
攻击方式1
Monster<span class="token punctuation">{</span>
  <span class="token string">&quot;parent&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;parent&quot;</span><span class="token builtin class-name">:</span> null,
    <span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span> <span class="token number">25</span>,
    <span class="token string">&quot;attack_type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;攻击方式1&quot;</span>,
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Troll&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span> <span class="token number">123</span>,
  <span class="token string">&quot;attack_type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;攻击方式1&quot;</span>,
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Troll_Archer&quot;</span>,
  <span class="token string">&quot;parent_name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Troll&quot;</span>
<span class="token punctuation">}</span>
attack:
攻击方式1
Monster<span class="token punctuation">{</span>
  <span class="token string">&quot;parent&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;parent&quot;</span><span class="token builtin class-name">:</span> null,
    <span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span> <span class="token number">25</span>,
    <span class="token string">&quot;attack_type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;攻击方式1&quot;</span>,
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Troll&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span> <span class="token number">111</span>,
  <span class="token string">&quot;attack_type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;攻击方式3&quot;</span>,
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Troll_Wizard&quot;</span>,
  <span class="token string">&quot;parent_name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Troll&quot;</span>
<span class="token punctuation">}</span>
attack:
攻击方式3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><!--]--></div><h2 id="解耦模式" tabindex="-1"><a class="header-anchor" href="#解耦模式" aria-hidden="true">#</a> 解耦模式</h2><h3 id="组件模式" tabindex="-1"><a class="header-anchor" href="#组件模式" aria-hidden="true">#</a> 组件模式</h3><p>这里的组件模式，我简单总结为：</p><p>为了避免一个函数中太多不相关的部分（物理、渲染、声音等）交织在一起，可以将这些部分拆分为组件，分别管理。</p><p><strong>比如</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Hero</span> <span class="token punctuation">{</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 物理，渲染，声音....在此处产生了耦合</span>
    <span class="token comment">// 这使得理解代码变得困难</span>
    <span class="token comment">// 也使得某些函数的实现不能轻易修改</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">collidingWithFloor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getRenderState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">INVISIBLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">playSound</span><span class="token punctuation">(</span><span class="token constant">HIT_FLOOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>组件模式</strong></p><ul><li>优点 <ul><li>组件现在可以复用到其他的类中，</li><li>组件甚至可以通过继承来实现更强大的功能。</li></ul></li><li>组合优于继承。 <ul><li>考虑一个案例：</li><li>装饰：玩家可见，不可交互的部分。灌木 ，杂物。<code>渲染组件</code></li><li>区域：看不见，但可互动。<code>物理组件</code></li><li>道具：可见，可交互。箱子，树木。<code>渲染组件 + 物理组件</code></li></ul></li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// GameObject基类，包含位置和方向之类的通用部分。</span>
<span class="token keyword">class</span> <span class="token class-name">GameObject</span> <span class="token punctuation">{</span>
  pos<span class="token operator">:</span> Vector2D<span class="token punctuation">;</span>
  input<span class="token operator">:</span> InputComponent <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  sounds<span class="token operator">:</span> SoundsComponent <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  physics<span class="token operator">:</span> PhysicsComponent <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  graphics<span class="token operator">:</span> GraphicsComponent <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 物理组件</span>
<span class="token keyword">class</span> <span class="token class-name">PhysicsComponent</span> <span class="token punctuation">{</span>
  <span class="token function">update</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> GameObject<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 渲染组件</span>
<span class="token keyword">class</span> <span class="token class-name">GraphicsComponent</span> <span class="token punctuation">{</span>
  <span class="token function">update</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> GameObject<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 音效组件</span>
<span class="token keyword">class</span> <span class="token class-name">SoundsComponent</span> <span class="token punctuation">{</span>
  <span class="token function">update</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> GameObject<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 输入组件</span>
<span class="token keyword">class</span> <span class="token class-name">InputComponent</span> <span class="token punctuation">{</span>
  <span class="token function">update</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> GameObject<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">复杂度的提升和性能的降低</p><ul><li>对象的实例化变复杂了，组件间的沟通变得复杂了</li><li>对于大型游戏，为了解耦和重用，这种付出是值得的</li><li>使用这种模式导致多了一层函数调用，这将导致性能降低</li><li>要防止过度设计，要考虑是否真的需要这种模式</li></ul></div><p><strong>伪代码案例</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Hero</span> <span class="token keyword">extends</span> <span class="token class-name">GameObject</span> <span class="token punctuation">{</span>
  pos<span class="token operator">:</span> Vendor2d<span class="token punctuation">;</span> <span class="token comment">// 位置</span>
  dir<span class="token operator">:</span> Vendor2d<span class="token punctuation">;</span> <span class="token comment">// 方向</span>
  vel<span class="token operator">:</span> Vendor2d<span class="token punctuation">;</span> <span class="token comment">// 速度</span>
  <span class="token comment">// 面向接口编程</span>
  input<span class="token operator">:</span> InputComponent<span class="token punctuation">;</span>
  physics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhysicsComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  graphics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GraphicsComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">comstructor</span><span class="token punctuation">(</span>input<span class="token operator">:</span> InputComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这使得双人游戏、演示模式可以很好的实现</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>input <span class="token operator">=</span> input<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span>world<span class="token operator">:</span> World<span class="token punctuation">,</span> graphics<span class="token operator">:</span> Graphics<span class="token punctuation">,</span> dt<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这样就防止了不同部分的代码全部挤在这里的update方法里。</span>
    input<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    physics<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> world<span class="token punctuation">,</span> dt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    graphics<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> graphics<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">HeroPhysicsComponent</span> <span class="token keyword">extends</span> <span class="token class-name">PhysicsComponent</span> <span class="token punctuation">{</span>
  volume<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token function">update</span><span class="token punctuation">(</span>hero<span class="token operator">:</span> Hero<span class="token punctuation">,</span> world<span class="token operator">:</span> World<span class="token punctuation">,</span> dt<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取当前位置的速度衰减系数</span>
    <span class="token keyword">let</span> k <span class="token operator">=</span> world<span class="token punctuation">.</span><span class="token function">getDecFactor</span><span class="token punctuation">(</span>hero<span class="token punctuation">.</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 速度衰减 v(t) = v(t0) * e^(-kt)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vel<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">*</span> k <span class="token operator">*</span> dt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算位移</span>
    hero<span class="token punctuation">.</span>pos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>hero<span class="token punctuation">.</span>vel<span class="token punctuation">.</span><span class="token function">mut</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 处理碰撞</span>
    world<span class="token punctuation">.</span><span class="token function">resolveCollision</span><span class="token punctuation">(</span>volume<span class="token punctuation">,</span> hero<span class="token punctuation">.</span>pos<span class="token punctuation">,</span> hero<span class="token punctuation">.</span>velocity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">HeroGraphicsComponent</span> <span class="token keyword">extends</span> <span class="token class-name">GraphicsComponent</span> <span class="token punctuation">{</span>
  sprites <span class="token operator">=</span> <span class="token punctuation">[</span>spriteStand<span class="token punctuation">,</span> spriteWalkLeft<span class="token punctuation">,</span> spriteWalkRight<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">update</span><span class="token punctuation">(</span>hero<span class="token operator">:</span> Hero<span class="token punctuation">,</span> ctx<span class="token operator">:</span> Graphics<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> sprite <span class="token operator">=</span> sprites<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hero<span class="token punctuation">.</span>vel<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sprite <span class="token operator">=</span> sprites<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hero<span class="token punctuation">.</span>vel<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sprite <span class="token operator">=</span> sprites<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>sprite<span class="token punctuation">,</span> hero<span class="token punctuation">.</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">HeroInputComponent</span> <span class="token keyword">extends</span> <span class="token class-name">InputComponent</span> <span class="token punctuation">{</span>
  <span class="token constant">WALK_ACCELERATION</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">update</span><span class="token punctuation">(</span>hero<span class="token operator">:</span> Hero<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>Controller<span class="token punctuation">.</span><span class="token function">getJoystickDirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">DIR_LEFT</span><span class="token operator">:</span>
        hero<span class="token punctuation">.</span>vel<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token constant">WALK_ACCELERATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">DIR_RIGHT</span><span class="token operator">:</span>
        hero<span class="token punctuation">.</span>vel<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token constant">WALK_ACCELERATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>演示模式</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 玩家操作</span>
hero <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hero</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeroInputComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 演示模式</span>
hero <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hero</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DemoInputComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>删掉Hero</strong></p><p>上述写法显然使得Hero类成了一个空壳子，这使得移除这个类成为可能。</p><p>另外，就像在上一章“类型对象”中说讨论的那样，移除类有很多优点，可以使得游戏从由代码驱动转变为由数据驱动。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">GameObject</span> <span class="token punctuation">{</span>
  pos<span class="token operator">:</span> Vendor2d<span class="token punctuation">;</span> <span class="token comment">// 位置</span>
  dir<span class="token operator">:</span> Vendor2d<span class="token punctuation">;</span> <span class="token comment">// 方向</span>
  vel<span class="token operator">:</span> Vendor2d<span class="token punctuation">;</span> <span class="token comment">// 速度</span>
  input<span class="token operator">:</span> InputComponent<span class="token punctuation">;</span>
  physics<span class="token operator">:</span> PhysicsComponent<span class="token punctuation">;</span>
  graphics<span class="token operator">:</span> GraphicsComponent<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token function">comstructor</span><span class="token punctuation">(</span>
    input<span class="token operator">:</span> InputComponent<span class="token punctuation">,</span>
    physics<span class="token operator">:</span> PhysicsComponent<span class="token punctuation">,</span>
    graphics<span class="token operator">:</span> GraphicsComponent<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>input <span class="token operator">=</span> input<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>physics <span class="token operator">=</span> physics<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>graphics <span class="token operator">=</span> graphics<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span>world<span class="token operator">:</span> World<span class="token punctuation">,</span> graphics<span class="token operator">:</span> Graphics<span class="token punctuation">,</span> dt<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    input<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    physics<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> world<span class="token punctuation">,</span> dt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    graphics<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> graphics<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">GameObject</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这样只要传入相应的组件，就能创建游戏对象。</span>
  <span class="token keyword">static</span> <span class="token function">creat</span><span class="token punctuation">(</span>
    input<span class="token operator">:</span> InputComponent<span class="token punctuation">,</span>
    physics<span class="token operator">:</span> PhysicsComponent<span class="token punctuation">,</span>
    graphics<span class="token operator">:</span> GraphicsComponent<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GameObject</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> physics<span class="token punctuation">,</span> graphics<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>组件初始化的时机</strong></p><ul><li>一旦选择将单个对象拆分成多个分离的组件，就需要考虑什么时候来初始化组件的问题。</li><li>有类自己初始化自己所需的组件。 <ul><li>这保证了类一定能拿到自己所需的组件</li><li>但如果要替换其中的组件需要做额外的操作。</li></ul></li><li>由外部初始化类的组件 <ul><li>这使得对象更灵活，可以通过多种不同的组合方式得到不同特性的对象。</li><li>对象和具体的类型解耦了，因为此时对象的组件一定是面向接口编程的。</li></ul></li></ul><p><strong>几种组件间的通信方式</strong></p><blockquote><p>拆分组件前，这些组件属于一个整体，就已经说明了他们可能需要互相协作。</p></blockquote><ol><li>共享容器对象的状态。 <ul><li>比如：输入处理组件修改角色的速度，物理组件根据速度重新计算位置。</li><li>优点：<strong>保持了组件之间的解耦</strong>，输入组件和物理组件都不知道互相的存在。</li><li>缺点： <ul><li><strong>浪费内存空间</strong>：因为这使得只要任何两组件间需要交流，就需要在父组件中新定义一个状态，如果组件是可以替换的话，甚至有可能使得存在一个状态但却不被任何组件使用的情况。</li><li><strong>依赖执行顺序</strong>：假设类中存在一个组件去修改某个状态，称之为状态生产者，有两个组件读取该状态，称为状态消耗者。在一帧之内的更新中，如果消耗状态组件的更新函数在生产状态的之后调用，那么在这一帧之内，如果第一个状态消耗组件在消耗状态后初始化状态，那么第二个状态消耗组件就不能接收到这条消息。</li></ul></li><li>使用场景：对于容器中本身就必然存在的状态就可以使用这种方式，比如位置，速度，方向。</li></ul></li><li><strong>让组件互相引用</strong><ul><li>比如，渲染组件在更新时需要询问物理组件玩家是否在地面，那就在渲染组件初始化时，直接把物理组件传给他（有时不用传，如果物理组件在容器对象上，组件可以获取到容器对象。），然后直接调用物理组件上的方法来询问。</li><li>优点，简单，高效</li><li>缺点，使得组件之间产生了耦合。</li><li>使用场景：对于动画和渲染，输入和AI,物理和粒子，这些组件虽然被拆分为单独的部分，但联系仍然紧密，互相引用会比较方便。</li></ul></li><li><strong>发送消息</strong><ul><li>在容器类中建小的消息系统，允许组件相互发送消息。</li><li>优点： <ul><li>同级组件解耦：这里所谓的解耦是相对于上面说的&quot;让组件相互引用&quot;的方法。</li><li>使得容器类简洁：所谓的简洁，也是相对于上面所说的&quot;共享容器对象的状态&quot;的方法</li></ul></li><li>使用场景：对于不重要的通信很有用，比如物理组件、输入组件通知音效组件播放音效。</li></ul></li></ol><p><strong>发送消息</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// class GameObject{</span>
<span class="token keyword">class</span> <span class="token class-name">ContainerObject</span> <span class="token punctuation">{</span>
  components <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span><span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 像所有组件发送消息</span>
  <span class="token function">boadcast</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> Message <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>components<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>comp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> comp<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">interface</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> Message <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>我猜应该这么使用：</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Hero</span> <span class="token keyword">extends</span> <span class="token class-name">ContainerObject</span> <span class="token punctuation">{</span>
  components <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">HeroPhysicsComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HeroGraphicsComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">update</span><span class="token punctuation">(</span>ctx<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>components<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>comp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> comp<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">HeroPhysicsComponent</span> <span class="token punctuation">{</span>
  <span class="token function">update</span><span class="token punctuation">(</span>hero<span class="token operator">:</span> Hero<span class="token punctuation">,</span> physics<span class="token operator">:</span> PhysicsEngin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>physics<span class="token punctuation">.</span><span class="token function">collision</span><span class="token punctuation">(</span>hero<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通知组件，发生了碰撞</span>
      hero<span class="token punctuation">.</span><span class="token function">boadcast</span><span class="token punctuation">(</span><span class="token constant">COLLISION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">HeroGraphicsComponent</span> <span class="token punctuation">{</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> Message <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 收到消息发生了碰撞</span>
      <span class="token keyword">case</span> <span class="token constant">COLLISION</span><span class="token operator">:</span>
        <span class="token comment">// 切换动画</span>
        sprite <span class="token operator">=</span> <span class="token constant">COLLISION_SPRITE</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="事件队列" tabindex="-1"><a class="header-anchor" href="#事件队列" aria-hidden="true">#</a> 事件队列</h3><div class="hint-container tip"><p class="hint-container-title">总结</p><ul><li>其本质为观察者模式的异步实现。类似与go语言中的“channel通信”</li><li>实现方式：添加一个队列</li><li>要点：不要让程序的其他部分直接操作队列</li><li>优点： <ul><li>可以方便的拆分到单独的线程</li><li>解决了同步函数阻塞游戏循环的问题。</li></ul></li></ul></div><p><strong>为什么需要事件队列？</strong></p><blockquote><p>或者说，直接调用函数播放声音有什么问题？</p></blockquote><ul><li><strong>同步阻塞和波形叠加：</strong><ul><li>如果播放音频的操作是同步的（就是说播放完毕前函数不会返回），则会导致阻塞，使得游戏卡住</li><li>如果播放音频不是同步的，这也存在两个声音在一帧之内同时播放导致波形叠加，声音刺耳的问题。</li></ul></li><li><strong>线程安全问题：</strong><ul><li>一般来说游戏引擎在多核处理器上运行时会存在渲染线程、物理线程等的多个线程，</li><li>这些线程可能同时调用该函数，但该函数是没有锁的，无法保证执行顺序，可能造成潜在的问题；</li><li>但如果单独为声音分配一个线程，这又可能导致，在其他线程都忙于处理各种任务时，音频线程可能会无所作为，无法充分利用多核机器的优势。</li></ul></li><li><strong>立即执行在多线程环境中存在的问题：</strong><ul><li>调用者准备好调用声音播放函数了，但是被调用者可能没有准备好。</li><li>比如说正在被另一个线程所调用。如果有锁，则当前线程需要等待，如果没锁，则会造成线程安全问题。</li></ul></li></ul><p><strong>不使用事件队列，直接调用函数播放声音的案例</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Audio</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">PlaySound</span><span class="token punctuation">(</span>id<span class="token operator">:</span> SoundId<span class="token punctuation">,</span> volume<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> resource<span class="token operator">:</span> ResourceId <span class="token operator">=</span> <span class="token function">loadSound</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> channel<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token function">findOpenChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token function">startSound</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> volume<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Menu</span> <span class="token punctuation">{</span>
  <span class="token function">onSelect</span><span class="token punctuation">(</span>index<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Audio<span class="token punctuation">.</span><span class="token function">playSound</span><span class="token punctuation">(</span><span class="token constant">SOUND_BLOOP</span><span class="token punctuation">,</span> <span class="token constant">VOL_MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ......</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>鼠标移入选项框<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>事件队列示例代码</strong></p><ul><li>原文中使用固定长度数组实现了一个循环消息队列，这个不难；</li><li>但我这里直接使用js的列表了，因为方便和清晰明了。</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Audio</span> <span class="token punctuation">{</span>
  queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span><span class="token operator">&lt;</span>PlayMessage<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">playSound</span><span class="token punctuation">(</span>id<span class="token operator">:</span> SoundId<span class="token punctuation">,</span> volume<span class="token operator">:</span> int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    queue<span class="token punctuation">.</span><span class="token function">enQueue</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">,</span> volume <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 入队</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> playMessage <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">deQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 出队</span>
    <span class="token comment">// 播放</span>
    <span class="token function">play</span><span class="token punctuation">(</span>playMessage<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>合并请求:防止声音波形叠加</strong></p><ul><li>注意这里是在请求入队时合并，而不是处理时。 <ul><li>在入队时判断则只需要判断入队消息是否和其他重复，时间复杂度O(N)</li><li>在处理时判断，需要判断所有消息是否两两不重复，时间复杂度O(N^2)</li></ul></li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Audio</span> <span class="token punctuation">{</span>
  queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span><span class="token operator">&lt;</span>PlayMessage<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">playSound</span><span class="token punctuation">(</span>id<span class="token operator">:</span> SoundId<span class="token punctuation">,</span> volume<span class="token operator">:</span> int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据id去重，防止声音波形叠加</span>
    <span class="token comment">// 当有两个请求播放同一音频时，将它们合并成只保留声音最大的请求。</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>lenght<span class="token punctuation">;</span> idx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> item <span class="token operator">=</span> queue<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>id <span class="token operator">==</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item<span class="token punctuation">.</span>volume <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>volume<span class="token punctuation">,</span> volume<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    queue<span class="token punctuation">.</span><span class="token function">enQueue</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">,</span> volume <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 入队</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><ul><li>如果队列很长，入队操作会因合并操作导致耗时较长， <ul><li>解决方法： <ul><li>可能在update中合并较为合理</li><li>可以通过其他数据结构，比如hashMap来优化，或者双链表+Map来优化。</li></ul></li></ul></li><li>另外： <ul><li>队列长度、请求的处理速度，会影响合并的频率，</li><li>因为请求速度慢就会导致消息堆积在队列中，队列过长就允许了过多的消息，就有更多的合并机会，更高的合并频率。</li><li>所以这个参数可能需要合理的设置</li></ul></li></ul></div><p><strong>中心事件队列</strong></p><ul><li>就是一个全局的消息队列</li><li>好处是，游戏中所有对象都能收到消息</li><li>坏处是，尽管队列被作为一个属性封装在一个类中，但它仍然是全局可访问的，全局对象存在各种问题，比如线程安全。</li></ul><p><strong>事件队列中的状态可能是滞后的</strong></p><ul><li><strong>事件消息中应该包含足够多的信息</strong></li><li>如果游戏中事件发生的非常频繁，这就可能导致事件的积压；当被积压的消息被处理时，游戏中各种状态可能已经改变了，这使得消息是滞后于实际游戏状态的。</li><li>事件消息中应该尽可能提供多的信息，比如怪物被击杀时，消息中应包含怪物的各种属性，以便在&quot;计算处理经验加成的系统&quot;收到消息时可以直接根据这些属性来计算，否则就需要再从新去找到那个怪物单位，但是由于消息的滞后性，处理消息时怪物可能已经消失了。</li></ul><p><strong>消息闭环</strong></p><ul><li>如果A发生消息给B,B处理消息后又发送消息给A,A收到消息后又向B响应，这就会导致消息闭环。</li><li>如果消息是同步的，这会造成栈溢出。</li><li>如果消息是异步的，游戏仍然能运行。</li><li>避免消息闭环的发生，就要避免在处理消息时发送消息。</li></ul><p><strong>将音频处理拆分到单独的线程</strong></p><ul><li>当前消息的发送者和消息的接受处理者在同一个线程，如果播放音频的API是同步的，这将导致游戏主循环阻塞卡顿。</li><li>所以，也是一般来说，音频处理会被拆分到一个单独的线程。</li><li>目前，在这种事件队列的设计模式下，可以比较轻松的完成。因为： <ol><li><strong>请求播放音频的代码和实际执行播放音频的代码是分离的。</strong> A线程调用请求播放音频不用担心被阻塞，因为播放音频的代码在B线程被执行。</li><li><strong>队列充当了缓冲区</strong>，队列的存在帮助管理并发问题，确保请求的有序处理。</li><li><strong>队列是和程序的其他部分隔离的</strong></li></ol></li><li>唯一需要做的操作可能就是：<strong>给队列加锁</strong>，因为可能有多个线程同时调用请求播放音频的代码，这会操作队列，音频线程也可能在这时去读取队列,这就需要保证线程安全。</li></ul><h3 id="服务定位器" tabindex="-1"><a class="header-anchor" href="#服务定位器" aria-hidden="true">#</a> 服务定位器</h3><p><strong>为什么需要服务定位器？</strong></p><blockquote><p>传统方式访问服务点的缺点?</p></blockquote><p>考虑音频作为例子。 它要接触一大堆游戏系统。</p><ul><li>滚石撞击地面（物理）。</li><li>NPC开枪（AI）。</li><li>用户选择菜单项时的反馈（UI）。</li></ul><p>每处都需要用像下面这样的东西调用音频系统：</p><div class="language-c++ line-numbers-mode" data-ext="c++"><pre class="language-c++"><code>// 使用静态函数
AudioSystem::playSound(VERY_LOUD_BANG);
// 使用单例
AudioSystem::instance()-&gt;playSound(VERY_LOUD_BANG);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每个调用音频系统的游戏部分直接引用了具体的AudioSystem类，和依赖访问它的机制(静态类or单例?)。</p><p>需要耦合到某些东西上来播放声音， 但是<strong>直接接触到具体的音频实现，就好像给了一百个陌生人你家的地址，只是为了让他们在门口放一封信。 这不仅仅是隐私问题，在你搬家后，需要告诉每个人新地址是个更加痛苦的问题。</strong></p><p><strong>模式</strong></p><ul><li>服务 类定义了一堆操作的抽象接口。</li><li>具体的服务提供者实现这个接口。</li><li>分离的服务定位器提供了通过查询获取服务的方法，同时隐藏了服务提供者的具体细节和定位它的过程。</li></ul><p><strong>案例代码</strong></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Audio</span> <span class="token punctuation">{</span>
  <span class="token function">playSound</span><span class="token punctuation">(</span>soundID<span class="token operator">:</span> int<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">stopSound</span><span class="token punctuation">(</span>soundID<span class="token operator">:</span> int<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">stopAllSounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">NullAudio</span> <span class="token keyword">implements</span> <span class="token class-name">Audio</span> <span class="token punctuation">{</span>
  <span class="token function">playSound</span><span class="token punctuation">(</span>soundID<span class="token operator">:</span> int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 什么也不做 */</span>
  <span class="token punctuation">}</span>
  <span class="token function">stopSound</span><span class="token punctuation">(</span>soundID<span class="token operator">:</span> int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 什么也不做 */</span>
  <span class="token punctuation">}</span>
  <span class="token function">stopAllSounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 什么也不做 */</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ConsoleAudio</span> <span class="token keyword">implements</span> <span class="token class-name">Audio</span> <span class="token punctuation">{</span>
  <span class="token function">playSound</span><span class="token punctuation">(</span>soundID<span class="token operator">:</span> int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用主机音频API播放声音……</span>
  <span class="token punctuation">}</span>
  <span class="token function">stopSound</span><span class="token punctuation">(</span>soundID<span class="token operator">:</span> int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用主机音频API停止声音……</span>
  <span class="token punctuation">}</span>
  <span class="token function">stopAllSounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用主机音频API停止所有声音……</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Locator</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NullAudio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token function">getAudio</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> service<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token function">provide</span><span class="token punctuation">(</span>service<span class="token operator">:</span> Audio<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 防止service为空</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> service <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">NullAudio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Game</span><span class="token punctuation">{</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>isDevMode<span class="token punctuation">)</span><span class="token punctuation">{</span>
      Locator<span class="token operator">:</span><span class="token operator">:</span><span class="token function">provide</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConsoleAudio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      Locator<span class="token operator">:</span><span class="token operator">:</span><span class="token function">provide</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RealAudio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Locator<span class="token operator">:</span><span class="token operator">:</span><span class="token function">getAudio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">playSound</span><span class="token punctuation">(</span><span class="token constant">GAME_INIT_DONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="优化模式" tabindex="-1"><a class="header-anchor" href="#优化模式" aria-hidden="true">#</a> 优化模式</h2><h3 id="数据局部性" tabindex="-1"><a class="header-anchor" href="#数据局部性" aria-hidden="true">#</a> 数据局部性</h3><ul><li><strong>目的：</strong> 加速内存读取</li><li><strong>方法：</strong> 通过合理组织数据，充分利用CPU缓存</li><li><strong>原因：</strong> 芯片速度递增，但RAM读取速度增长缓慢，导致数据获取成为性能瓶颈。</li></ul><p><strong>CPU和RAM性能极度不匹配的问题：</strong></p><ul><li>从1980年到2010年，CPU速度迅速增长，而RAM速度增长相对缓慢。</li><li>硬件巨头未强调数据获取速度的不足，导致软件无法充分利用硬件性能提升。</li><li><img src="/assets/data-locality-chart--GUuI6El.png" alt=""></li></ul><p><strong>CPU缓存：</strong></p><ul><li><strong>缓存工作原理：</strong><ul><li>芯片内部有小块高速存储器（缓存），比RAM读取速度更快。</li><li>缓存分为多层，每一层更大但速度更慢。</li><li>缓存通过加载一整块内存（cache line）提高效率。</li></ul></li><li><strong>缓存不命中：</strong><ul><li>缓存不命中会导致CPU等待几百个周期直到从RAM获取数据。</li><li>CPU在缓存不命中时空转，影响性能。</li></ul></li></ul><h4 id="什么是数据局部性" tabindex="-1"><a class="header-anchor" href="#什么是数据局部性" aria-hidden="true">#</a> 什么是数据局部性？</h4><ul><li>数据局部性是指在程序执行过程中，对同一块内存区域的重复访问。</li><li>数据局部性的概念是为了更有效地利用计算机内存层次结构中的缓存系统而提出的。 <ul><li>计算机的缓存系统通常按照块（cache line）的方式工作，即一次性加载一块内存数据到缓存中</li></ul></li><li>在设计程序时考虑并利用数据局部性，可以减少缓存未命中的发生，进而提高程序的执行效率和性能。</li><li>在许多算法和数据结构的设计中，都考虑了数据局部性以优化内存访问模式。</li><li>有两种主要的数据局部性： <ul><li><strong>时间局部性（Temporal Locality）：</strong> 如果一个数据在最近的过去被访问过，那么在短期内它很可能会再次被访问。这种情况下，程序倾向于多次使用相同的数据。时间局部性是指程序在时间维度上对同一数据的重复访问。</li><li><strong>空间局部性（Spatial Locality）：</strong> 如果一个数据被访问，那么与该数据相邻的数据也很可能会被访问。在空间局部性中，程序倾向于访问相邻的数据，即使这些数据不是直接相关的。空间局部性是指程序在空间维度上对相邻数据的重复访问。</li></ul></li></ul><p><strong>数据的组织方式直接影响性能：</strong></p><ul><li>因为芯片总是获取一整块cache line，如果数据的组织方式不合理，就会导致缓存不命中，就会导致CPU缓存不命中，影响性能。</li><li>所以在组织数据的存储方式的时候，应当使即将被处理的数据紧密相邻，以提高读取速度。</li></ul><p><strong>在单线程和多线程环境下如何组织数据？</strong></p><ul><li>在单线程环境下，应当使得数据使其在同一cache line上紧密排列。</li><li>在多线程环境中，可能需要考虑让相邻数据在多个cache line上，以避免线程争夺同一cache line的问题。</li></ul><h4 id="不考虑数据局部性导致影响性能的案例" tabindex="-1"><a class="header-anchor" href="#不考虑数据局部性导致影响性能的案例" aria-hidden="true">#</a> 不考虑数据局部性导致影响性能的案例</h4><p><strong>完全不考虑数据局部性,导致缓存频繁不命中的案例：</strong></p><div class="vp-code-tabs"><div class="vp-code-tabs-nav" role="tablist"><button type="button" class="vp-code-tab-nav active" role="tab" aria-controls="codetab-2565-0" aria-selected="true"><strong>游戏主循环</strong></button><button type="button" class="vp-code-tab-nav" role="tab" aria-controls="codetab-2565-1" aria-selected="false"><strong>游戏实体</strong></button><button type="button" class="vp-code-tab-nav" role="tab" aria-controls="codetab-2565-2" aria-selected="false"><strong>接口定义</strong></button></div><!--[--><div class="vp-code-tab active" id="codetab-2565-0" role="tabpanel" aria-expanded="true"><div class="vp-code-tab-title"><strong>游戏主循环</strong></div><!--[--><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>gameOver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理AI</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numEntities<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    entities<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">ai</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新物理</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numEntities<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    entities<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">physics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 绘制屏幕</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numEntities<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    entities<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 其他和时间有关的游戏循环机制……</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-code-tab" id="codetab-2565-1" role="tabpanel" aria-expanded="false"><div class="vp-code-tab-title"><strong>游戏实体</strong></div><!--[--><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">GameEntity</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">GameEntity</span><span class="token punctuation">(</span>AIComponent<span class="token operator">*</span> ai<span class="token punctuation">,</span>
             PhysicsComponent<span class="token operator">*</span> physics<span class="token punctuation">,</span>
             RenderComponent<span class="token operator">*</span> render<span class="token punctuation">)</span><span class="token operator">:</span>
          <span class="token function">ai_</span><span class="token punctuation">(</span>ai<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">physics_</span><span class="token punctuation">(</span>physics<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">render_</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span>
  AIComponent<span class="token operator">*</span> <span class="token function">ai</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> ai_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  PhysicsComponent<span class="token operator">*</span> <span class="token function">physics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> physics_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  RenderComponent<span class="token operator">*</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> render_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">private</span><span class="token operator">:</span>
  AIComponent<span class="token operator">*</span> ai_<span class="token punctuation">;</span>
  PhysicsComponent<span class="token operator">*</span> physics_<span class="token punctuation">;</span>
  RenderComponent<span class="token operator">*</span> render_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-code-tab" id="codetab-2565-2" role="tabpanel" aria-expanded="false"><div class="vp-code-tab-title"><strong>接口定义</strong></div><!--[--><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">AIComponent</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 处理并修改状态…… */</span> <span class="token punctuation">}</span>
<span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// 目标，情绪，等等……</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">PhysicsComponent</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 处理并修改状态…… */</span> <span class="token punctuation">}</span>
<span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// 刚体，速度，质量，等等……</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">RenderComponent</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 处理并修改状态…… */</span> <span class="token punctuation">}</span>
<span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// 网格，纹理，着色器，等等……</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><!--]--></div><p>这张图反映了上面的代码的实质：<strong>过多的指针运算</strong></p><p><img src="/assets/data-locality-pointer-chasing-k3ihMXcp.png" alt=""></p><p>上面的案例中，缓存不命中频繁发生，导致性能降低</p><ul><li>缓存不命中的主要原因是因为程序在频繁对指针执行<strong>解引用运算符（dereference operator）运算</strong></li><li>在游戏主循环中，由于遍历的实体数组实际上是实体的指针，要获取实体，就要对指针做解引用运算，也就是从内存中去加载这个游戏实体，这导致缓存不命中，CPU空转。</li><li>当得到了游戏实体对象后，需要执行游戏实体上的组件的更新函数，但由于这些组件也是指针，于是又要到内存去加载他们，缓存不命中，CPU空转。</li><li>然后来到第二个游戏实体的指针，上述步骤循环......</li><li>随着实体在内存中的分布变得混乱，缓存不命中的几率将会加剧 <ul><li>实体和组件在内存中的分布是随机的，随着实体的分配和释放，堆的组织会变乱。</li><li>一堆杂乱的对象散布在内存的各处，使用指针彼此相连。</li></ul></li></ul><h4 id="考虑数据局部性的优化方法-使用数组" tabindex="-1"><a class="header-anchor" href="#考虑数据局部性的优化方法-使用数组" aria-hidden="true">#</a> 考虑数据局部性的优化方法：使用数组</h4><blockquote><p>直接遍历组件的数组，而不是组件的指针的数组</p></blockquote><p><img src="/assets/data-locality-component-arrays.png-dKqZdHy-.png" alt=""></p><div class="vp-code-tabs"><div class="vp-code-tabs-nav" role="tablist"><button type="button" class="vp-code-tab-nav active" role="tab" aria-controls="codetab-2635-0" aria-selected="true"><strong>定义组件的数组</strong></button><button type="button" class="vp-code-tab-nav" role="tab" aria-controls="codetab-2635-1" aria-selected="false"><strong>游戏主循环</strong></button><button type="button" class="vp-code-tab-nav" role="tab" aria-controls="codetab-2635-2" aria-selected="false"><strong>游戏实体</strong></button></div><!--[--><div class="vp-code-tab active" id="codetab-2635-0" role="tabpanel" aria-expanded="true"><div class="vp-code-tab-title"><strong>定义组件的数组</strong></div><!--[--><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// 使用组件数组，而不是组件的指针的数组</span>
AIComponent aiComponents<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> AIComponent<span class="token punctuation">[</span>MAX_ENTITIES<span class="token punctuation">]</span><span class="token punctuation">;</span>
PhysicsComponent physicsComponents<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> PhysicsComponent<span class="token punctuation">[</span>MAX_ENTITIES<span class="token punctuation">]</span><span class="token punctuation">;</span>
RenderComponent renderComponents<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> RenderComponent<span class="token punctuation">[</span>MAX_ENTITIES<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-code-tab" id="codetab-2635-1" role="tabpanel" aria-expanded="false"><div class="vp-code-tab-title"><strong>游戏主循环</strong></div><!--[--><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>gameOver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理AI</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numEntities<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    aiComponents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新物理</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numEntities<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    physicsComponents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">physics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 绘制屏幕</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numEntities<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    renderComponents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 其他和时间有关的游戏循环机制……</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-code-tab" id="codetab-2635-2" role="tabpanel" aria-expanded="false"><div class="vp-code-tab-title"><strong>游戏实体</strong></div><!--[--><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token comment">// 游戏实体依然可以保持良好的封装</span>

<span class="token keyword">class</span> <span class="token class-name">GameEntity</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">GameEntity</span><span class="token punctuation">(</span>AIComponent<span class="token operator">*</span> ai<span class="token punctuation">,</span>
             PhysicsComponent<span class="token operator">*</span> physics<span class="token punctuation">,</span>
             RenderComponent<span class="token operator">*</span> render<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">private</span><span class="token operator">:</span>
  AIComponent<span class="token operator">*</span> ai_<span class="token punctuation">;</span>
  PhysicsComponent<span class="token operator">*</span> physics_<span class="token punctuation">;</span>
  RenderComponent<span class="token operator">*</span> render_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><!--]--></div><h4 id="考虑数据局部性的优化方法-打包数据" tabindex="-1"><a class="header-anchor" href="#考虑数据局部性的优化方法-打包数据" aria-hidden="true">#</a> 考虑数据局部性的优化方法：打包数据</h4><div class="vp-code-tabs"><div class="vp-code-tabs-nav" role="tablist"><button type="button" class="vp-code-tab-nav active" role="tab" aria-controls="codetab-2649-0" aria-selected="true"><strong>ParticleSystem类</strong></button><button type="button" class="vp-code-tab-nav" role="tab" aria-controls="codetab-2649-1" aria-selected="false"><strong>游戏主循环</strong></button></div><!--[--><div class="vp-code-tab active" id="codetab-2649-0" role="tabpanel" aria-expanded="true"><div class="vp-code-tab-title"><strong>ParticleSystem类</strong></div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Particle</span> <span class="token punctuation">{</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ParticleSystem</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token constant">MAX_PARTICLES</span> <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>
  particles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Particle</span><span class="token punctuation">[</span><span class="token constant">MAX_PARTICLES</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  numParticles <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// 写法1：基本的写法</span>
  <span class="token function">update_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numParticles<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      particles_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 写法2：部分更新的写法</span>
  <span class="token function">update_v2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numParticles<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 但是这样写的缺点就在于仍然可能导致大量不需要被更新的数据被加载到缓存</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>particles_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        particles_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 写法3：让整个数组有序，活跃的粒子始终靠前</span>
  <span class="token function">update_v3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numActive<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      particles_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 保持数组有序：激活一个粒子</span>
  <span class="token function">activateParticle</span><span class="token punctuation">(</span>index<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将它和第一个未激活的粒子交换</span>
    <span class="token keyword">let</span> temp <span class="token operator">=</span> particles_<span class="token punctuation">[</span>numActive_<span class="token punctuation">]</span><span class="token punctuation">;</span>
    particles_<span class="token punctuation">[</span>numActive_<span class="token punctuation">]</span> <span class="token operator">=</span> particles_<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    particles_<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token comment">// 现在多了一个激活粒子</span>
    numActive_<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 保持数组有序：反激活一个粒子</span>
  <span class="token function">deactivateParticle</span><span class="token punctuation">(</span>index<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 现在少了一个激活粒子</span>
    numActive_<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token comment">// 将它和最后一个激活粒子交换</span>
    <span class="token keyword">let</span> temp <span class="token operator">=</span> particles_<span class="token punctuation">[</span>numActive_<span class="token punctuation">]</span><span class="token punctuation">;</span>
    particles_<span class="token punctuation">[</span>numActive_<span class="token punctuation">]</span> <span class="token operator">=</span> particles_<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    particles_<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><div class="vp-code-tab" id="codetab-2649-1" role="tabpanel" aria-expanded="false"><div class="vp-code-tab-title"><strong>游戏主循环</strong></div><!--[--><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">let</span> particleSystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParticleSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  particleSystem<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><!--]--></div><!--]--></div><p><strong>缺点：</strong></p><p>上述写法放弃了一定的面向对象思想，Particle类的实例对象不能激活或反激活自己。</p><p>这种写法不知道能不能解决这种缺点</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">Particle</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Particle</span><span class="token double-colon punctuation">::</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">deActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Particle</span><span class="token double-colon punctuation">::</span><span class="token function">deActive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 粒子系统的逻辑：</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">=</span> MAX_SIZE <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">int</span> activeNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> Particle <span class="token operator">*</span>particels <span class="token operator">=</span> <span class="token keyword">new</span> Particle<span class="token punctuation">[</span>MAX_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> Particle <span class="token function">getParticle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>activeNum<span class="token operator">==</span>MAX_SIZE<span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    Particle particel <span class="token operator">=</span> particels<span class="token punctuation">[</span>activeNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
    particel<span class="token punctuation">.</span><span class="token function">setIdx</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    activeNum<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> particel<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">active</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 移到最后，然后改变activeNum指针</span>
    <span class="token comment">// 把idx和最后一个交换</span>
    Particle temp <span class="token operator">=</span> particels<span class="token punctuation">[</span>activeNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
    particels<span class="token punctuation">[</span>activeNum<span class="token punctuation">]</span> <span class="token operator">=</span> particels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    particels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    activeNum<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deActive</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 移动activeNum,然后把idx放到最后的位置。</span>
    activeNum<span class="token operator">--</span><span class="token punctuation">;</span>
    Particle temp <span class="token operator">=</span> particels<span class="token punctuation">[</span>activeNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
    particels<span class="token punctuation">[</span>activeNum<span class="token punctuation">]</span> <span class="token operator">=</span> particels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    particels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>idx<span class="token operator">&lt;</span>activeNum<span class="token punctuation">;</span>idx<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      particels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!----><!--]--><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 2449695354@qq.com">YiguiDing</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="giscus-wrapper input-top" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><!----><div class="vp-copyright">MIT Licensed | Copyright © 2019-present Yigui-Ding</div></footer></div><!--]--><!----><!----><!----><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-yNXCeZQw.js" defer></script>
  </body>
</html>
