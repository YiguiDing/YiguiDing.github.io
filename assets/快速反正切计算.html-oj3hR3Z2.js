import{_ as t,c as l,o as e,b as n,a as s,e as a}from"./app-DjDtDPYL.js";const p="/assets/image-6-CmGLuCXV.png",c="/assets/image-7-uEiCka3C.png",i="/assets/image-3-C5CNjG24.png",m="/assets/image-4-Sw1muvD5.png",o={},r=n('<h2 id="原理" tabindex="-1"><a class="header-anchor" href="#原理"><span>原理</span></a></h2><p>这段SimpleFOC的<a href="#%E6%BA%90%E4%BB%A3%E7%A0%81">代码</a>实际来自开源项目ODrive的<a href="https://github.com/odriverobotics/ODrive/blob/master/Firmware/MotorControl/utils.cpp" target="_blank" rel="noopener noreferrer"><code>utils.cpp</code></a>，</p><p>理论依据来自stackexchange中的一篇<a href="https://math.stackexchange.com/a/1105038/81278" target="_blank" rel="noopener noreferrer"><code>问答</code></a>，</p><p>下面尝试记录对该函数的理解。</p><hr><p><code>arctan2(z)</code>的计算过程</p><ul><li>参数化简：计算<code>a := min (|x|, |y|) / max (|x|, |y|)</code>，使得<code>a∈[0,1]</code>。</li><li>多项式逼近：使用一个多项式来近似计算 <code>arctan(a)</code> 的值。</li><li>结果调整：根据<code>x</code>和<code>y</code>的正负性来判断实际所在的象限，计算实际的<code>arctan2(a)</code>角度</li></ul><hr><p><strong>计算反正切</strong></p><p>这里使用的是一个多项式计算反正切，该多项式是对<code>arctan()</code>函数的一种逼近</p><p>泰勒级数展开（Taylor Series Expansion）逼近</p>',11),u=s("ul",null,[s("li",null,"泰勒级数是一种常用的数学工具，"),s("li",null,"其更多地关注函数在某一点附近的局部函数值"),s("li",null,[a("随着 "),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",null,"x")]),s("annotation",{encoding:"application/x-tex"},"x")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.4306em"}}),s("span",{class:"mord mathnormal"},"x")])])]),a(" 的增大，泰勒级数的误差可能会增加。")]),s("li",null,[a("对于 "),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",null,"arctan"),s("mo",null,"⁡"),s("mo",{stretchy:"false"},"("),s("mi",null,"x"),s("mo",{stretchy:"false"},")")]),s("annotation",{encoding:"application/x-tex"},"\\arctan(x)")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mop"},"arctan"),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal"},"x"),s("span",{class:"mclose"},")")])])]),a(" 函数，它的泰勒级数在 "),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",null,"x"),s("mo",null,"="),s("mn",null,"0")]),s("annotation",{encoding:"application/x-tex"},"x=0")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.4306em"}}),s("span",{class:"mord mathnormal"},"x"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.6444em"}}),s("span",{class:"mord"},"0")])])]),a(" 处展开为：")]),s("li",null,[s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",null,"arctan"),s("mo",null,"⁡"),s("mo",{stretchy:"false"},"("),s("mi",null,"x"),s("mo",{stretchy:"false"},")"),s("mo",null,"="),s("mi",null,"x"),s("mo",null,"−"),s("mfrac",null,[s("msup",null,[s("mi",null,"x"),s("mn",null,"3")]),s("mn",null,"3")]),s("mo",null,"+"),s("mfrac",null,[s("msup",null,[s("mi",null,"x"),s("mn",null,"5")]),s("mn",null,"5")]),s("mo",null,"−"),s("mfrac",null,[s("msup",null,[s("mi",null,"x"),s("mn",null,"7")]),s("mn",null,"7")]),s("mo",null,"+"),s("mo",null,"⋯")]),s("annotation",{encoding:"application/x-tex"},"\\arctan(x) = x - \\frac{x^3}{3} + \\frac{x^5}{5} - \\frac{x^7}{7} + \\cdots")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mop"},"arctan"),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal"},"x"),s("span",{class:"mclose"},")"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.6667em","vertical-align":"-0.0833em"}}),s("span",{class:"mord mathnormal"},"x"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"−"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1.3629em","vertical-align":"-0.345em"}}),s("span",{class:"mord"},[s("span",{class:"mopen nulldelimiter"}),s("span",{class:"mfrac"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"1.0179em"}},[s("span",{style:{top:"-2.655em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"3")])])]),s("span",{style:{top:"-3.23em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"frac-line",style:{"border-bottom-width":"0.04em"}})]),s("span",{style:{top:"-3.394em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathnormal mtight"},"x"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8913em"}},[s("span",{style:{top:"-2.931em","margin-right":"0.0714em"}},[s("span",{class:"pstrut",style:{height:"2.5em"}}),s("span",{class:"sizing reset-size3 size1 mtight"},[s("span",{class:"mord mtight"},"3")])])])])])])])])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.345em"}},[s("span")])])])]),s("span",{class:"mclose nulldelimiter"})]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"+"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1.3629em","vertical-align":"-0.345em"}}),s("span",{class:"mord"},[s("span",{class:"mopen nulldelimiter"}),s("span",{class:"mfrac"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"1.0179em"}},[s("span",{style:{top:"-2.655em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"5")])])]),s("span",{style:{top:"-3.23em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"frac-line",style:{"border-bottom-width":"0.04em"}})]),s("span",{style:{top:"-3.394em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathnormal mtight"},"x"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8913em"}},[s("span",{style:{top:"-2.931em","margin-right":"0.0714em"}},[s("span",{class:"pstrut",style:{height:"2.5em"}}),s("span",{class:"sizing reset-size3 size1 mtight"},[s("span",{class:"mord mtight"},"5")])])])])])])])])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.345em"}},[s("span")])])])]),s("span",{class:"mclose nulldelimiter"})]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"−"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1.3629em","vertical-align":"-0.345em"}}),s("span",{class:"mord"},[s("span",{class:"mopen nulldelimiter"}),s("span",{class:"mfrac"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"1.0179em"}},[s("span",{style:{top:"-2.655em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"7")])])]),s("span",{style:{top:"-3.23em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"frac-line",style:{"border-bottom-width":"0.04em"}})]),s("span",{style:{top:"-3.394em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathnormal mtight"},"x"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8913em"}},[s("span",{style:{top:"-2.931em","margin-right":"0.0714em"}},[s("span",{class:"pstrut",style:{height:"2.5em"}}),s("span",{class:"sizing reset-size3 size1 mtight"},[s("span",{class:"mord mtight"},"7")])])])])])])])])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.345em"}},[s("span")])])])]),s("span",{class:"mclose nulldelimiter"})]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"+"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.313em"}}),s("span",{class:"minner"},"⋯")])])])])],-1),h=s("p",null,"最小最大值逼近（minimax approximation）",-1),d=s("ul",null,[s("li",null,[a("这种方法的目标是在给定区间（如"),s("code",null,"[0,1]"),a("）内找到一个多项式，使得该多项式与目标函数之间的最大偏差最小化。这样的多项式函数图像在整体上更接近目标函数图像。")]),s("li",null,[a("对于 "),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",null,"arctan"),s("mo",null,"⁡"),s("mo",{stretchy:"false"},"("),s("mi",null,"x"),s("mo",{stretchy:"false"},")")]),s("annotation",{encoding:"application/x-tex"},"\\arctan(x)")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mop"},"arctan"),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal"},"x"),s("span",{class:"mclose"},")")])])]),a(" 函数，在给定区间"),s("code",null,"[0,1]"),a("通过雷米兹（Remez）算法确定的最佳系数为：")]),s("li",null,[s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",null,"arctan"),s("mo",null,"⁡"),s("mo",{stretchy:"false"},"("),s("mi",null,"x"),s("mo",{stretchy:"false"},")"),s("mo",null,"="),s("mo",null,"−"),s("mn",null,"0.0464964749"),s("msup",null,[s("mi",null,"x"),s("mn",null,"7")]),s("mo",null,"+"),s("mn",null,"0.15931422"),s("msup",null,[s("mi",null,"x"),s("mn",null,"5")]),s("mo",null,"−"),s("mn",null,"0.327622764"),s("msup",null,[s("mi",null,"x"),s("mn",null,"3")]),s("mo",null,"+"),s("mi",null,"x")]),s("annotation",{encoding:"application/x-tex"},"\\arctan(x) = -0.0464964749 x^7 +0.15931422 x^5 - 0.327622764 x^3 + x")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mop"},"arctan"),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal"},"x"),s("span",{class:"mclose"},")"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8974em","vertical-align":"-0.0833em"}}),s("span",{class:"mord"},"−"),s("span",{class:"mord"},"0.0464964749"),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"x"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8141em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},"7")])])])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"+"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8974em","vertical-align":"-0.0833em"}}),s("span",{class:"mord"},"0.15931422"),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"x"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8141em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},"5")])])])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"−"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8974em","vertical-align":"-0.0833em"}}),s("span",{class:"mord"},"0.327622764"),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"x"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8141em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},"3")])])])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"+"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.4306em"}}),s("span",{class:"mord mathnormal"},"x")])])])])],-1),g=s("p",null,[s("img",{src:p,alt:"alt text"})],-1),y=s("hr",null,null,-1),k=s("p",null,[s("strong",null,"多项式化简")],-1),v=s("p",null,[a("这里使用"),s("strong",null,"霍纳法则"),a("来对多项式进行化简，目的是减少计算机计算乘法的次数。")],-1),x=s("p",null,"原理是拆分多项式，如:",-1),b=s("p",null,[s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",null,"y"),s("mo",null,"="),s("mi",null,"A"),s("msup",null,[s("mi",null,"x"),s("mn",null,"4")]),s("mo",null,"+"),s("mi",null,"B"),s("msup",null,[s("mi",null,"x"),s("mn",null,"3")]),s("mo",null,"+"),s("mi",null,"C"),s("msup",null,[s("mi",null,"x"),s("mn",null,"2")]),s("mo",null,"+"),s("mi",null,"D"),s("msup",null,[s("mi",null,"x"),s("mn",null,"1")])]),s("annotation",{encoding:"application/x-tex"},"y=Ax^4+Bx^3+Cx^2+Dx^1")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.625em","vertical-align":"-0.1944em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.03588em"}},"y"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8974em","vertical-align":"-0.0833em"}}),s("span",{class:"mord mathnormal"},"A"),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"x"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8141em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},"4")])])])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"+"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8974em","vertical-align":"-0.0833em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.05017em"}},"B"),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"x"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8141em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},"3")])])])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"+"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8974em","vertical-align":"-0.0833em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.07153em"}},"C"),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"x"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8141em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},"2")])])])])])])]),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"+"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8141em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.02778em"}},"D"),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"x"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8141em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},"1")])])])])])])])])])])],-1),f=s("p",null,"该多项式至少需要计算(0+1)+(1+1)+(1+1)+(1+1)=7次乘法",-1),_=s("p",null,"而将其拆分得到：",-1),w=s("p",null,[s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mi",null,"y"),s("mo",null,"="),s("mi",null,"x"),s("mo",{stretchy:"false"},"("),s("mi",null,"D"),s("mo",null,"+"),s("mi",null,"x"),s("mo",{stretchy:"false"},"("),s("mi",null,"C"),s("mo",null,"+"),s("mi",null,"x"),s("mo",{stretchy:"false"},"("),s("mi",null,"B"),s("mo",null,"+"),s("mi",null,"A"),s("mo",{stretchy:"false"},"("),s("mi",null,"x"),s("mo",{stretchy:"false"},")"),s("mo",{stretchy:"false"},")"),s("mo",{stretchy:"false"},")"),s("mo",{stretchy:"false"},")")]),s("annotation",{encoding:"application/x-tex"},"y=x(D+x(C+x(B+A(x))))")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.625em","vertical-align":"-0.1944em"}}),s("span",{class:"mord mathnormal",style:{"margin-right":"0.03588em"}},"y"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mord mathnormal"},"x"),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal",style:{"margin-right":"0.02778em"}},"D"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"+"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mord mathnormal"},"x"),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal",style:{"margin-right":"0.07153em"}},"C"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"+"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mord mathnormal"},"x"),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal",style:{"margin-right":"0.05017em"}},"B"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),s("span",{class:"mbin"},"+"),s("span",{class:"mspace",style:{"margin-right":"0.2222em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),s("span",{class:"mord mathnormal"},"A"),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal"},"x"),s("span",{class:"mclose"},"))))")])])])],-1),z=n('<p>该多项式只需要计算4次乘法</p><p><strong>所以</strong></p><p>这里可以把：<code>-0.0464964749 x^7 +0.15931422 x^5 - 0.327622764 x^3 + x</code></p><p>写成：<code>((-0.0464964749fx^2 + 0.15931422f)x^2 - 0.327622764f)x^3 + x</code></p><p><img src="'+c+`" alt="alt text"></p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token comment">// s := a * a</span></span>
<span class="line"><span class="token keyword">float</span> s <span class="token operator">=</span> a <span class="token operator">*</span> a<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// r := ((-0.0464964749 * s + 0.15931422) * s - 0.327622764) * s * a + a</span></span>
<span class="line"><span class="token keyword">float</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.0464964749f</span> <span class="token operator">*</span> s <span class="token operator">+</span> <span class="token number">0.15931422f</span><span class="token punctuation">)</span> <span class="token operator">*</span> s <span class="token operator">-</span> <span class="token number">0.327622764f</span><span class="token punctuation">)</span> <span class="token operator">*</span> s <span class="token operator">*</span> a <span class="token operator">+</span> a<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><strong>根据(x,y)所在象限计算<code>arctan2</code></strong></p><p>下面的<code>1.57079637f</code>为90° <code>3.14159274f</code>为180°</p><p>如果<code>abs_y &gt; abs_x</code>那么上面实际计算的是<code>arctan(a=x/y)</code>，<br> 否则，实际计算的是<code>arctan(a=y/z)</code></p><p>根据公式：<code>arctan(z)=π/2−arctan(1/z)</code><br> 所以<code>r = 1.57079637f - r</code></p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token comment">// if |y| &gt; |x| then r := 1.57079637 - r</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>abs_y <span class="token operator">&gt;</span> abs_x<span class="token punctuation">)</span> r <span class="token operator">=</span> <span class="token number">1.57079637f</span> <span class="token operator">-</span> r<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>x&lt;0</code> 可以认为是将r从第一或四象限翻转到第二或三象限：</p><p><img src="`+i+`" alt="alt text"></p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token comment">// if x &lt; 0 then r := 3.14159274 - r</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> r <span class="token operator">=</span> <span class="token number">3.14159274f</span> <span class="token operator">-</span> r<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>y&lt;0</code> 可以认为是将r从第一或二象限翻转到第三或四象限：</p><p><img src="`+m+`" alt="alt text"></p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token comment">// if y &lt; 0 then r := -r</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> r <span class="token operator">=</span> <span class="token operator">-</span>r<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="源代码" tabindex="-1"><a class="header-anchor" href="#源代码"><span>源代码</span></a></h2><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;foc_utils.h&quot;</span></span></span>
<span class="line"><span class="token comment">// fast_atan2 based on https://math.stackexchange.com/a/1105038/81278</span></span>
<span class="line"><span class="token comment">// Via Odrive project</span></span>
<span class="line"><span class="token comment">// https://github.com/odriverobotics/ODrive/blob/master/Firmware/MotorControl/utils.cpp</span></span>
<span class="line"><span class="token comment">// This function is MIT licenced, copyright Oskar Weigl/Odrive Robotics</span></span>
<span class="line"><span class="token comment">// The origin for Odrive atan2 is public domain. Thanks to Odrive for making</span></span>
<span class="line"><span class="token comment">// it easy to borrow.</span></span>
<span class="line"><span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>weak<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">float</span> <span class="token function">_atan2</span><span class="token punctuation">(</span><span class="token keyword">float</span> y<span class="token punctuation">,</span> <span class="token keyword">float</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// a := min (|x|, |y|) / max (|x|, |y|)</span></span>
<span class="line">    <span class="token keyword">float</span> abs_y <span class="token operator">=</span> <span class="token function">fabsf</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">float</span> abs_x <span class="token operator">=</span> <span class="token function">fabsf</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// inject FLT_MIN in denominator to avoid division by zero</span></span>
<span class="line">    <span class="token keyword">float</span> a <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>abs_x<span class="token punctuation">,</span> abs_y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>abs_x<span class="token punctuation">,</span> abs_y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// s := a * a</span></span>
<span class="line">    <span class="token keyword">float</span> s <span class="token operator">=</span> a <span class="token operator">*</span> a<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// r := ((-0.0464964749 * s + 0.15931422) * s - 0.327622764) * s * a + a</span></span>
<span class="line">    <span class="token keyword">float</span> r <span class="token operator">=</span></span>
<span class="line">        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.0464964749f</span> <span class="token operator">*</span> s <span class="token operator">+</span> <span class="token number">0.15931422f</span><span class="token punctuation">)</span> <span class="token operator">*</span> s <span class="token operator">-</span> <span class="token number">0.327622764f</span><span class="token punctuation">)</span> <span class="token operator">*</span> s <span class="token operator">*</span> a <span class="token operator">+</span> a<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// if |y| &gt; |x| then r := 1.57079637 - r</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>abs_y <span class="token operator">&gt;</span> abs_x<span class="token punctuation">)</span> r <span class="token operator">=</span> <span class="token number">1.57079637f</span> <span class="token operator">-</span> r<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// if x &lt; 0 then r := 3.14159274 - r</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> r <span class="token operator">=</span> <span class="token number">3.14159274f</span> <span class="token operator">-</span> r<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// if y &lt; 0 then r := -r</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> r <span class="token operator">=</span> <span class="token operator">-</span>r<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> r<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,20),E=[r,u,h,d,g,y,k,v,x,b,f,_,w,z];function A(B,C){return e(),l("div",null,E)}const D=t(o,[["render",A],["__file","快速反正切计算.html.vue"]]),O=JSON.parse('{"path":"/%E7%94%B5%E5%AD%90/SimpleFOC%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%BF%AB%E9%80%9F%E5%8F%8D%E6%AD%A3%E5%88%87%E8%AE%A1%E7%AE%97.html","title":"SimpleFOC源码阅读学习笔记：快速反正切函数","lang":"zh-CN","frontmatter":{"title":"SimpleFOC源码阅读学习笔记：快速反正切函数","shortTitle":"快速反正切函数","date":"2024-09-06T14:38:00.000Z","article":false,"index":true,"description":"原理 这段SimpleFOC的代码实际来自开源项目ODrive的utils.cpp， 理论依据来自stackexchange中的一篇问答， 下面尝试记录对该函数的理解。 arctan2(z)的计算过程 参数化简：计算a := min (|x|, |y|) / max (|x|, |y|)，使得a∈[0,1]。 多项式逼近：使用一个多项式来近似计算 ar...","head":[["meta",{"property":"og:url","content":"https://dingdingdang.online/%E7%94%B5%E5%AD%90/SimpleFOC%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%BF%AB%E9%80%9F%E5%8F%8D%E6%AD%A3%E5%88%87%E8%AE%A1%E7%AE%97.html"}],["meta",{"property":"og:site_name","content":"YiguiDing的Blog小站"}],["meta",{"property":"og:title","content":"SimpleFOC源码阅读学习笔记：快速反正切函数"}],["meta",{"property":"og:description","content":"原理 这段SimpleFOC的代码实际来自开源项目ODrive的utils.cpp， 理论依据来自stackexchange中的一篇问答， 下面尝试记录对该函数的理解。 arctan2(z)的计算过程 参数化简：计算a := min (|x|, |y|) / max (|x|, |y|)，使得a∈[0,1]。 多项式逼近：使用一个多项式来近似计算 ar..."}],["meta",{"property":"og:type","content":"website"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-11-25T05:39:45.000Z"}],["meta",{"property":"article:author","content":"丁毅桂"}],["meta",{"property":"article:published_time","content":"2024-09-06T14:38:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-11-25T05:39:45.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"WebPage\\",\\"name\\":\\"SimpleFOC源码阅读学习笔记：快速反正切函数\\",\\"description\\":\\"原理 这段SimpleFOC的代码实际来自开源项目ODrive的utils.cpp， 理论依据来自stackexchange中的一篇问答， 下面尝试记录对该函数的理解。 arctan2(z)的计算过程 参数化简：计算a := min (|x|, |y|) / max (|x|, |y|)，使得a∈[0,1]。 多项式逼近：使用一个多项式来近似计算 ar...\\"}"],["meta",{"name":"baidu-site-verification","content":"codeva-PwE9Ts6nMl"}]]},"headers":[{"level":2,"title":"原理","slug":"原理","link":"#原理","children":[]},{"level":2,"title":"源代码","slug":"源代码","link":"#源代码","children":[]}],"git":{"createdTime":1725606011000,"updatedTime":1732513185000,"contributors":[{"name":"YiguiDing","email":"2449695354@qq.com","commits":3}]},"readingTime":{"minutes":3.04,"words":913},"filePathRelative":"电子/SimpleFOC源码阅读学习笔记/快速反正切计算.md","localizedDate":"2024年9月6日","excerpt":"","autoDesc":true}');export{D as comp,O as data};
