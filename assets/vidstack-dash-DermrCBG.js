var bt=Object.defineProperty;var B=n=>{throw TypeError(n)};var vt=(n,t,e)=>t in n?bt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var q=(n,t,e)=>vt(n,typeof t!="symbol"?t+"":t,e),H=(n,t,e)=>t.has(n)||B("Cannot "+e);var i=(n,t,e)=>(H(n,t,"read from private field"),e?e.call(n):t.get(n)),l=(n,t,e)=>t.has(n)?B("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),c=(n,t,e,r)=>(H(n,t,"write to private field"),r?r.call(n,e):t.set(n,e),e),o=(n,t,e)=>(H(n,t,"access private method"),e);import{r as wt,g as R,p as Et,h as Lt,Q as K,l as Y,j as At,D as x,k as Dt,e as _,T as xt,L as N,t as kt,u as Mt,a as Ct,I as Nt,i as W,m as Rt,n as Ft,q as It}from"./app-C4NnifZf.js";import{VideoProvider as Pt}from"./vidstack-video-Cp3KCRm1.js";import{R as qt}from"./vidstack-DqAw8m9J-Ni4ar6u2.js";import"./vidstack-Bq6c3Bam-hYz0vtut.js";function z(n){try{return new Intl.DisplayNames(navigator.languages,{type:"language"}).of(n)??null}catch{return null}}const _t=n=>`dash-${Dt(n)}`;var v,h,a,k,M,s,A,X,Z,tt,b,C,it,et,st,nt,at,rt,ot,dt,w,ht,$,O,ct,Q,lt,ut,G;class $t{constructor(t,e){l(this,s);l(this,v);l(this,h);l(this,a,null);l(this,k,new Set);l(this,M,null);q(this,"config",{});l(this,b,null);l(this,C,{});l(this,w,-1);c(this,v,t),c(this,h,e)}get instance(){return i(this,a)}setup(t){c(this,a,t().create());const e=o(this,s,tt).bind(this);for(const r of Object.values(t.events))i(this,a).on(r,e);i(this,a).on(t.events.ERROR,o(this,s,rt).bind(this));for(const r of i(this,k))r(i(this,a));i(this,h).player.dispatch("dash-instance",{detail:i(this,a)}),i(this,a).initialize(i(this,v),void 0,!1),i(this,a).updateSettings({streaming:{text:{defaultEnabled:!1,dispatchForManualRendering:!0},buffer:{fastSwitchEnabled:!0}},...this.config}),i(this,a).on(t.events.FRAGMENT_LOADING_STARTED,o(this,s,ot).bind(this)),i(this,a).on(t.events.FRAGMENT_LOADING_COMPLETED,o(this,s,dt).bind(this)),i(this,a).on(t.events.MANIFEST_LOADED,o(this,s,at).bind(this)),i(this,a).on(t.events.QUALITY_CHANGE_RENDERED,o(this,s,nt).bind(this)),i(this,a).on(t.events.TEXT_TRACKS_ADDED,o(this,s,et).bind(this)),i(this,a).on(t.events.TRACK_CHANGE_RENDERED,o(this,s,st).bind(this)),i(this,h).qualities[K.enableAuto]=o(this,s,ct).bind(this),Y(i(this,h).qualities,"change",o(this,s,lt).bind(this)),Y(i(this,h).audioTracks,"change",o(this,s,ut).bind(this)),c(this,M,At(o(this,s,X).bind(this)))}onInstance(t){return i(this,k).add(t),()=>i(this,k).delete(t)}loadSource(t){o(this,s,G).call(this),R(t.src)&&i(this,a)?.attachSource(t.src)}destroy(){var t;o(this,s,G).call(this),i(this,a)?.destroy(),c(this,a,null),(t=i(this,M))==null||t.call(this),c(this,M,null)}}v=new WeakMap,h=new WeakMap,a=new WeakMap,k=new WeakMap,M=new WeakMap,s=new WeakSet,A=function(t){return new x(_t(t.type),{detail:t})},X=function(){if(!i(this,h).$state.live())return;const t=new qt(o(this,s,Z).bind(this));return t.start(),t.stop.bind(t)},Z=function(){if(!i(this,a))return;const t=i(this,a).duration()-i(this,a).time();i(this,h).$state.liveSyncPosition.set(isNaN(t)?1/0:t)},tt=function(t){i(this,h).player?.dispatch(o(this,s,A).call(this,t))},b=new WeakMap,C=new WeakMap,it=function(t){const e=i(this,b)?.[_.native],r=(e?.track).cues;if(!e||!r)return;const p=i(this,b).id,u=i(this,C)[p]??0,f=o(this,s,A).call(this,t);for(let L=u;L<r.length;L++){const m=r[L];m.positionAlign||(m.positionAlign="auto"),i(this,b).addCue(m,f)}i(this,C)[p]=r.length},et=function(t){if(!i(this,a))return;const e=t.tracks,r=[...i(this,v).textTracks].filter(u=>"manualMode"in u),p=o(this,s,A).call(this,t);for(let u=0;u<r.length;u++){const f=e[u],L=r[u],m=`dash-${f.kind}-${u}`,g=new xt({id:m,label:f?.label??f.labels.find(j=>j.text)?.text??(f?.lang&&z(f.lang))??f?.lang??void 0,language:f.lang??void 0,kind:f.kind,default:f.defaultTrack});g[_.native]={managed:!0,track:L},g[_.readyState]=2,g[_.onModeChange]=()=>{i(this,a)&&(g.mode==="showing"?(i(this,a).setTextTrack(u),c(this,b,g)):(i(this,a).setTextTrack(-1),c(this,b,null)))},i(this,h).textTracks.add(g,p)}},st=function(t){const{mediaType:e,newMediaInfo:r}=t;if(e==="audio"){const p=i(this,h).audioTracks.getById(`dash-audio-${r.index}`);if(p){const u=o(this,s,A).call(this,t);i(this,h).audioTracks[N.select](p,!0,u)}}},nt=function(t){if(t.mediaType!=="video")return;const e=i(this,h).qualities[t.newQuality];if(e){const r=o(this,s,A).call(this,t);i(this,h).qualities[N.select](e,!0,r)}},at=function(t){if(i(this,h).$state.canPlay()||!i(this,a))return;const{type:e,mediaPresentationDuration:r}=t.data,p=o(this,s,A).call(this,t);i(this,h).notify("stream-type-change",e!=="static"?"live":"on-demand",p),i(this,h).notify("duration-change",r,p),i(this,h).qualities[K.setAuto](!0,p);const u=i(this,a).getVideoElement(),f=i(this,a).getTracksForTypeFromManifest("video",t.data),L=[...new Set(f.map(d=>d.mimeType))].find(d=>d&&kt(u,d)),m=f.filter(d=>L===d.mimeType)[0];let g=i(this,a).getTracksForTypeFromManifest("audio",t.data);const j=[...new Set(g.map(d=>d.mimeType))].find(d=>d&&Mt(u,d));if(g=g.filter(d=>j===d.mimeType),m.bitrateList.forEach((d,P)=>{const V={id:d.id?.toString()??`dash-bitrate-${P}`,width:d.width??0,height:d.height??0,bitrate:d.bandwidth??0,codec:m.codec,index:P};i(this,h).qualities[N.add](V,p)}),Ct(m.index)){const d=i(this,h).qualities[m.index];d&&i(this,h).qualities[N.select](d,!0,p)}g.forEach((d,P)=>{const mt=d.labels.find(U=>navigator.languages.some(St=>U.lang&&St.toLowerCase().startsWith(U.lang.toLowerCase())))||d.labels[0],Tt={id:`dash-audio-${d?.index}`,label:mt?.text??(d.lang&&z(d.lang))??d.lang??"",language:d.lang??"",kind:"main",mimeType:d.mimeType,codec:d.codec,index:P};i(this,h).audioTracks[N.add](Tt,p)}),u.dispatchEvent(new x("canplay",{trigger:p}))},rt=function(t){const{type:e,error:r}=t;switch(r.code){case 27:o(this,s,ht).call(this,r);break;default:o(this,s,O).call(this,r);break}},ot=function(){i(this,w)>=0&&o(this,s,$).call(this)},dt=function(t){t.mediaType==="text"&&requestAnimationFrame(o(this,s,it).bind(this,t))},w=new WeakMap,ht=function(t){o(this,s,$).call(this),i(this,a)?.play(),c(this,w,window.setTimeout(()=>{c(this,w,-1),o(this,s,O).call(this,t)},5e3))},$=function(){clearTimeout(i(this,w)),c(this,w,-1)},O=function(t){i(this,h).notify("error",{message:t.message??"",code:1,error:t})},ct=function(){o(this,s,Q).call(this,"video",!0);const{qualities:t}=i(this,h);i(this,a)?.setQualityFor("video",t.selectedIndex,!0)},Q=function(t,e){i(this,a)?.updateSettings({streaming:{abr:{autoSwitchBitrate:{[t]:e}}}})},lt=function(){const{qualities:t}=i(this,h);!i(this,a)||t.auto||!t.selected||(o(this,s,Q).call(this,"video",!1),i(this,a).setQualityFor("video",t.selectedIndex,t.switch==="current"),Nt&&(i(this,v).currentTime=i(this,v).currentTime))},ut=function(){if(!i(this,a))return;const{audioTracks:t}=i(this,h),e=i(this,a).getTracksFor("audio").find(r=>t.selected&&t.selected.id===`dash-audio-${r.index}`);e&&i(this,a).setCurrentTrack(e)},G=function(){o(this,s,$).call(this),c(this,b,null),c(this,C,{})};var D,T,F,S,pt,ft,gt,yt;class jt{constructor(t,e,r){l(this,S);l(this,D);l(this,T);l(this,F);c(this,D,t),c(this,T,e),c(this,F,r),o(this,S,pt).call(this)}}D=new WeakMap,T=new WeakMap,F=new WeakMap,S=new WeakSet,pt=async function(){const t={onLoadStart:o(this,S,ft).bind(this),onLoaded:o(this,S,gt).bind(this),onLoadError:o(this,S,yt).bind(this)};let e=await Ot(i(this,D),t);if(W(e)&&!R(i(this,D))&&(e=await Ht(i(this,D),t)),!e)return null;if(!window.dashjs.supportsMediaSource()){const r="[vidstack] `dash.js` is not supported in this environment";return i(this,T).player.dispatch(new x("dash-unsupported")),i(this,T).notify("error",{message:r,code:4}),null}return e},ft=function(){i(this,T).player.dispatch(new x("dash-lib-load-start"))},gt=function(t){i(this,T).player.dispatch(new x("dash-lib-loaded",{detail:t})),i(this,F).call(this,t)},yt=function(t){const e=Rt(t);i(this,T).player.dispatch(new x("dash-lib-load-error",{detail:e})),i(this,T).notify("error",{message:e.message,code:4,error:e})};async function Ht(n,t={}){if(!W(n)){if(t.onLoadStart?.(),Qt(n))return t.onLoaded?.(n),n;if(J(n)){const e=n.MediaPlayer;return t.onLoaded?.(e),e}try{const e=(await n())?.default;if(J(e))return t.onLoaded?.(e.MediaPlayer),e.MediaPlayer;if(e)t.onLoaded?.(e);else throw Error("");return e}catch(e){t.onLoadError?.(e)}}}async function Ot(n,t={}){if(R(n)){t.onLoadStart?.();try{if(await Ft(n),!It(window.dashjs.MediaPlayer))throw Error("");const e=window.dashjs.MediaPlayer;return t.onLoaded?.(e),e}catch(e){t.onLoadError?.(e)}}}function Qt(n){return n&&n.prototype&&n.prototype!==Function}function J(n){return n&&"MediaPlayer"in n}const Gt="https://cdn.jsdelivr.net";var I,y,E;class Vt extends Pt{constructor(){super(...arguments);q(this,"$$PROVIDER_TYPE","DASH");l(this,I,null);l(this,y,new $t(this.video,this.ctx));l(this,E,`${Gt}/npm/dashjs@4.7.4/dist/dash.all.min.js`)}get ctor(){return i(this,I)}get instance(){return i(this,y).instance}get type(){return"dash"}get canLiveSync(){return!0}get config(){return i(this,y).config}set config(e){i(this,y).config=e}get library(){return i(this,E)}set library(e){c(this,E,e)}preconnect(){R(i(this,E))&&Et(i(this,E))}setup(){super.setup(),new jt(i(this,E),this.ctx,e=>{c(this,I,e),i(this,y).setup(e),this.ctx.notify("provider-setup",this);const r=Lt(this.ctx.$state.source);r&&this.loadSource(r)})}async loadSource(e,r){if(!R(e.src)){this.removeSource();return}this.media.preload=r||"",this.appendSource(e,"application/x-mpegurl"),i(this,y).loadSource(e),this.currentSrc=e}onInstance(e){const r=i(this,y).instance;return r&&e(r),i(this,y).onInstance(e)}destroy(){i(this,y).destroy()}}I=new WeakMap,y=new WeakMap,E=new WeakMap,q(Vt,"supported",wt());export{Vt as DASHProvider};
