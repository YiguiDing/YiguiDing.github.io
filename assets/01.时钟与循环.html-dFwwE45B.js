import{_ as n,c as s,o as a,b as p}from"./app-B9UCYg74.js";const e={},t=p(`<h1 id="时钟与循环" tabindex="-1"><a class="header-anchor" href="#时钟与循环"><span>时钟与循环</span></a></h1><p>最近在尝试写一个博客插件，洛克王国版的看板娘，想把宠物放到博客网站上。<br> 于是昨天看了open-flash这个库的的实现，感觉这个库虽然stars不多，但是代码质量却非常高，这里简要对其中的一些代码做一些笔记。</p><p>这个库分成了多个子库</p><ul><li>swf-types swf文件的抽象语法树定义，原先叫swf-tree</li><li>swf-parser 解析器</li><li>swf-renderer 渲染器</li><li>domu-player 基于上面这些库实现的播放器</li></ul><h2 id="使用" tabindex="-1"><a class="header-anchor" href="#使用"><span>使用</span></a></h2><blockquote><p>利用下面将要介绍的时钟和循环，程序可以相当简洁和完美！</p></blockquote><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createClock <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./services/clock&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> startLoop <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./services/loop&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> PausableClock<span class="token punctuation">,</span> SchedulableClock<span class="token punctuation">,</span> Loop <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./types&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span></span>
<span class="line">  clock<span class="token operator">:</span> SchedulableClock <span class="token operator">&amp;</span> PausableClock<span class="token punctuation">;</span></span>
<span class="line">  mainLoop<span class="token operator">:</span> Loop<span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 这里的时钟可以暂停运行和恢复运行</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>clock <span class="token operator">=</span> <span class="token function">createClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// 这里的主循环将受到时钟的控制</span></span>
<span class="line">    <span class="token comment">// 并且当运行速度低于规定的帧率时，主循环会自动执行那些应当执行但未执行的tick</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>mainLoop <span class="token operator">=</span> <span class="token function">startLoop</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clock<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">onTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>mainLoop<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="时钟的接口定义" tabindex="-1"><a class="header-anchor" href="#时钟的接口定义"><span>时钟的接口定义</span></a></h2><p>可以获取当前时间的时钟 <code>Clock</code></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Clock</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以延时执行任务的时钟 <code>SchedulableClock</code></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">TimerHandle</span> <span class="token operator">=</span> object<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">SchedulableClock<span class="token operator">&lt;</span><span class="token constant">H</span> <span class="token operator">=</span> TimerHandle<span class="token operator">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Clock</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">setTimeout</span><span class="token punctuation">(</span>timeout<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">H</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">clearTimeout</span><span class="token punctuation">(</span>handle<span class="token operator">:</span> <span class="token constant">H</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以暂停和恢复的时钟 <code>PausableClock</code></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PausableClock</span> <span class="token keyword">extends</span> <span class="token class-name">Clock</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以销毁的循环</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Loop</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="clock时钟" tabindex="-1"><a class="header-anchor" href="#clock时钟"><span>Clock时钟</span></a></h2><h3 id="systemclock系统时钟" tabindex="-1"><a class="header-anchor" href="#systemclock系统时钟"><span>SystemClock系统时钟</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Clock<span class="token punctuation">,</span> PausableClock<span class="token punctuation">,</span> SchedulableClock<span class="token punctuation">,</span> TimerHandle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../types&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 创建系统时钟</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createSystemClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> SchedulableClock <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 系统原生的定时器句柄</span></span>
<span class="line">  <span class="token keyword">type</span> <span class="token class-name">NativeTimerHandle</span> <span class="token operator">=</span> <span class="token builtin">number</span> <span class="token operator">|</span> NodeJS<span class="token punctuation">.</span>Timer<span class="token punctuation">;</span> </span>
<span class="line">  <span class="token comment">// 维护定时器句柄和系统原生的定时器句柄 利用WeakMap实现弱引用 </span></span>
<span class="line">  <span class="token keyword">const</span> handles<span class="token operator">:</span> WeakMap<span class="token operator">&lt;</span>TimerHandle<span class="token punctuation">,</span> NativeTimerHandle<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// Object.freeze 可以防止对对象上的属性和值的修改，防止填写新属性,</span></span>
<span class="line">  <span class="token comment">// 简单来说就是锁定对象的属性</span></span>
<span class="line">  <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 提供Date.now获取系统实现</span></span>
<span class="line">    getTime<span class="token operator">:</span> Date<span class="token punctuation">.</span>now<span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 创建延时执行的定时器，返回一个定时器句柄，</span></span>
<span class="line">    <span class="token comment">// 这个句柄不是系统原生句柄，这样这个定时器句柄就只能被自己销毁。</span></span>
<span class="line">    <span class="token function">setTimeout</span><span class="token punctuation">(</span>timeout<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> TimerHandle <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 创建系统原生定时任务，得到系统原生定时器句柄</span></span>
<span class="line">      <span class="token keyword">const</span> nativeHandle<span class="token operator">:</span> NativeTimerHandle <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 创建一个唯一的符号作为定时器句柄来代表这个系统原生定时器</span></span>
<span class="line">      <span class="token keyword">const</span> handle<span class="token operator">:</span> TimerHandle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 将定时器句柄和系统原生定时器句柄作为键值对保存</span></span>
<span class="line">      handles<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> nativeHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 返回定时器句柄</span></span>
<span class="line">      <span class="token keyword">return</span> handle<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 取消一个定时任务，需要提供一个定时器句柄而不是系统原生定时器句柄</span></span>
<span class="line">    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>handle<span class="token operator">:</span> TimerHandle<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 通过定时器句柄找到系统原生定时器句柄</span></span>
<span class="line">      <span class="token keyword">const</span> nativeHandle<span class="token operator">:</span> NativeTimerHandle <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> handles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 如果能找到这个系统原生定时器句柄</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>nativeHandle <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 通过系统原生定时器句柄来取消定时任务</span></span>
<span class="line">        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>nativeHandle <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// 系统时钟常量</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">SYSTEM_CLOCK</span><span class="token operator">:</span> SchedulableClock <span class="token operator">=</span> <span class="token function">createSystemClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="childclock子时钟" tabindex="-1"><a class="header-anchor" href="#childclock子时钟"><span>ChildClock子时钟</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * Represents a currently scheduled task in a \`ChildClock\`.</span>
<span class="line"> * 代表了ChildClock子时钟上的一个延时执行的任务</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">interface</span> <span class="token class-name">Task</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token doc-comment comment">/**</span>
<span class="line">   * Time in the current clock when this task should be executed.</span>
<span class="line">   * 目标时间，当前任务应当被执行的时间，这个时间是ChildClock子时钟的时间</span>
<span class="line">   */</span></span>
<span class="line">  targetTime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token doc-comment comment">/**</span>
<span class="line">   * Timer handle received by the parent clock when scheduling the task.</span>
<span class="line">   * This is undefined when the task is not scheduled (when the clock is paused).</span>
<span class="line">   * 一个定时器句柄。</span>
<span class="line">   * 当子时钟运行时，新添加的定时任务会派发给父时钟，父时钟会返回一个定时器句柄。</span>
<span class="line">   * 当子时钟暂停后，新添加的定时任务不会派发给父时钟，所以句柄为undefined。</span>
<span class="line">   * 当子时钟暂停时，所有定时任务都要通过这个句柄来向父时钟取消</span>
<span class="line">   * 当子时钟恢复时，所有定时任务又需要全部重新派发给父时钟，同时将返回的定时器句柄保存。</span>
<span class="line">   */</span></span>
<span class="line">  handle<span class="token operator">?</span><span class="token operator">:</span> TimerHandle<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token doc-comment comment">/**</span>
<span class="line">   * Handler function triggered once the timeout is complete.</span>
<span class="line">   * 一个定时回调函数，会被父时钟执行一次。</span>
<span class="line">   */</span></span>
<span class="line">  <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * Represents a node in a clock tree.</span>
<span class="line"> * ChildClock代表时钟树上的一个节点</span>
<span class="line"> * 可以暂停，可以派发定时任务</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ChildClock</span> <span class="token keyword">implements</span> <span class="token class-name">PausableClock</span><span class="token punctuation">,</span> SchedulableClock <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 父时钟是一个SchedulableClock可以派发任务的时钟</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">readonly</span> parent<span class="token operator">:</span> SchedulableClock<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token doc-comment comment">/**</span>
<span class="line">   * Origin of time for this clock.</span>
<span class="line">   * Relative to parent clock, or the UNIX epoch for the root clock.</span>
<span class="line">   * Resuming the clock will update the update to maintain the continuity of the time (no time is skipped).</span>
<span class="line">   * 当前时钟树的时间</span>
<span class="line">   * 相对于父时钟或UNIX时间</span>
<span class="line">   * 当暂停时，这个epoch会更新，已保证当前时钟的连续不间断。</span>
<span class="line">   */</span></span>
<span class="line">  <span class="token keyword">private</span> epoch<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token doc-comment comment">/**</span>
<span class="line">   * If this clock is not paused \`undefined\`, otherwise it is the time in the parent clock when \`pause\` was called.</span>
<span class="line">   * 暂停时间，该时间是父时钟的时间。</span>
<span class="line">   */</span></span>
<span class="line">  <span class="token keyword">private</span> pausedAt<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token doc-comment comment">/**</span>
<span class="line">   * Map from outer handles to task states.</span>
<span class="line">   * 定时器句柄和定时任务的句柄</span>
<span class="line">   * 这个定时器任务句柄不是父时钟返回的原始句柄，</span>
<span class="line">   * 而是当前时钟为该任务创建的唯一的句柄</span>
<span class="line">   * 这样用户就不能拿着这个句柄像父时钟取消</span>
<span class="line">   * 要取消这个任务只有当前时钟能取消。</span>
<span class="line">   */</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">readonly</span> tasks<span class="token operator">:</span> Map<span class="token operator">&lt;</span>TimerHandle<span class="token punctuation">,</span> Task<span class="token operator">&gt;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token doc-comment comment">/**</span>
<span class="line">   * <span class="token keyword">@param</span> <span class="token parameter">parent</span> Parent clock</span>
<span class="line">   * <span class="token keyword">@param</span> <span class="token parameter">initialEpoch</span> Time in the parent clock corresponding to the zero time in the child clock.</span>
<span class="line">   *                     Default is parent.getTime().</span>
<span class="line">   * </span>
<span class="line">   * parent：构造函数，需要提供一个父时钟</span>
<span class="line">   * initialEpoch：和当前时钟节点的初始时间</span>
<span class="line">   *    + 在联机对战游戏中，应该就可以把这个initialEpoch设置为服务器时钟的时间。</span>
<span class="line">   *    + 这样所有客户端都将以服务端的时钟运行。</span>
<span class="line">   *    + 服务器运行在第10个tick，客户端也将运行在第10个tick</span>
<span class="line">   */</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> SchedulableClock<span class="token punctuation">,</span> initialEpoch<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 默认值为父时钟时间，这意味着，当前时钟getTime()会得到从0开始的值</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>epoch <span class="token operator">=</span> initialEpoch <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> initialEpoch <span class="token operator">:</span> parent<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>pausedAt <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 这里没有使用弱引用，因为这里就是保存task数据的地方</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 判断是否暂停</span></span>
<span class="line">  <span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pausedAt <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token doc-comment comment">/**</span>
<span class="line">   * <span class="token keyword">@return</span> Time in milliseconds</span>
<span class="line">   * 获取当前时间，这个时间是当前时钟的时间。</span>
<span class="line">   * 这个时钟通过父时钟来计算，这意味着当父时钟暂停时，当前时钟也会暂停。</span>
<span class="line">   */</span></span>
<span class="line">  <span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 这里源作者的代码有错误，下面是已经修改过后的</span></span>
<span class="line">    <span class="token comment">// epoch可以认为是当前时钟开始运行时的那一刻父时钟的时间</span></span>
<span class="line">    <span class="token comment">// 当在运行时，当前时间就是 父时钟当前时间-epoch开始时间</span></span>
<span class="line">    <span class="token comment">// 当在暂停时，当前时间就是，暂停的那一刻父时钟的时间pausedAt - epoch开始时间</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pausedAt <span class="token operator">!==</span> <span class="token keyword">undefined</span></span>
<span class="line">      <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pausedAt <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>epoch</span>
<span class="line">      <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>epoch<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 暂停时钟</span></span>
<span class="line">  <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pausedAt <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 记录暂停时父时钟的时间</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>pausedAt <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 取消所有已经派发的任务</span></span>
<span class="line">      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> task <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>handle <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">clearTimeout</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          task<span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 恢复时钟的运行</span></span>
<span class="line">  <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pausedAt <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 修改epoch，这是为了保证this.getTime()始终能获取到当前时钟的时间,保证当前时间的连续不间断。</span></span>
<span class="line">      <span class="token comment">// this.epoch+=父时钟经过的时间</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>epoch <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pausedAt<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>pausedAt <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 恢复所有任务</span></span>
<span class="line">      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> task <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        task<span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span></span>
<span class="line">          <span class="token comment">// targetTime是在当前时钟的时间，减去当前时间就是延迟时间</span></span>
<span class="line">          task<span class="token punctuation">.</span>targetTime <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">          task<span class="token punctuation">.</span>handler</span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">setTimeout</span><span class="token punctuation">(</span>timeout<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> TimerHandle <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 创建符号代表当前时钟的任务句柄</span></span>
<span class="line">    <span class="token keyword">const</span> outerHandle<span class="token operator">:</span> TimerHandle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 创建任务</span></span>
<span class="line">    <span class="token keyword">const</span> task<span class="token operator">:</span> Task <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 目标时间是当前时钟的时间+延迟</span></span>
<span class="line">      targetTime<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timeout<span class="token punctuation">,</span></span>
<span class="line">      handler<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 执行后需要销毁任务数据</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>outerHandle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 执行任务</span></span>
<span class="line">        <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      handle<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 保存任务</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>outerHandle<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 当前时钟没有暂停就时钟想父时钟派发任务</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pausedAt <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 保存父时钟返回的任务句柄</span></span>
<span class="line">      task<span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> task<span class="token punctuation">.</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 返回子时钟的任务句柄</span></span>
<span class="line">    <span class="token keyword">return</span> outerHandle<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 提供一个当前时钟的任务句柄，销毁任务 </span></span>
<span class="line">  <span class="token function">clearTimeout</span><span class="token punctuation">(</span>handle<span class="token operator">:</span> TimerHandle<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 通过任务句柄查询任务</span></span>
<span class="line">    <span class="token keyword">const</span> task<span class="token operator">:</span> Task <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 有父时钟句柄说明这个任务在父时钟里面</span></span>
<span class="line">      <span class="token comment">// 因为当当前时钟暂停时，这些任务已经从父时钟里取消了</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>handle <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 通过任务的父时钟句柄来销毁任务</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">clearTimeout</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token comment">// 在当前时钟里取消任务</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * Create a new root clock based off real time.</span>
<span class="line"> * Its epoch defaults to \`now\`. You can provide you own epoch relative to the UNIX epoch (expressed in milliseconds).</span>
<span class="line"> *</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token punctuation">{</span>number<span class="token punctuation">}</span> epoch</span>
<span class="line"> * <span class="token keyword">@return</span> <span class="token punctuation">{</span>Clock<span class="token punctuation">}</span></span>
<span class="line"> * </span>
<span class="line"> * 创建一个可暂停、可派发任务的时钟，这个时钟基于系统时钟。</span>
<span class="line"> * epoch默认为创建时间，这意味着这个时钟getTime()是从0开始运行的。</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createClock</span><span class="token punctuation">(</span></span>
<span class="line">  epoch<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token constant">SYSTEM_CLOCK</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> SchedulableClock <span class="token operator">&amp;</span> PausableClock <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ChildClock</span><span class="token punctuation">(</span><span class="token constant">SYSTEM_CLOCK</span><span class="token punctuation">,</span> epoch<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="loop循环" tabindex="-1"><a class="header-anchor" href="#loop循环"><span>loop循环</span></a></h2><blockquote><p>这个循环基于时钟来实现，个人感觉这段代码写的非常漂亮。</p></blockquote><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> SchedulableClock<span class="token punctuation">,</span> TimerHandle<span class="token punctuation">,</span> Loop <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../types&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * The first tick is after \`1000 / frameRate\` ms.</span>
<span class="line"> *</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">clock</span> Clock used to control the loop. 一个用来控制当前循环运行的时钟</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">frameRate</span> Ticks per second 帧率</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">onTick</span> 回调函数</span>
<span class="line"> * <span class="token keyword">@return</span> <span class="token punctuation">{</span>Loop<span class="token punctuation">}</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">startLoop</span><span class="token punctuation">(</span></span>
<span class="line">  clock<span class="token operator">:</span> SchedulableClock<span class="token punctuation">,</span></span>
<span class="line">  frameRate<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token function-variable function">onTick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> Loop <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 用来记录当前时刻的时间和上一时刻的时间，方便推算经过的时间</span></span>
<span class="line">  <span class="token keyword">const</span> startTime<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> clock<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> oldTime<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> startTime<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// </span></span>
<span class="line">  <span class="token keyword">let</span> shift<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 记录tick数</span></span>
<span class="line">  <span class="token keyword">let</span> nextTickCount<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 记录定时器回调的句柄，通过这个句柄能结束循环</span></span>
<span class="line">  <span class="token keyword">let</span> handle<span class="token operator">:</span> TimerHandle <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 定时回调函数</span></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">handleTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">onTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行tick</span></span>
<span class="line">    <span class="token function">scheduleNextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 安排下一次tick</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">scheduleNextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 获取当前时间</span></span>
<span class="line">    <span class="token keyword">const</span> curTime<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> clock<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextTickCount <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> curTime <span class="token operator">===</span> oldTime<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// tslint:disable-next-line:max-line-length</span></span>
<span class="line">      <span class="token keyword">const</span> infoUri<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span></span>
<span class="line">        <span class="token string">&quot;https://developer.mozilla.org/en-US/docs/Web/API/DOMHighResTimeStamp#Reduced_time_precision&quot;</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\\\`curTime === oldTime\\\`, possible reduced time precision, see </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>infoUri<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    oldTime <span class="token operator">=</span> curTime<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// console.log(clock.getTime());</span></span>
<span class="line">    <span class="token comment">// 自增</span></span>
<span class="line">    nextTickCount<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 计算下一时刻的时间，可以先不看shift</span></span>
<span class="line">    <span class="token comment">// targetTime = startTime开始时间 + fps周期 * nextTickCount周期数</span></span>
<span class="line">    <span class="token comment">// shift 是为了在tick的执行速度太慢时</span></span>
<span class="line">    <span class="token keyword">const</span> targetTime<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span></span>
<span class="line">      startTime <span class="token operator">+</span> shift <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> nextTickCount<span class="token punctuation">)</span> <span class="token operator">/</span> frameRate<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// timeout延迟执行时间就是目标时间减去当前时间</span></span>
<span class="line">    <span class="token keyword">let</span> timeout<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> targetTime <span class="token operator">-</span> clock<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// timeout小于0，说明tick执行的速度小于fps的规定</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// -timeout就是慢了多少时间，</span></span>
<span class="line">        <span class="token comment">// 利用shift就可以在下一次计算时保证targetTime正确。</span></span>
<span class="line">      shift <span class="token operator">+=</span> <span class="token operator">-</span>timeout<span class="token punctuation">;</span></span>
<span class="line">      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Unable to maintain frameRate (missed by </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token operator">-</span>timeout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms)</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// tick的执行速度慢了，所以这一次要立即执行。</span></span>
<span class="line">      timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 但是上面的if处理逻辑似乎存在问题，</span></span>
<span class="line">    <span class="token comment">// 就是当timeout非常大时，可能已经慢了很多个tick了，</span></span>
<span class="line">    <span class="token comment">// 然而这里只执行了一个tick。这会导致tick丢失，这在某些情况下可能会产生问题（如游戏）</span></span>
<span class="line">    <span class="token comment">// 这里应该这么修改，以代替上面的if逻辑：</span></span>
<span class="line">    <span class="token comment">// while(timeout &lt; 0){ // 保证timeout为正</span></span>
<span class="line">    <span class="token comment">//   onTick(); // 执行tick，另外，如果是游戏的话，这里应该执行update更新数据,不需要执行render渲染</span></span>
<span class="line">    <span class="token comment">//   timeout += 1000 / frameRate;</span></span>
<span class="line">    <span class="token comment">//   nextTickCount++;</span></span>
<span class="line">    <span class="token comment">// }</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 通过时钟创建下一个定时器</span></span>
<span class="line">    handle <span class="token operator">=</span> clock<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> handleTick<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">scheduleNextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      clock<span class="token punctuation">.</span><span class="token function">clearTimeout</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      handle <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span> destroy <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,26),l=[t];function c(o,i){return a(),s("div",null,l)}const k=n(e,[["render",c],["__file","01.时钟与循环.html.vue"]]),r=JSON.parse('{"path":"/%E6%BA%90%E7%A0%81/open-swf%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/01.%E6%97%B6%E9%92%9F%E4%B8%8E%E5%BE%AA%E7%8E%AF.html","title":"open-swf源码阅读笔记-01.时钟与循环","lang":"zh-CN","frontmatter":{"title":"open-swf源码阅读笔记-01.时钟与循环","shortTitle":"01.时钟与循环","date":"2024-07-28T09:18:00.000Z","article":false,"index":true,"description":"时钟与循环 最近在尝试写一个博客插件，洛克王国版的看板娘，想把宠物放到博客网站上。 于是昨天看了open-flash这个库的的实现，感觉这个库虽然stars不多，但是代码质量却非常高，这里简要对其中的一些代码做一些笔记。 这个库分成了多个子库 swf-types swf文件的抽象语法树定义，原先叫swf-tree swf-parser 解析器 swf-...","head":[["meta",{"property":"og:url","content":"https://dingdingdang.online/%E6%BA%90%E7%A0%81/open-swf%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/01.%E6%97%B6%E9%92%9F%E4%B8%8E%E5%BE%AA%E7%8E%AF.html"}],["meta",{"property":"og:site_name","content":"YiguiDing的Blog小站"}],["meta",{"property":"og:title","content":"open-swf源码阅读笔记-01.时钟与循环"}],["meta",{"property":"og:description","content":"时钟与循环 最近在尝试写一个博客插件，洛克王国版的看板娘，想把宠物放到博客网站上。 于是昨天看了open-flash这个库的的实现，感觉这个库虽然stars不多，但是代码质量却非常高，这里简要对其中的一些代码做一些笔记。 这个库分成了多个子库 swf-types swf文件的抽象语法树定义，原先叫swf-tree swf-parser 解析器 swf-..."}],["meta",{"property":"og:type","content":"website"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-07-28T07:35:21.000Z"}],["meta",{"property":"article:author","content":"丁毅桂"}],["meta",{"property":"article:published_time","content":"2024-07-28T09:18:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-07-28T07:35:21.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"WebPage\\",\\"name\\":\\"open-swf源码阅读笔记-01.时钟与循环\\",\\"description\\":\\"时钟与循环 最近在尝试写一个博客插件，洛克王国版的看板娘，想把宠物放到博客网站上。 于是昨天看了open-flash这个库的的实现，感觉这个库虽然stars不多，但是代码质量却非常高，这里简要对其中的一些代码做一些笔记。 这个库分成了多个子库 swf-types swf文件的抽象语法树定义，原先叫swf-tree swf-parser 解析器 swf-...\\"}"],["meta",{"name":"baidu-site-verification","content":"codeva-PwE9Ts6nMl"}]]},"headers":[{"level":2,"title":"使用","slug":"使用","link":"#使用","children":[]},{"level":2,"title":"时钟的接口定义","slug":"时钟的接口定义","link":"#时钟的接口定义","children":[]},{"level":2,"title":"Clock时钟","slug":"clock时钟","link":"#clock时钟","children":[{"level":3,"title":"SystemClock系统时钟","slug":"systemclock系统时钟","link":"#systemclock系统时钟","children":[]},{"level":3,"title":"ChildClock子时钟","slug":"childclock子时钟","link":"#childclock子时钟","children":[]}]},{"level":2,"title":"loop循环","slug":"loop循环","link":"#loop循环","children":[]}],"git":{"createdTime":1722152121000,"updatedTime":1722152121000,"contributors":[{"name":"YiguiDing","email":"2449695354@qq.com","commits":1}]},"readingTime":{"minutes":9.43,"words":2830},"filePathRelative":"源码/open-swf源码阅读笔记/01.时钟与循环.md","localizedDate":"2024年7月28日","excerpt":"","autoDesc":true}');export{k as comp,r as data};
