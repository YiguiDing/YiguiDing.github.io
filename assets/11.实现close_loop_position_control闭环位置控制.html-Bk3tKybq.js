import{_ as l}from"./image-16-DZO6Vied.js";import{_ as p,c,d as i,w as a,a as n,b as u,r,o as k,e as s}from"./app-DjDtDPYL.js";const d={},m=n("h2",{id:"_11-实现close-loop-position-control闭环位置控制",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_11-实现close-loop-position-control闭环位置控制"},[n("span",null,"11.实现close_loop_position_control闭环位置控制")])],-1),v=n("h3",{id:"具体实现",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#具体实现"},[n("span",null,"具体实现")])],-1),b=n("code",null,"BLDCMotor.cpp",-1),_=n("code",null,"BLDCMotor.hpp",-1),y=n("div",{class:"language-cpp line-numbers-mode","data-highlighter":"prismjs","data-ext":"cpp","data-title":"cpp"},[n("pre",null,[n("code",null,[n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"Arduino.h"')])]),s(`
`),n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"BLDCMotor.hpp"')])]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"BLDCMotor"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"uint8_t"),s(" polePairs"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"float"),s(" power_supply_voltage"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("polePairs "),n("span",{class:"token operator"},"="),s(" polePairs"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("power_supply_voltage "),n("span",{class:"token operator"},"="),s(" power_supply_voltage"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"connectDriver"),n("span",{class:"token punctuation"},"("),s("BLDCDriver "),n("span",{class:"token operator"},"*"),s("driver"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("driver "),n("span",{class:"token operator"},"="),s(" driver"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"connectSensor"),n("span",{class:"token punctuation"},"("),s("Sensor "),n("span",{class:"token operator"},"*"),s("sensor"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor "),n("span",{class:"token operator"},"="),s(" sensor"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"connectCurrentSensor"),n("span",{class:"token punctuation"},"("),s("CurrentSensor "),n("span",{class:"token operator"},"*"),s("currentSensor"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("currentSensor "),n("span",{class:"token operator"},"="),s(" currentSensor"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"connectCommand"),n("span",{class:"token punctuation"},"("),s("Command "),n("span",{class:"token operator"},"*"),s("command"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("command "),n("span",{class:"token operator"},"="),s(" command"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"initFOC"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("currentSensor"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("currentSensor"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"initSensor"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("currentSensor"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"alignSensor"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("driver"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("driver"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"initDriver"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("driver"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"enableDriver"),n("span",{class:"token punctuation"},"("),n("span",{class:"token boolean"},"true"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("driver"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"setPhraseVoltage"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"initSensor"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"connectMotor"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"this"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"alignSensor"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"update"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"loopFOC"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"update"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"int8_t"),s(" sign "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("direction "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token operator"},"->"),s("directron"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("controlMode"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"case"),s(" ControlMode"),n("span",{class:"token double-colon punctuation"},"::"),s("Voltage"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"open_loop_voltage_control"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" sign "),n("span",{class:"token operator"},"*"),s(" target"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"case"),s(" ControlMode"),n("span",{class:"token double-colon punctuation"},"::"),s("Current"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"close_loop_current_control"),n("span",{class:"token punctuation"},"("),s("sign "),n("span",{class:"token operator"},"*"),s(" target"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"case"),s(" ControlMode"),n("span",{class:"token double-colon punctuation"},"::"),s("VelocityCurrent"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"close_loop_velocity_current_control"),n("span",{class:"token punctuation"},"("),s("sign "),n("span",{class:"token operator"},"*"),s(" target"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"case"),s(" ControlMode"),n("span",{class:"token double-colon punctuation"},"::"),s("PositionCurrent"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"close_loop_position_current_control"),n("span",{class:"token punctuation"},"("),s("target"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"case"),s(" ControlMode"),n("span",{class:"token double-colon punctuation"},"::"),s("PositionVelocityCurrent"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"close_loop_position_velocity_current_control"),n("span",{class:"token punctuation"},"("),s("target"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"}," * 设置控制模式"),s(`
`),n("span",{class:"line"}," */")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"setMode"),n("span",{class:"token punctuation"},"("),s("ControlMode controlMode"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("controlMode"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"case"),s(" ControlMode"),n("span",{class:"token double-colon punctuation"},"::"),s("Unknow"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"case"),s(" ControlMode"),n("span",{class:"token double-colon punctuation"},"::"),s("Voltage"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"case"),s(" ControlMode"),n("span",{class:"token double-colon punctuation"},"::"),s("Current"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// 官方 Simple FOC Shield v2.0.4 开发板 with 2808云台电机")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// this->pid_id_controller = PIDControler(2.8, 200, -0.005, this->limit_voltage, 0);")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// this->pid_iq_controller = PIDControler(2.8, 200, -0.005, this->limit_voltage, 0);")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// 艾尔塞电子 Simple FOC Shield v2.0.4 开发板 with 2808云台电机")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// this->pid_id_controller = PIDControler(2, 1000, 0, this->limit_voltage, 0);")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// this->pid_iq_controller = PIDControler(2, 1000, 0, this->limit_voltage, 0);")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// 官方 Simple FOC Shield v2.0.4 开发板 with 2804-100kv 云台电机")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_voltage "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"12.0"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// 电机额定电压")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("pid_id_controller "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"PIDControler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"500"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_voltage"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"400"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("pid_iq_controller "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"PIDControler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"500"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_voltage"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"400"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// 完美")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"case"),s(" ControlMode"),n("span",{class:"token double-colon punctuation"},"::"),s("VelocityCurrent"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// 官方 Simple FOC Shield v2.0.4 开发板 with 2808云台电机")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// this->pid_id_controller = PIDControler(2.8, 0.01, 0, this->limit_voltage, 0);")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// this->pid_iq_controller = PIDControler(2.8, 0.01, 0, this->limit_voltage, 0);")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// this->pid_velocity_controller = PIDControler(0.5, 2.5, 0, this->limit_current, 0); //  kp<1; ki<=10;")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// 艾尔塞电子 Simple FOC Shield v2.0.4 开发板 with 2808云台电机")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// this->pid_id_controller = PIDControler(2, 1000, 0, this->limit_voltage, 0);")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// this->pid_iq_controller = PIDControler(2, 1000, 0, this->limit_voltage, 0);")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// this->pid_velocity_controller = PIDControler(0, 0, 0, this->limit_current, 0);")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// 官方 Simple FOC Shield v2.0.4 开发板 with 2804-100kv 云台电机")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_voltage "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"12.0"),n("span",{class:"token punctuation"},";"),s("                                                   "),n("span",{class:"token comment"},"// 电机额定电压")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("pid_id_controller "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"PIDControler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"500"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_voltage"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"400"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// kp可以设置到30 但取其 2/3 为 20，余量留给ki发挥 roc设置为400是为了")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("pid_iq_controller "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"PIDControler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"500"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_voltage"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"400"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_current "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s("                                                                   "),n("span",{class:"token comment"},"// 额定电流")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("pid_velocity_controller "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"PIDControler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0.01"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0.05"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0.0001"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_current"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// 非常完美 但当电压为12v时最好设置电流限制为1")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"case"),s(" ControlMode"),n("span",{class:"token double-colon punctuation"},"::"),s("PositionCurrent"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// 官方 Simple FOC Shield v2.0.4 开发板 with 2804-100kv 云台电机")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_voltage "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"12.0"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// 电机额定电压")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("pid_id_controller "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"PIDControler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"500"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_voltage"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"400"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("pid_iq_controller "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"PIDControler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"500"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_voltage"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"400"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_current "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// 额定电流")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("pid_position_controller "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"PIDControler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0.05"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0.005"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_current"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"case"),s(" ControlMode"),n("span",{class:"token double-colon punctuation"},"::"),s("PositionVelocityCurrent"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// 官方 Simple FOC Shield v2.0.4 开发板 with 2804-100kv 云台电机")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_voltage "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"12.0"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// 电机额定电压")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("pid_id_controller "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"PIDControler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"500"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_voltage"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"400"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("pid_iq_controller "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"PIDControler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"500"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_voltage"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"400"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_current "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// 额定电流")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("pid_velocity_controller "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"PIDControler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0.01"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0.05"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0.0001"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_current"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_velocity "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"120"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// 编码器最大速度")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("pid_position_controller "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"PIDControler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0.1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("limit_velocity"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1000"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s()]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("controlMode "),n("span",{class:"token operator"},"="),s(" controlMode"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"setTarget"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"float"),s(" target"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("target "),n("span",{class:"token operator"},"="),s(" target"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"}," * @details"),s(`
`),n("span",{class:"line"}," *  电角度=机械角度*极对数"),s(`
`),n("span",{class:"line"}," *  @return [0,2PI] => [0,UINT16_MAX]"),s(`
`),n("span",{class:"line"}," */")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"uint16_t"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"electricalAngle"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"getPositon"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(" polePairs"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"}," * 设置相电压"),s(`
`),n("span",{class:"line"}," * @param u_d int16_t [-32768,32767] 表示 [-1,1] 精度：1/32768 = 0.0000605"),s(`
`),n("span",{class:"line"}," * @param u_q int16_t [-32768,32767] 表示 [-1,1]"),s(`
`),n("span",{class:"line"}," * @param e_angle uint16_t [0,65535] 表示 [0,2PI] 精度：360°/65535 = 0.00549°"),s(`
`),n("span",{class:"line"}," */")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"setPhraseVoltage"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int16_t"),s(" u_d"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int16_t"),s(" u_q"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"uint16_t"),s(" e_angle"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"int16_t"),s(" sin"),n("span",{class:"token punctuation"},","),s(" cos"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token comment"},"// 计算三角函数")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token function"},"_sincos"),n("span",{class:"token punctuation"},"("),s("e_angle"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sin"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("cos"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token comment"},"// 帕克逆变换")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"int16_t"),s(" u_alpha "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("cos "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int32_t"),n("span",{class:"token punctuation"},")"),s("u_d"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token punctuation"},"("),s("sin "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int32_t"),n("span",{class:"token punctuation"},")"),s("u_q"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"/"),s(" INT16_MAX"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"int16_t"),s(" u_beta "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("sin "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int32_t"),n("span",{class:"token punctuation"},")"),s("u_d"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token punctuation"},"("),s("cos "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int32_t"),n("span",{class:"token punctuation"},")"),s("u_q"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"/"),s(" INT16_MAX"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token comment"},"// 克拉克逆变换(等幅值形式)")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"int16_t"),s(" u_a "),n("span",{class:"token operator"},"="),s(" u_alpha"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"int16_t"),s(" u_b "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"*"),s(" u_alpha "),n("span",{class:"token operator"},"+"),s(" _INT16_SQRT3_ "),n("span",{class:"token operator"},"*"),s(" u_beta "),n("span",{class:"token operator"},"/"),s(" INT16_MAX"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"/"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"int16_t"),s(" u_c "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token punctuation"},"("),s("u_a "),n("span",{class:"token operator"},"+"),s(" u_b"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token comment"},"// 设置相电压")]),s(`
`),n("span",{class:"line"},[s("  driver"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"setPhraseVoltage"),n("span",{class:"token punctuation"},"("),s("u_a"),n("span",{class:"token punctuation"},","),s(" u_b"),n("span",{class:"token punctuation"},","),s(" u_c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"open_loop_voltage_control"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"float"),s(" target_ud"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"float"),s(" target_uq"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"uint16_t"),s(" e_angle "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"electricalAngle"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" voltage_ud "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"_constrain"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"-"),s("limit_voltage"),n("span",{class:"token punctuation"},","),s(" target_ud"),n("span",{class:"token punctuation"},","),s(" limit_voltage"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" voltage_uq "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"_constrain"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"-"),s("limit_voltage"),n("span",{class:"token punctuation"},","),s(" target_uq"),n("span",{class:"token punctuation"},","),s(" limit_voltage"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"int16_t"),s(" u_d "),n("span",{class:"token operator"},"="),s(" voltage_ud "),n("span",{class:"token operator"},"/"),s(" power_supply_voltage "),n("span",{class:"token operator"},"*"),s(" INT16_MAX"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"int16_t"),s(" u_q "),n("span",{class:"token operator"},"="),s(" voltage_uq "),n("span",{class:"token operator"},"/"),s(" power_supply_voltage "),n("span",{class:"token operator"},"*"),s(" INT16_MAX"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"setPhraseVoltage"),n("span",{class:"token punctuation"},"("),s("u_d"),n("span",{class:"token punctuation"},","),s(" u_q"),n("span",{class:"token punctuation"},","),s(" e_angle"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"}," * 获取Q轴电流"),s(`
`),n("span",{class:"line"}," */")]),s(`
`),n("span",{class:"line"},[s("CurrentDQ "),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"getCurrentDQ"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  CurrentDQ i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("currentSensor"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"getCurrentDQ"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"electricalAngle"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("      "),n("span",{class:"token punctuation"},"."),s("d "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"current_d_filter"),n("span",{class:"token punctuation"},"("),s("i"),n("span",{class:"token punctuation"},"."),s("d"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("      "),n("span",{class:"token punctuation"},"."),s("q "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"current_q_filter"),n("span",{class:"token punctuation"},"("),s("i"),n("span",{class:"token punctuation"},"."),s("q"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"foc_utils.h"')])]),s(`
`),n("span",{class:"line"},[n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"}," * 电流闭环控制"),s(`
`),n("span",{class:"line"}," */")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"close_loop_current_control"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"float"),s(" target"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" target_i_d "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" target_i_q "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"_constrain"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"-"),s("limit_current"),n("span",{class:"token punctuation"},","),s(" target"),n("span",{class:"token punctuation"},","),s(" limit_current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  CurrentDQ current "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"getCurrentDQ"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" error_d "),n("span",{class:"token operator"},"="),s(" target_i_d "),n("span",{class:"token operator"},"-"),s(" current"),n("span",{class:"token punctuation"},"."),s("d"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" error_q "),n("span",{class:"token operator"},"="),s(" target_i_q "),n("span",{class:"token operator"},"-"),s(" current"),n("span",{class:"token punctuation"},"."),s("q"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" u_d "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"pid_id_controller"),n("span",{class:"token punctuation"},"("),s("error_d"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" u_q "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"pid_iq_controller"),n("span",{class:"token punctuation"},"("),s("error_q"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"open_loop_voltage_control"),n("span",{class:"token punctuation"},"("),s("u_d"),n("span",{class:"token punctuation"},","),s(" u_q"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"uint8_t"),s(" idx "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("command "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token operator"},"++"),s("idx "),n("span",{class:"token operator"},"%"),s(),n("span",{class:"token number"},"61"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("    idx "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("command"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"drawDragram"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" target_i_q"),n("span",{class:"token punctuation"},","),s(" current"),n("span",{class:"token punctuation"},"."),s("q"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"}," * 获取机械角度"),s(`
`),n("span",{class:"line"}," */")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"float"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"shaftVelocity"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"shaft_velocity_filter"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"getVelocity"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"close_loop_velocity_current_control"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"float"),s(" target"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" target_velocity "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"_constrain"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"-"),s("limit_velocity"),n("span",{class:"token punctuation"},","),s(" target"),n("span",{class:"token punctuation"},","),s(" limit_velocity"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" current_velocity "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"shaftVelocity"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" error "),n("span",{class:"token operator"},"="),s(" target_velocity "),n("span",{class:"token operator"},"-"),s(" current_velocity"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" i_q "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"pid_velocity_controller"),n("span",{class:"token punctuation"},"("),s("error"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"close_loop_current_control"),n("span",{class:"token punctuation"},"("),s("i_q"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"uint8_t"),s(" idx "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("command "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token operator"},"++"),s("idx "),n("span",{class:"token operator"},"%"),s(),n("span",{class:"token number"},"62"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("    idx "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("command"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"drawDragram"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},","),s(" target_velocity"),n("span",{class:"token punctuation"},","),s(" current_velocity"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"}," * 获取机械角度"),s(`
`),n("span",{class:"line"}," */")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"float"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"shaftAngle"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"shaft_angle_filter"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"getPositons"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"close_loop_position_current_control"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"float"),s(" target"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" target_position "),n("span",{class:"token operator"},"="),s(" target"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" current_position "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"shaftAngle"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" error "),n("span",{class:"token operator"},"="),s(" target_position "),n("span",{class:"token operator"},"-"),s(" current_position"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" i_q "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"pid_position_controller"),n("span",{class:"token punctuation"},"("),s("error"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"int8_t"),s(" sign "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("direction "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token operator"},"->"),s("directron"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token function"},"close_loop_current_control"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"-"),s("sign "),n("span",{class:"token operator"},"*"),s(" i_q"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"uint8_t"),s(" idx "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("command "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token operator"},"++"),s("idx "),n("span",{class:"token operator"},"%"),s(),n("span",{class:"token number"},"63"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("    idx "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("command"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"drawDragram"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},","),s(" target_position"),n("span",{class:"token punctuation"},","),s(" current_position"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token class-name"},"BLDCMotor"),n("span",{class:"token double-colon punctuation"},"::"),n("span",{class:"token function"},"close_loop_position_velocity_current_control"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"float"),s(" target"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" target_position "),n("span",{class:"token operator"},"="),s(" target"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" current_position "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"shaftAngle"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" error "),n("span",{class:"token operator"},"="),s(" target_position "),n("span",{class:"token operator"},"-"),s(" current_position"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"float"),s(" velocity "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"pid_position_controller"),n("span",{class:"token punctuation"},"("),s("error"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// this->direction * this->sensor->directron *")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"int8_t"),s(" sign "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("direction "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("sensor"),n("span",{class:"token operator"},"->"),s("directron"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token function"},"close_loop_velocity_current_control"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"-"),s("sign "),n("span",{class:"token operator"},"*"),s(" velocity"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"uint8_t"),s(" idx "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("command "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token operator"},"++"),s("idx "),n("span",{class:"token operator"},"%"),s(),n("span",{class:"token number"},"63"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("    idx "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"this"),n("span",{class:"token operator"},"->"),s("command"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"drawDragram"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},","),s(" target_position"),n("span",{class:"token punctuation"},","),s(" current_position"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("  "),n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}")]),s(`
`),n("span",{class:"line"})])]),n("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),w=n("div",{class:"language-cpp line-numbers-mode","data-highlighter":"prismjs","data-ext":"cpp","data-title":"cpp"},[n("pre",null,[n("code",null,[n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"ifndef"),s(),n("span",{class:"token expression"},"__BLDCMotor_H__")])]),s(`
`),n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"__BLDCMotor_H__")])]),s(`
`),n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdint.h>")])]),s(`
`),n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"foc_utils.h"')])]),s(`
`),n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"BLDCDriver.hpp"')])]),s(`
`),n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"LowPassFilter.hpp"')])]),s(`
`),n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"CurrentSensor.hpp"')])]),s(`
`),n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"Sensor.hpp"')])]),s(`
`),n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"Timer.hpp"')])]),s(`
`),n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"pid.hpp"')])]),s(`
`),n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"Command.hpp"')])]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"class"),s(),n("span",{class:"token class-name"},"BLDCMotor"),s(),n("span",{class:"token operator"},":"),s(),n("span",{class:"token base-clause"},[n("span",{class:"token class-name"},"Timer")])]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"public"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"enum"),s(),n("span",{class:"token class-name"},"ControlMode"),s(),n("span",{class:"token operator"},":"),s(),n("span",{class:"token keyword"},"uint8_t")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("        Unknow "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("        Voltage "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("        Current "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("        VelocityCurrent "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("        PositionCurrent "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("        PositionVelocityCurrent "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"enum"),s(),n("span",{class:"token class-name"},"MotorDirectrion"),s(),n("span",{class:"token operator"},":"),s(),n("span",{class:"token keyword"},"int8_t")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token punctuation"},"{")]),s(`
`),n("span",{class:"line"},[s("        UNKNOW "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("        ANTI_CLOCK_WISE "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("        CLOCK_WISE "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},",")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// 极对数")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"uint8_t"),s(" polePairs"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// 供电电压")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"float"),s(" power_supply_voltage "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"12.0f"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// 限制电压")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"float"),s(" limit_voltage "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"12.0f"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// 限制电流")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"float"),s(" limit_current "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"10.0f"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// 限制速度")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"float"),s(" limit_velocity "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"130.0f"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// directron")]),s(`
`),n("span",{class:"line"},[s("    MotorDirectrion direction "),n("span",{class:"token operator"},"="),s(" MotorDirectrion"),n("span",{class:"token double-colon punctuation"},"::"),s("ANTI_CLOCK_WISE"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// taget")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"float"),s(" target "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// mode")]),s(`
`),n("span",{class:"line"},[s("    ControlMode controlMode "),n("span",{class:"token operator"},"="),s(" ControlMode"),n("span",{class:"token double-colon punctuation"},"::"),s("VelocityCurrent"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// filter")]),s(`
`),n("span",{class:"line"},[s("    LowPassFilter current_q_filter"),n("span",{class:"token punctuation"},"{"),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    LowPassFilter current_d_filter"),n("span",{class:"token punctuation"},"{"),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    LowPassFilter shaft_velocity_filter"),n("span",{class:"token punctuation"},"{"),n("span",{class:"token number"},"50"),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    LowPassFilter shaft_angle_filter"),n("span",{class:"token punctuation"},"{"),n("span",{class:"token number"},"100"),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"// pid-controller")]),s(`
`),n("span",{class:"line"},[s("    PIDControler pid_iq_controller"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    PIDControler pid_id_controller"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    PIDControler pid_velocity_controller"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    PIDControler pid_position_controller"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"private"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"//")]),s(`
`),n("span",{class:"line"},[s("    BLDCDriver "),n("span",{class:"token operator"},"*"),s("driver "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"nullptr"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    Sensor "),n("span",{class:"token operator"},"*"),s("sensor "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"nullptr"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    CurrentSensor "),n("span",{class:"token operator"},"*"),s("currentSensor "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"nullptr"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    Command "),n("span",{class:"token operator"},"*"),s("command "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"nullptr"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"}),s(`
`),n("span",{class:"line"},[n("span",{class:"token keyword"},"public"),n("span",{class:"token operator"},":")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token function"},"BLDCMotor"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"uint8_t"),s(" polePairs"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"float"),s(" power_supply_voltage"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"connectDriver"),n("span",{class:"token punctuation"},"("),s("BLDCDriver "),n("span",{class:"token operator"},"*"),s("driver"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"connectSensor"),n("span",{class:"token punctuation"},"("),s("Sensor "),n("span",{class:"token operator"},"*"),s("sensor"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"connectCurrentSensor"),n("span",{class:"token punctuation"},"("),s("CurrentSensor "),n("span",{class:"token operator"},"*"),s("currentSensor"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"connectCommand"),n("span",{class:"token punctuation"},"("),s("Command "),n("span",{class:"token operator"},"*"),s("command"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"initFOC"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"loopFOC"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"},"     * 设置控制模式"),s(`
`),n("span",{class:"line"},"     */")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"setMode"),n("span",{class:"token punctuation"},"("),s("ControlMode mode"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"setTarget"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"float"),s(" target"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"},"     * 获取电角度"),s(`
`),n("span",{class:"line"},"     */")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"uint16_t"),s(),n("span",{class:"token function"},"electricalAngle"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"},"     * 设置相电压"),s(`
`),n("span",{class:"line"},"     * @param u_d int16_t [-32768,32767] 表示 [-1,1] 精度：1/32768 = 0.0000305"),s(`
`),n("span",{class:"line"},"     * @param u_q int16_t [-32768,32767] 表示 [-1,1]"),s(`
`),n("span",{class:"line"},"     * @param e_angle uint16_t [0,65535] 表示 [0,2PI] 精度：360°/65535 = 0.00549°"),s(`
`),n("span",{class:"line"},"     */")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"setPhraseVoltage"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int16_t"),s(" u_d"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int16_t"),s(" u_q"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"uint16_t"),s(" e_angle"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"},"     * 开环电压控制"),s(`
`),n("span",{class:"line"},"     */")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"open_loop_voltage_control"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"float"),s(" target_ud"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"float"),s(" target_uq"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"},"     * 获取dq轴电流"),s(`
`),n("span",{class:"line"},"     */")]),s(`
`),n("span",{class:"line"},[s("    CurrentDQ "),n("span",{class:"token function"},"getCurrentDQ"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"},"     * 闭环电流控制"),s(`
`),n("span",{class:"line"},"     */")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"close_loop_current_control"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"float"),s(" target"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"},"     * 获取机械角度"),s(`
`),n("span",{class:"line"},"     */")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"float"),s(),n("span",{class:"token function"},"shaftVelocity"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"},"     * 闭环速度控制"),s(`
`),n("span",{class:"line"},"     */")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"close_loop_velocity_current_control"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"float"),s(" target"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"},"     * 获取机械角度"),s(`
`),n("span",{class:"line"},"     */")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"float"),s(),n("span",{class:"token function"},"shaftAngle"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token comment"},"/**"),s(`
`),n("span",{class:"line"},"     * 闭环位置控制"),s(`
`),n("span",{class:"line"},"     */")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"close_loop_position_current_control"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"float"),s(" target"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[s("    "),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"close_loop_position_velocity_current_control"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"float"),s(" target"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";")]),s(`
`),n("span",{class:"line"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"endif")])]),s(`
`),n("span",{class:"line"})])]),n("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),h=u('<h3 id="实现效果" tabindex="-1"><a class="header-anchor" href="#实现效果"><span>实现效果</span></a></h3><p><strong>位置闭环控制效果</strong></p><p><img src="'+l+`" alt="alt text"></p><p><strong>代码</strong></p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Arduino.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Wire.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;BLDCMotor.hpp&quot;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;BLDCDriver.hpp&quot;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;Sensor.hpp&quot;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;foc_utils.h&quot;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;typedef.h&quot;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;pwm.h&quot;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;Command.hpp&quot;</span></span></span>
<span class="line"></span>
<span class="line">BLDCMotor motor <span class="token operator">=</span> <span class="token function">BLDCMotor</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M1_En</span> <span class="token expression"><span class="token number">8</span></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M1_Ua</span> <span class="token expression"><span class="token number">5</span></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M1_Ub</span> <span class="token expression"><span class="token number">9</span></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M1_Uc</span> <span class="token expression"><span class="token number">6</span></span></span></span>
<span class="line"></span>
<span class="line">PwmOut <span class="token function">pwmA</span><span class="token punctuation">(</span>D5<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">PwmOut <span class="token function">pwmB</span><span class="token punctuation">(</span>D9<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">PwmOut <span class="token function">pwmC</span><span class="token punctuation">(</span>D6<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">BLDCDriver driver <span class="token operator">=</span> <span class="token function">BLDCDriver</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment">// init driver</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">pinMode</span><span class="token punctuation">(</span>M1_En<span class="token punctuation">,</span> OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// enable</span></span>
<span class="line"></span>
<span class="line">      <span class="token comment">// pinMode(M1_Ua, OUTPUT); // a</span></span>
<span class="line">      <span class="token comment">// pinMode(M1_Ub, OUTPUT); // b</span></span>
<span class="line">      <span class="token comment">// pinMode(M1_Uc, OUTPUT); // c</span></span>
<span class="line"></span>
<span class="line">      <span class="token comment">// 20k</span></span>
<span class="line">      <span class="token comment">// period 50us = 20,000hz; pulse 0 us = 0%</span></span>
<span class="line">      <span class="token comment">// pwmA.begin(20000.0f, 0.0f);</span></span>
<span class="line">      <span class="token comment">// pwmB.begin(20000.0f, 0.0f);</span></span>
<span class="line">      <span class="token comment">// pwmC.begin(20000.0f, 0.0f);</span></span>
<span class="line"></span>
<span class="line">      <span class="token comment">// 10k</span></span>
<span class="line">      pwmA<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">10000.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      pwmB<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">10000.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      pwmC<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">10000.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// enable or disable driver</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">bool</span> enable<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">digitalWrite</span><span class="token punctuation">(</span>M1_En<span class="token punctuation">,</span> enable <span class="token operator">?</span> HIGH <span class="token operator">:</span> LOW<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// enable</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// set pwm to driver</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int16_t</span> u_a<span class="token punctuation">,</span> <span class="token keyword">int16_t</span> u_b<span class="token punctuation">,</span> <span class="token keyword">int16_t</span> u_c<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 设置占空比</span></span>
<span class="line">      <span class="token comment">// [-32768,32768] =&gt; [-1,1] =&gt; [-50,50] =&gt; [0,100]</span></span>
<span class="line">      pwmA<span class="token punctuation">.</span><span class="token function">pulse_perc</span><span class="token punctuation">(</span>u_a <span class="token operator">/</span> <span class="token number">32768.0f</span> <span class="token operator">*</span> <span class="token number">50</span> <span class="token operator">+</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置百分比</span></span>
<span class="line">      pwmB<span class="token punctuation">.</span><span class="token function">pulse_perc</span><span class="token punctuation">(</span>u_b <span class="token operator">/</span> <span class="token number">32768.0f</span> <span class="token operator">*</span> <span class="token number">50</span> <span class="token operator">+</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      pwmC<span class="token punctuation">.</span><span class="token function">pulse_perc</span><span class="token punctuation">(</span>u_c <span class="token operator">/</span> <span class="token number">32768.0f</span> <span class="token operator">*</span> <span class="token number">50</span> <span class="token operator">+</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AS5600_ADDR</span> <span class="token expression"><span class="token number">0x36</span></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AS5600_RAW_ANGLE</span> <span class="token expression"><span class="token number">0x0c</span></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AS5600_ANGLE</span> <span class="token expression"><span class="token number">0x0e</span></span></span></span>
<span class="line">Sensor sensor <span class="token operator">=</span> <span class="token function">Sensor</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// AS5600 最高支持1Mhz 1000000</span></span>
<span class="line">      Wire<span class="token punctuation">.</span><span class="token function">setClock</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  100000 (standard mode)  400000 (fast mode) 1000000 (fast mode plus)</span></span>
<span class="line">      Wire<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      Wire<span class="token punctuation">.</span><span class="token function">beginTransmission</span><span class="token punctuation">(</span>AS5600_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      Wire<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>AS5600_ANGLE<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">uint8_t</span> err <span class="token operator">=</span> Wire<span class="token punctuation">.</span><span class="token function">endTransmission</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>err<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Wire.endTransmission(true);</span></span>
<span class="line">        <span class="token comment">// Serial.print(&quot;errorcode:&quot;);</span></span>
<span class="line">        <span class="token comment">// Serial.println(err);</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      Wire<span class="token punctuation">.</span><span class="token function">requestFrom</span><span class="token punctuation">(</span>AS5600_ADDR<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">uint16_t</span> data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> Wire<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>data <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> Wire<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      err <span class="token operator">=</span> Wire<span class="token punctuation">.</span><span class="token function">endTransmission</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>err<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Serial.print(&quot;errorcode:&quot;);</span></span>
<span class="line">        <span class="token comment">// Serial.println(err);</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">uint16_t</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这行代码解决了磁编码器有时无法读取的问题,开始怀疑时排针接触不良,然后尝试焊接排针问题依然存在,然后怀疑是SDA\\SCL上拉电阻太多导致,拆掉问题依旧存在,然后怀疑是电机导致的电压波动,然后给AS5600供电加了个1uf和0.1uf电容,问题依旧,最后google搜索后发现别人的代码中有delay遂加上,问题解决.</span></span>
<span class="line">      <span class="token comment">// as5600 12bit精度，左移4位变成16位</span></span>
<span class="line">      data <span class="token operator">&lt;&lt;=</span> <span class="token number">4</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// Serial.println(data);</span></span>
<span class="line">      <span class="token keyword">return</span> data<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;CurrentSensor.hpp&quot;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M1_Ia</span> <span class="token expression">A0</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M1_Ib</span> <span class="token expression">A2</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M1_Ic</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I_R</span> <span class="token expression"><span class="token number">0.01f</span> </span><span class="token comment">// 10mΩ</span></span></span>
<span class="line"></span>
<span class="line">CurrentSensor currentSensor <span class="token operator">=</span> <span class="token function">CurrentSensor</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">pinMode</span><span class="token punctuation">(</span>M1_Ia<span class="token punctuation">,</span> INPUT<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token function">pinMode</span><span class="token punctuation">(</span>M1_Ib<span class="token punctuation">,</span> INPUT<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// Arduino 板上的标准分辨率为 10 位 (0-1023)</span></span>
<span class="line">      <span class="token function">analogReadResolution</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// UNO R4 支持高达 14 位(0-16383)的分辨率</span></span>
<span class="line">      <span class="token function">analogReference</span><span class="token punctuation">(</span>AR_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认参考电压 5 V</span></span>
<span class="line">      <span class="token comment">// analogReference(AR_INTERNAL); // 内置参考电压 1.5 V</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// [0,16383] =&gt; [0,5]</span></span>
<span class="line">      <span class="token keyword">return</span> CurrentABC<span class="token punctuation">{</span></span>
<span class="line">          <span class="token comment">// i = u/r</span></span>
<span class="line">          <span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">analogRead</span><span class="token punctuation">(</span>M1_Ia<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">16383.0f</span> <span class="token operator">*</span> <span class="token number">5.0f</span> <span class="token operator">-</span> <span class="token number">2.5f</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0.01f</span> <span class="token operator">/</span> <span class="token number">50</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token function">analogRead</span><span class="token punctuation">(</span>M1_Ib<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">16383.0f</span> <span class="token operator">*</span> <span class="token number">5.0f</span> <span class="token operator">-</span> <span class="token number">2.5f</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0.01f</span> <span class="token operator">/</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token comment">// b电路接反了 加符号</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">Command command<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  motor<span class="token punctuation">.</span><span class="token function">connectDriver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>driver<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  motor<span class="token punctuation">.</span><span class="token function">connectSensor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sensor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  motor<span class="token punctuation">.</span><span class="token function">connectCurrentSensor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>currentSensor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  command<span class="token punctuation">.</span><span class="token function">connectMotor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>motor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  command<span class="token punctuation">.</span><span class="token function">connectSerial</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Serial<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  motor<span class="token punctuation">.</span><span class="token function">connectCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  motor<span class="token punctuation">.</span><span class="token function">initFOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  motor<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span>BLDCMotor<span class="token double-colon punctuation">::</span>ControlMode<span class="token double-colon punctuation">::</span>Current<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  motor<span class="token punctuation">.</span><span class="token function">loopFOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  command<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// Serial.println(sensor.getPositon());</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,5);function f(g,C){const o=r("CodeTabs");return k(),c("div",null,[m,v,i(o,{id:"6",data:[{id:"<code v-pre>BLDCMotor.cpp</code>"},{id:"<code v-pre>BLDCMotor.hpp</code>"}]},{title0:a(({value:e,isActive:t})=>[b]),title1:a(({value:e,isActive:t})=>[_]),tab0:a(({value:e,isActive:t})=>[y]),tab1:a(({value:e,isActive:t})=>[w]),_:1}),h])}const S=p(d,[["render",f],["__file","11.实现close_loop_position_control闭环位置控制.html.vue"]]),B=JSON.parse('{"path":"/%E7%94%B5%E5%AD%90/FOC%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/11.%E5%AE%9E%E7%8E%B0close_loop_position_control%E9%97%AD%E7%8E%AF%E4%BD%8D%E7%BD%AE%E6%8E%A7%E5%88%B6.html","title":"11.实现close_loop_position_control闭环位置控制","lang":"zh-CN","frontmatter":{"title":"11.实现close_loop_position_control闭环位置控制","date":"2024-11-04T20:44:00.000Z","index":true,"article":false,"order":11,"description":"11.实现close_loop_position_control闭环位置控制 具体实现 实现效果 位置闭环控制效果 alt text 代码","head":[["meta",{"property":"og:url","content":"https://dingdingdang.online/%E7%94%B5%E5%AD%90/FOC%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/11.%E5%AE%9E%E7%8E%B0close_loop_position_control%E9%97%AD%E7%8E%AF%E4%BD%8D%E7%BD%AE%E6%8E%A7%E5%88%B6.html"}],["meta",{"property":"og:site_name","content":"YiguiDing的Blog小站"}],["meta",{"property":"og:title","content":"11.实现close_loop_position_control闭环位置控制"}],["meta",{"property":"og:description","content":"11.实现close_loop_position_control闭环位置控制 具体实现 实现效果 位置闭环控制效果 alt text 代码"}],["meta",{"property":"og:type","content":"website"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-12-02T13:46:49.000Z"}],["meta",{"property":"article:author","content":"丁毅桂"}],["meta",{"property":"article:published_time","content":"2024-11-04T20:44:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-12-02T13:46:49.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"WebPage\\",\\"name\\":\\"11.实现close_loop_position_control闭环位置控制\\",\\"description\\":\\"11.实现close_loop_position_control闭环位置控制 具体实现 实现效果 位置闭环控制效果 alt text 代码\\"}"],["meta",{"name":"baidu-site-verification","content":"codeva-PwE9Ts6nMl"}]]},"headers":[{"level":2,"title":"11.实现close_loop_position_control闭环位置控制","slug":"_11-实现close-loop-position-control闭环位置控制","link":"#_11-实现close-loop-position-control闭环位置控制","children":[{"level":3,"title":"具体实现","slug":"具体实现","link":"#具体实现","children":[]},{"level":3,"title":"实现效果","slug":"实现效果","link":"#实现效果","children":[]}]}],"git":{"createdTime":1730891509000,"updatedTime":1733147209000,"contributors":[{"name":"YiguiDing","email":"2449695354@qq.com","commits":2}]},"readingTime":{"minutes":0.24,"words":73},"filePathRelative":"电子/FOC算法实现过程记录/11.实现close_loop_position_control闭环位置控制.md","localizedDate":"2024年11月4日","excerpt":"","autoDesc":true}');export{S as comp,B as data};
